if(typeof BX.CrmInterfaceGridManager=="undefined"){BX.CrmInterfaceGridManager=function(){this._id="";this._settings={};this._toolbarMenu=null;this._applyButtonClickHandler=BX.delegate(this._handleFormApplyButtonClick,this);this._setFilterFieldsHandler=BX.delegate(this._onSetFilterFields,this);this._getFilterFieldsHandler=BX.delegate(this._onGetFilterFields,this)};BX.CrmInterfaceGridManager.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._makeBindings();BX.ready(BX.delegate(this._bindOnGridReload,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuShow",BX.delegate(this._onToolbarMenuShow,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuClose",BX.delegate(this._onToolbarMenuClose,this));BX.addCustomEvent(window,"BXInterfaceGridCheckColumn",BX.delegate(this._onGridColumnCheck,this))},_onGridColumnCheck:function(e,t){if(this._toolbarMenu){t["columnMenu"]=this._toolbarMenu.GetMenuByItemId(t["targetElement"].id)}},_onToolbarMenuShow:function(e,t){this._toolbarMenu=t["menu"];t["items"]=this.getGridJsObject().settingsMenu},_onToolbarMenuClose:function(e,t){if(t["menu"]===this._toolbarMenu){this._toolbarMenu=null;this.getGridJsObject().SaveColumns()}},getId:function(){return this._id},reinitialize:function(){this._makeBindings()},_makeBindings:function(){var e=this.getForm();if(e){BX.unbind(e["apply"],"click",this._applyButtonClickHandler);BX.bind(e["apply"],"click",this._applyButtonClickHandler)}BX.ready(BX.delegate(this._bindOnSetFilterFields,this))},_bindOnGridReload:function(){BX.addCustomEvent(window,"BXInterfaceGridAfterReload",BX.delegate(this._makeBindings,this))},_bindOnSetFilterFields:function(){var e=this.getGridJsObject();BX.removeCustomEvent(e,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.addCustomEvent(e,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.removeCustomEvent(e,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler);BX.addCustomEvent(e,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler)},registerFilter:function(e){BX.addCustomEvent(e,"AFTER_SET_FILTER_FIELDS",BX.delegate(this._onSetFilterFields,this));BX.addCustomEvent(e,"AFTER_GET_FILTER_FIELDS",BX.delegate(this._onGetFilterFields,this))},_onSetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=t.name.indexOf("flt_settings")===0;var a=n.length;var s=null;var d="";for(var o=0;o<a;o++){var l=n[o];var u=BX.type.isNotEmptyString(l["id"])?l["id"]:"";var f=BX.type.isNotEmptyString(l["typeName"])?l["typeName"].toUpperCase():"";var m=l["params"]?l["params"]:{};if(f==="USER"){var c=m["data"]?m["data"]:{};this._setElementByFilter(c[r?"settingsElementId":"elementId"],c["paramName"],i);var h=m["search"]?m["search"]:{};this._setElementByFilter(h[r?"settingsElementId":"elementId"],h["paramName"],i)}}},_setElementByFilter:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)){n.value=BX.type.isNotEmptyString(t)&&i[t]?i[t]:""}},_onGetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=t.name.indexOf("flt_settings")===0;var a=n.length;for(var s=0;s<a;s++){var d=n[s];var o=BX.type.isNotEmptyString(d["id"])?d["id"]:"";var l=BX.type.isNotEmptyString(d["typeName"])?d["typeName"].toUpperCase():"";var u=d["params"]?d["params"]:{};if(l==="USER"){var f=u["data"]?u["data"]:{};this._setFilterByElement(f[r?"settingsElementId":"elementId"],f["paramName"],i);var m=u["search"]?u["search"]:{};this._setFilterByElement(m[r?"settingsElementId":"elementId"],m["paramName"],i)}}},_setFilterByElement:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)&&BX.type.isNotEmptyString(t)){i[t]=n.value}},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getOwnerType:function(){return this.getSetting("ownerType","")},getForm:function(){return document.forms[this.getSetting("formName","")]},getGrid:function(){return BX(this.getSetting("gridId",""))},getGridJsObject:function(){var e=this.getSetting("gridId","");return BX.type.isNotEmptyString(e)?window["bxGrid_"+e]:null},getAllRowsCheckBox:function(){return BX(this.getSetting("allRowsCheckBoxId",""))},getEditor:function(){var e=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[e]?BX.CrmActivityEditor.items[e]:null},getServiceUrl:function(){return this.getSetting("serviceUrl","/bitrix/components/bitrix/crm.activity.editor/ajax.php")},_loadCommunications:function(e,t,i){BX.ajax({url:this.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_ENTITIES_DEFAULT_COMMUNICATIONS",COMMUNICATION_TYPE:e,ENTITY_TYPE:this.getOwnerType(),ENTITY_IDS:t,GRID_ID:this.getSetting("gridId","")},onsuccess:function(e){if(e&&e["DATA"]&&i){i(e["DATA"])}},onfailure:function(e){}})},_onEmailDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];for(var a=0;a<i.length;a++){var s=i[a];r.push({type:"EMAIL",entityTitle:"",entityType:n,entityId:s["entityId"],value:s["value"]})}}}this.addEmail(t)},_onCallDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];var a=i[0];r.push({type:"PHONE",entityTitle:"",entityType:n,entityId:a["entityId"],value:a["value"]});t["ownerType"]=n;t["ownerID"]=a["entityId"]}}this.addCall(t)},_onMeetingDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];var a=i[0];r.push({type:"",entityTitle:"",entityType:n,entityId:a["entityId"],value:a["value"]});t["ownerType"]=n;t["ownerID"]=a["entityId"]}}this.addMeeting(t)},_handleFormApplyButtonClick:function(e){var t=this.getForm();if(!t){return true}var i=t.elements["action_button_"+this.getSetting("gridId","")];if(!i){return}var n=i.value;if(n==="subscribe"){var r=this.getAllRowsCheckBox();var a=[];if(!(r&&r.checked)){var s=BX.findChildren(this.getGrid(),{tagName:"INPUT",attribute:{type:"checkbox"}},true);if(s){for(var d=0;d<s.length;d++){var o=s[d];if(o.id.indexOf("ID")==0&&o.checked){a.push(o.value)}}}}this._loadCommunications("EMAIL",a,BX.delegate(this._onEmailDataLoaded,this));return BX.PreventDefault(e)}return true},addEmail:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addEmail(e)},addCall:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addCall(e)},addMeeting:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addMeeting(e)},addTask:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addTask(e)},viewActivity:function(e,t){var i=this.getEditor();if(i){i.viewActivity(e,t)}}};BX.CrmInterfaceGridManager.items={};BX.CrmInterfaceGridManager.create=function(e,t){var i=new BX.CrmInterfaceGridManager;i.initialize(e,t);this.items[e]=i;BX.onCustomEvent(this,"CREATED",[i]);return i};BX.CrmInterfaceGridManager.addEmail=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addEmail(t)}};BX.CrmInterfaceGridManager.addCall=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addCall(t)}};BX.CrmInterfaceGridManager.addMeeting=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addMeeting(t)}};BX.CrmInterfaceGridManager.addTask=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addTask(t)}};BX.CrmInterfaceGridManager.viewActivity=function(e,t,i){if(typeof this.items[e]!=="undefined"){this.items[e].viewActivity(t,i)}};BX.CrmInterfaceGridManager.showPopup=function(e,t,i){BX.PopupMenu.show(e,t,i,{offsetTop:0,offsetLeft:-30})};BX.CrmInterfaceGridManager.reloadGrid=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.Reload)){return false}t.Reload();return true};BX.CrmInterfaceGridManager.applyFilter=function(e,t){var i=window["bxGrid_"+e];if(!i||!BX.type.isFunction(i.Reload)){return false}i.ApplyFilter(t);return true};BX.CrmInterfaceGridManager.clearFilter=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.ClearFilter)){return false}t.ClearFilter();return true};BX.CrmInterfaceGridManager.menus={};BX.CrmInterfaceGridManager.createMenu=function(e,t,i){i=parseInt(i);var n=new PopupMenu(e,!isNaN(i)?i:1010);if(BX.type.isArray(t)){n.settingsMenu=t}this.menus[e]=n};BX.CrmInterfaceGridManager.showMenu=function(e,t){var i=this.menus[e];if(typeof i!=="undefined"){i.ShowMenu(t,i.settingsMenu,false,false)}};BX.CrmInterfaceGridManager.expandEllipsis=function(e){if(!BX.type.isDomNode(e)){return false}var t=BX.findNextSibling(e,{"class":"bx-crm-text-cut-on"});if(t){BX.removeClass(t,"bx-crm-text-cut-on");BX.addClass(t,"bx-crm-text-cut-off");t.style.display=""}e.style.display="none";return true}}
//# sourceMappingURL=interface_grid.map.js