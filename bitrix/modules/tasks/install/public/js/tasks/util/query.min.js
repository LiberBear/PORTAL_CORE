BX.namespace("Tasks.Util");BX.Tasks.Util.Query=BX.Tasks.Util.Base.extend({options:{url:"/bitrix/components/bitrix/tasks.base/ajax.php",autoExec:false,replaceDuplicateCode:true,autoExecDelay:500,translateBooleanToZeroOne:true},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Base);this.vars={batch:[],local:{},prevLocal:{}};this.autoExecute=BX.debounce(this.autoExecute,this.option("autoExecDelay"),this)},destruct:function(){this.vars=null;this.opts=null},autoExecute:function(){if(this.option("autoExec")){this.execute()}},add:function(e,t,r,s){if(typeof e=="undefined"){throw new ReferenceError("Method name was not provided")}e=e.toString();if(e.length==0){throw new ReferenceError("Method name must not be empty")}if(typeof t=="undefined"||!BX.type.isPlainObject(t)){t={}}for(var i in t){t[i]=this.processArguments(t[i])}if(typeof r=="undefined"||!BX.type.isPlainObject(r)){r={}}if(typeof r.code=="undefined"){r.code=""}r.code=r.code.toString();if(r.code.length==0){r.code="op_"+this.vars.batch.length}if(this.option("replaceDuplicateCode")){for(var i=0;i<this.vars.batch.length;i++){if(this.vars.batch[i].PARAMETERS.code==r.code){this.vars.batch.splice(i,1);break}}}this.vars.batch.push({OPERATION:e,ARGUMENTS:t,PARAMETERS:r});if(BX.type.isFunction(s)){s={onExecuted:s}}else{s=s||{}}this.vars.local[r.code]=s;this.autoExecute();return this},processArguments:function(e){var t=typeof e;if(t=="array"){if(e.length==0){return""}for(var r=0;r<t.length;r++){e[r]=this.processArguments(e[r])}}if(t=="object"){var s=0;for(var r in e){e[r]=this.processArguments(e[r]);s++}if(s==0){return""}}if(t=="boolean"&&this.option("translateBooleanToZeroOne")){return e===true?"1":"0"}return e},load:function(e){if(BX.type.isArray(e)){this.clear();for(var t=0;t<e.length;t++){this.add(e[t].m,e[t].args,e[t].rp)}}return this},deleteAll:function(){this.vars.batch=[];this.vars.local={};return this},clear:function(){return this.deleteAll()},execute:function(e){if(this.opts.url===false){throw new ReferenceError("URL was not provided")}if(typeof e=="undefined"){e={}}if(this.vars.batch.length>0){this.vars.prevLocal=BX.clone(this.vars.local);var t=this.vars.batch;this.clear();BX.ajax({url:this.opts.url,method:"post",dataType:"json",async:true,processData:true,emulateOnload:true,start:true,data:{sessid:BX.bitrix_sessid(),SITE_ID:BX.message("SITE_ID"),ACTION:t},cache:false,onsuccess:BX.delegate(function(t){try{var r={success:t.SUCCESS,clientProcessErrors:[],serverProcessErrors:t.ERROR,data:t.DATA||{},response:t};this.executeDone(r,e.done);this.fireEvent("executed",[r])}catch(s){BX.debug(s)}},this),onfailure:BX.delegate(function(t,r){var s={success:false,clientProcessErrors:[{CODE:"INTERNAL_ERROR",MESSAGE:"Client process error",TYPE:"FATAL",ajaxExtra:{code:t,status:r}}],serverProcessErrors:[],data:{}};this.executeDone(s,e.done);this.fireEvent("executed",[s])},this)})}},executeDone:function(e,t){var r=this.getErrorCollectionClass();var s=new r;var i;var o;i=e.serverProcessErrors||[];for(o=0;o<i.length;o++){s.add(i[o],"C")}i=e.clientProcessErrors||[];for(o=0;o<i.length;o++){s.add(i[o],"C")}var n=BX.clone(e.data);var a=new r(s);var c;for(var l in n){c=null;c=new r(a);i=e.data[l].ERRORS||[];for(o=0;o<i.length;o++){c.add(i[o])}if(BX.type.isFunction(this.vars.prevLocal[l].onExecuted)){delete n[l].ERRORS;delete n[l].SUCCESS;this.vars.prevLocal[l].onExecuted.apply(this,[c,n[l]])}c.deleteByMark("C");s.load(c)}if(BX.type.isFunction(t)){t.apply(this,[s,e])}if(s.checkHasErrors()){BX.onCustomEvent("TaskAjaxError",[s])}},getErrorCollectionClass:function(){return BX.Tasks.Util.Query.ErrorCollection}}});BX.Tasks.Util.Query.ErrorCollection=function(e){this.length=0;if(typeof e!="undefined"){this.load(e)}};BX.mergeEx(BX.Tasks.Util.Query.ErrorCollection.prototype,{add:function(e,t){this[this.length++]=new BX.Tasks.Util.Query.Error(BX.clone(e),t)},load:function(e){for(var t=0;t<e.length;t++){this.add(e[t],false)}},getByCode:function(e){if(!BX.type.isNotEmptyString(e)){return false}for(var t=0;t<this.length;t++){if(this[t].checkIsOfCode(e)){return BX.clone(this[t])}}return null},checkHasErrors:function(){return!!this.length},deleteByCodeAll:function(e){if(!BX.type.isNotEmptyString(e)){return}this.deleteByCondition(function(t){return t.checkIsOfCode(e)})},deleteByMark:function(e){if(!BX.type.isNotEmptyString(e)){return}this.deleteByCondition(function(t){return t.mark()==e})},deleteByCondition:function(e){var t=[];for(var r=0;r<this.length;r++){if(!e.apply(this,[this[r]])){t.push(this[r])}}this.deleteAll(false);this.load(t)},deleteAll:function(e){for(var t=0;t<this.length;t++){if(e!==false){this[t]=null}delete this[t]}this.length=0}});BX.Tasks.Util.Query.Error=function(e,t){for(var r in e){if(e.hasOwnProperty(r)){this[r]=BX.clone(e[r])}}this.vars={mark:t}};BX.mergeEx(BX.Tasks.Util.Query.Error.prototype,{checkIsOfCode:function(e){return this.CODE==e||BX.util.in_array(e,this.CODE.toString().split("."))},code:function(){return this.CODE},mark:function(){return this.vars.mark},data:function(){if(BX.type.isPlainObject(this.DATA)){return this.DATA}return{}}});
//# sourceMappingURL=query.map.js