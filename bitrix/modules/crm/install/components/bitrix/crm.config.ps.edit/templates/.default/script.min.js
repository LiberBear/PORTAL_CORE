BX.crmPaySys={formId:"",orderProps:{},orderFields:{},userProps:{},userFields:{},requisiteFields:{},bankDetailFields:{},companyFields:{},contactFields:{},simpleMode:true,init:function(e){for(var i in e){if(e.hasOwnProperty(i)){this[i]=e[i]}}this.formObj=BX(this.formId)},switchMode:function(){var e=BX("MODE_SWITCHER");if(BX.crmPaySys.simpleMode){BX.crmPSPropType.showItems();BX.crmPSActionFile.showNoneSimpleRows();e.innerHTML=BX.message("CRM_PS_HIDE_FIELDS")}else{BX.crmPSPropType.hideItems();BX.crmPSActionFile.hideNoneSimpleRows();e.innerHTML=BX.message("CRM_PS_SHOW_FIELDS")}BX.crmPaySys.simpleMode=!BX.crmPaySys.simpleMode}};BX.crmPSPersonType={init:function(e){for(var i in e)this[i]=e[i];var s=BX.crmPaySys.formObj["PERSON_TYPE_ID"];if(s)BX.bind(s,"change",BX.delegate(BX.crmPSPersonType.onSelect,this))},getId:function(){return BX.crmPaySys.formObj["PERSON_TYPE_ID"].value},onSelect:function(){var e=this.getOrderPropsFNames();this.replaceOrderPropsSelectors(e)},getOrderPropsFNames:function(){var e=[];for(var i=0,s=BX.crmPaySys.formObj.elements.length;i<s;i++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[i].name))continue;if(BX.crmPaySys.formObj.elements[i].value!="PROPERTY")continue;e.push(BX.crmPaySys.formObj.elements[i].name.replace(/^TYPE_/,""))}return e},replaceOrderPropsSelectors:function(e){var i=this.getId();for(var s=0,t=e.length;s<t;s++)BX.crmPSPropType.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e[s]],BX.crmPaySys.orderProps[i])}};BX.crmPSPropType={init:function(e){for(var i in e)this[i]=e[i];this.bindEvents()},bindEvents:function(){var e=function(){var e=this;BX.delegate(BX.crmPSPropType.onSelect(e),this)};for(var i=0,s=BX.crmPaySys.formObj.elements.length;i<s;i++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[i].name))continue;var t=BX.crmPaySys.formObj.elements[i];if(t)BX.bind(t,"change",e)}},onSelect:function(e){this.replaceValueField(e)},replaceValueField:function(e){var i=e.name.replace(/^TYPE_/,"");if(e.value=="USER")this.setUserProps(i);else if(e.value=="ORDER")this.setOrderFields(i);else if(e.value=="PROPERTY")this.setOrderProps(i);else if(e.value=="REQUISITE")this.setRequisiteFields(i);else if(e.value=="BANK_DETAIL")this.setBankDetailFields(i);else if(e.value=="CRM_COMPANY")this.setCompanyFields(i);else if(e.value=="CRM_CONTACT")this.setContactFields(i);else if(e.value=="")this.setOtherProps(i)},setUserProps:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.userProps);this.showSelectorField(e)},setOrderFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.orderFields);this.showSelectorField(e)},setOrderProps:function(e){var i=BX.crmPSPersonType.getId();var s=BX.crmPaySys.orderProps[i];var t=BX.crmPSActionFile.getId();var r=/^([a-z]+)(?:_([a-z]+))?$/i.exec(t);var a="";if(BX.type.isArray(r)&&r.length>1){a=r[1]}if(a!==""&&typeof BX.crmPaySys.userFields[a]!=="undefined"){s=BX.clone(s);var l=BX.crmPaySys.userFields[a];for(var n in l){if(!l.hasOwnProperty(n)){continue}s[n]=l[n]}}this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],s);this.showSelectorField(e)},setRequisiteFields:function(e){this.rebuildSelect(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.requisiteFields,"");this.showSelectorField(e)},setBankDetailFields:function(e){this.rebuildSelect(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.bankDetailFields);this.showSelectorField(e)},rebuildSelect:function(e,i,s){var t,r,a,l,n;var o=false;var d,c;var m=null;if(!(s instanceof Array))s=[s];if(e){d=!!e.getAttribute("multiple");while(t=e.lastChild)e.removeChild(t);r=0;for(l=0;l<i.length;l++){c=false;if(i[l]["type"]){if(i[l]["type"]==="group"){a=document.createElement("optgroup");a.label=i[l]["title"];c=true}else if(i[l]["type"]==="endgroup"){m=null;continue}}else{a=document.createElement("option");a.value=i[l]["id"];a.innerHTML=BX.util.htmlspecialchars(i[l]["title"])}if(!c&&m)m.appendChild(a);else e.appendChild(a);if(c){m=a}else{if(!o||d){for(n=0;n<s.length;n++){if(i[l]["id"]==s[n]){a.selected=true;if(!o){o=true;e.selectedIndex=r}break}}}r++}}}},setCompanyFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.companyFields);this.showSelectorField(e)},setContactFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.contactFields);this.showSelectorField(e)},setOtherProps:function(e){BX.crmPaySys.formObj["VALUE2_"+e].value="";this.showInputField(e)},showSelectorField:function(e,i){var s=!i;BX.crmPaySys.formObj["VALUE1_"+e].style.display=s?"":"none";BX.crmPaySys.formObj["VALUE2_"+e].style.display=s?"none":""},showInputField:function(e){this.showSelectorField(e,true)},insertOptions:function(e,i){var s=e.value;e.options.length=0;for(var t in i){var r=document.createElement("option");r.value=t;r.text=i[t];try{e.add(r,null)}catch(a){e.add(r)}}e.value=s},hideItems:function(e){bHide=!e;for(var i=0,s=BX.crmPaySys.formObj.elements.length;i<s;i++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[i].name))continue;var t=BX.crmPaySys.formObj.elements[i];if(t&&t.value!="SELECT"&&t.value!="FILE")t.style.display=bHide?"none":""}},showItems:function(){this.hideItems(true)}};BX.crmPSActionFile={arFields:{},arFieldsList:{},arSavedFields:{},typeValuesTmpl:"",fileValuesTmpl:"",selectValuesTmpl:"",init:function(e){for(var i in e)this[i]=e[i];var s=BX.crmPaySys.formObj["ACTION_FILE"];if(s)BX.bind(s,"change",BX.delegate(BX.crmPSActionFile.onSelect,this));if(BX.crmPaySys.simpleMode)this.hideNoneSimpleRows()},getId:function(){return BX.crmPaySys.formObj["ACTION_FILE"].value},onSelect:function(){this.getAjaxFields()},getAjaxFields:function(e){var i=this.getId();if(this.arFields[i]){this.insertFields(i,this.arFields[i]);if(this.arFieldsList[i])this.setFieldsList(this.arFieldsList[i]);return}data={id:i,action:"get_fields",person_type:BX.crmPSPersonType.getId(),sessid:BX.bitrix_sessid()};BX.ajax({data:data,method:"POST",dataType:"json",url:BX.crmPaySys.url+"/ajax.php",onsuccess:BX.delegate(function(e){if(e.ERROR)BX.debug("BX.crmPSActionFile.getAjaxFields: "+e.ERROR);else{if(e.FIELDS){this.arFields[i]=e.FIELDS;this.insertFields(i,e.FIELDS)}if(e.FIELDS_LIST){this.arFieldsList[i]=e.FIELDS_LIST;this.setFieldsList(e.FIELDS_LIST)}}},this),onfailure:function(){BX.debug("onfailure: BX.crmPSActionFile.getAjaxFields")}})},saveFields:function(){for(var e=0,i=BX.crmPaySys.formObj.elements.length;e<i;e++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[e].name))continue;var s=BX.crmPaySys.formObj.elements[e].name.replace(/^TYPE_/,"");this.arSavedFields[s]={};this.arSavedFields[s].TYPE=BX.crmPaySys.formObj["TYPE_"+s].value;switch(this.arSavedFields[s].TYPE){case"FILE":var t=BX(s+"_preview_img");if(t){this.arSavedFields[s].SRC=t.getAttribute("src");this.arSavedFields[s].HEIGHT=t.getAttribute("height");this.arSavedFields[s].WIDTH=t.getAttribute("width")}break;case"SELECT":var r=BX("VALUE1_"+s);var a={};for(var l=0;l<r.options.length;l++)a[r.options[l].value]=r.options[l].text;this.arSavedFields[s].VALUE1=r.value;this.arSavedFields[s].OPTIONS=a;break;default:var r=BX("VALUE1_"+s);var n=BX("VALUE2_"+s);this.arSavedFields[s].VALUE1=r.value;if(n)this.arSavedFields[s].VALUE2=n.value}}},restoreFields:function(){if(this.arSavedFields){for(var e in this.arSavedFields){var i=BX("TYPE_"+e);if(i)i.value=this.arSavedFields[e]["TYPE"];switch(i.value){case"FILE":var s=BX(e+"_preview_img");if(s&&this.arSavedFields[e]&&this.arSavedFields[e].SRC){s.setAttribute("src",this.arSavedFields[e].SRC);s.setAttribute("height",this.arSavedFields[e].HEIGHT);s.setAttribute("width",this.arSavedFields[e].WIDTH)}else{BX(e+"_preview").style.display="none"}break;case"SELECT":var t=BX("VALUE1_"+e);if(this.arSavedFields[fieldId]){BX.crmPSPropType.insertOptions(t,this.arSavedFields[e].OPTIONS);t.value=this.arSavedFields[e].VALUE1}else{t.value=0}break;default:var t=BX("VALUE1_"+e);var r=BX("VALUE2_"+e);t.value=this.arSavedFields[e]["VALUE1"];if(r)r.value=this.arSavedFields[e]["VALUE2"]}}}},insertFields:function(e,i){this.saveFields();this.removeFields();var s=BX.crmPaySys.formObj["ACTION_FILE"].parentNode.parentNode.parentNode,t=false;for(var r in i){t=this.makeRow(r,i[r]);s.insertBefore(t,s.lastElementChild);var a=BX("TYPE_"+r);if(!a)continue;a.value=this.arSavedFields[r]&&this.arSavedFields[r].TYPE?this.arSavedFields[r].TYPE:i[r].TYPE;BX.crmPSPropType.replaceValueField(a);if(BX.crmPaySys.simpleMode){if(a.value!=""&&a.value!="SELECT"&&a.value!="FILE")t.style.display="none";a.style.display="none"}switch(a.value){case"FILE":var l=BX(r+"_preview_img");if(l&&this.arSavedFields[r]&&this.arSavedFields[r].SRC){l.setAttribute("src",this.arSavedFields[r].SRC);l.setAttribute("height",this.arSavedFields[r].HEIGHT);l.setAttribute("width",this.arSavedFields[r].WIDTH)}else{BX(r+"_preview").style.display="none"}break;case"SELECT":var n=BX("VALUE1_"+r);if(this.arSavedFields[r]){BX.crmPSPropType.insertOptions(n,this.arSavedFields[r].OPTIONS);n.value=this.arSavedFields[r].VALUE1}else{n.value=0}break;case"":var n=BX("VALUE2_"+r);if(n&&n!=""){n.value=this.arSavedFields[r]&&this.arSavedFields[r].VALUE2?this.arSavedFields[r].VALUE2:""}break;default:var n=BX("VALUE1_"+r);if(n&&n!=""){n.value=this.arSavedFields[r]&&this.arSavedFields[r].VALUE1?this.arSavedFields[r].VALUE1:i[r].VALUE}}}BX.crmPSPropType.bindEvents()},makeRow:function(e,i){var s=document.createElement("tr"),t=document.createElement("td"),r=document.createElement("td");t.className="bx-field-name bx-padding";t.title=i.DESCR;t.innerHTML=i.NAME+":";s.appendChild(t);var a="";switch(i.TYPE){case"FILE":a=this.fileValuesTmpl.replace(/\#FIELD_ID\#/g,e);break;case"SELECT":a=this.selectValuesTmpl.replace(/\#FIELD_ID\#/g,e);break;default:a=this.typeValuesTmpl.replace(/\#FIELD_ID\#/g,e)}r.className="bx-field-value";r.innerHTML=a;s.appendChild(r);return s},removeFields:function(){var e=BX.crmPaySys.formObj["ACTION_FILE"].parentNode.parentNode.nextElementSibling.nextElementSibling,i=e;do{tmpRow=i.nextElementSibling;i.parentNode.removeChild(i);i=tmpRow}while(i&&i.className!="bx-bottom")},setFieldsList:function(e){var i=BX.crmPaySys.formObj["PS_ACTION_FIELDS_LIST"];if(i)i.value=e},hideNoneSimpleRows:function(e){bHide=!e;for(var i=0,s=BX.crmPaySys.formObj.elements.length;i<s;i++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[i].name))continue;var t=BX.crmPaySys.formObj[BX.crmPaySys.formObj.elements[i].name];if(!t||t.value==""||t.value=="SELECT"||t.value=="FILE")continue;var r=t.parentNode.parentNode;if(r)r.style.display=bHide?"none":""}},showNoneSimpleRows:function(){this.hideNoneSimpleRows(true)}};
//# sourceMappingURL=script.map.js