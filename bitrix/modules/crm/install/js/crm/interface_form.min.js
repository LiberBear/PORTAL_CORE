function BxCrmInterfaceForm(t,e){var i=this;this.name=t;this.aTabs=e;this.bExpandTabs=false;this.vars={};this.oTabsMeta={};this.aTabsEdit=[];this.oFields={};this.menu=new PopupMenu("bxFormMenu_"+this.name,1010);this.settingsMenu=[];this.tabSettingsWnd=null;this.fieldSettingsWnd=null;this.activeTabClass="bx-crm-view-tab-active";this._form=null;this._isSubmitted=false;this._enableSigleSubmit=true;this.isVisibleInViewMode=true;var s=BX("container_"+this.name.toLowerCase());if(s){this.isVisibleInViewMode=s.style.display!=="none"}this.Initialize=function(){this._form=BX("form_"+this.name);if(this._enableSigleSubmit){this._submitHandler=BX.delegate(this._OnSubmit,this);BX.bind(this._form,"submit",this._submitHandler)}BX.onCustomEvent(window,"CrmInterfaceFormCreated",[this])};this.EnableSigleSubmit=function(t){t=!!t;if(this._enableSigleSubmit===t){return}if(this._enableSigleSubmit&&this._submitHandler){BX.unbind(this._form,"submit",this._submitHandler);this._submitHandler=null}this._enableSigleSubmit=t;if(this._enableSigleSubmit){this._submitHandler=BX.delegate(this._OnSubmit,this);BX.bind(this._form,"submit",this._submitHandler)}};this.GetForm=function(){return this._form};this._OnSubmit=function(t){if(!this._enableSigleSubmit){return true}if(this._isSubmitted){return BX.PreventDefault(t)}this._isSubmitted=true;window.setTimeout(BX.delegate(this._LockSubmits,this),10);return true};this._LockSubmits=function(){var t=BX(this.name+"_saveAndView");if(t){t.disabled="disabled"}var e=BX(this.name+"_saveAndAdd");if(e){e.disabled="disabled"}var i=BX(this.name+"_apply");if(i){i.disabled="disabled"}};this.GetTabs=function(){var t=BX.findChildren(BX(this.name+"_tab_block"),{tagName:"a",className:"bx-crm-view-tab"},false);return t?t:[]};this.GetActiveTabId=function(){var t=this.GetTabs();for(var e=0;e<t.length;e++){var i=t[e];if(BX.hasClass(i,this.activeTabClass)){return i.id.substring((this.name+"_tab_").length)}}return""};this.ShowOnDemand=function(t){var e=BX.findParent(t,{tagName:"DIV",className:"bx-crm-view-fieldset"});var i=BX.findChildren(e,{tagName:"tr",className:"bx-crm-view-on-demand"},true);if(!BX.type.isArray(i)){return}for(var s=0;s<i.length;s++){i[s].style.display=""}if(t){BX.findParent(t,{tagName:"tr",className:"bx-crm-view-show-more"}).style.display="none"}};this.SelectTab=function(t){var e=BX("inner_tab_"+t);if(!e||e.style.display!="none")return;for(var i=0,s=this.aTabs.length;i<s;i++){var n=BX("inner_tab_"+this.aTabs[i]);if(!n)continue;if(n.style.display!="none"){this.ShowTab(this.aTabs[i],false);n.style.display="none";break}}this.ShowTab(t,true);e.style.display="block";var a=BX(this.name+"_active_tab");if(a)a.value=t;BX.onCustomEvent(window,"BX_CRM_INTERFACE_FORM_TAB_SELECTED",[this,this.name,t,e])};this.ShowTab=function(t,e){var i=this.name+"_tab_"+t;var s=this.GetTabs();for(var n=0;n<s.length;n++){var a=s[n];if(i!==a.id){continue}if(e){BX.addClass(a,"bx-crm-view-tab-active");BX.onCustomEvent(this,"OnTabShow",[t])}else{BX.removeClass(a,"bx-crm-view-tab-active");BX.onCustomEvent(this,"OnTabHide",[t])}break}};this.HoverTab=function(t,e){var i=document.getElementById("tab_"+t);if(i.className=="bx-tab-selected")return;document.getElementById("tab_left_"+t).className=e?"bx-tab-left-hover":"bx-tab-left";i.className=e?"bx-tab-hover":"bx-tab";var s=document.getElementById("tab_right_"+t);s.className=e?"bx-tab-right-hover":"bx-tab-right"};this.ShowDisabledTab=function(t,e){var s=document.getElementById("tab_cont_"+t);if(e){s.className="bx-tab-container-disabled";s.onclick=null;s.onmouseover=null;s.onmouseout=null}else{s.className="bx-tab-container";s.onclick=function(){i.SelectTab(t)};s.onmouseover=function(){i.HoverTab(t,true)};s.onmouseout=function(){i.HoverTab(t,false)}}};this.ToggleTabs=function(t){this.bExpandTabs=!this.bExpandTabs;var e=document.getElementById("bxForm_"+this.name+"_expand_link");e.title=this.bExpandTabs?this.vars.mess.collapseTabs:this.vars.mess.expandTabs;e.className=this.bExpandTabs?e.className.replace(/\s*bx-down/gi," bx-up"):e.className.replace(/\s*bx-up/gi," bx-down");var i;for(var s in this.aTabs){var n=this.aTabs[s];this.ShowTab(n,false);this.ShowDisabledTab(n,this.bExpandTabs);i=document.getElementById("inner_tab_"+n);i.style.display=this.bExpandTabs?"block":"none"}if(!this.bExpandTabs){this.ShowTab(this.aTabs[0],true);i=document.getElementById("inner_tab_"+this.aTabs[0]);i.style.display="block"}if(t!==true)BX.ajax.get("/bitrix/components"+this.vars.component_path+"/settings.php?FORM_ID="+this.name+"&action=expand&expand="+(this.bExpandTabs?"Y":"N")+"&sessid="+this.vars.sessid)};this.SetTheme=function(t,e){BX.loadCSS(this.vars.template_path+"/themes/"+e+"/style.css");var s=this.menu.GetMenuByItemId(t.id);s.SetAllItemsIcon("");s.SetItemIcon(t,"checked");BX.ajax.get("/bitrix/components"+i.vars.component_path+"/settings.php?FORM_ID="+this.name+"&GRID_ID="+this.vars.GRID_ID+"&action=settheme&theme="+e+"&sessid="+this.vars.sessid)};this.ShowSettings=function(){var t=false;if(!window["formSettingsDialog"+this.name]){window["formSettingsDialog"+this.name]=new BX.CDialog({content:'<form name="form_settings_'+this.name+'"></form>',title:this.vars.mess.settingsTitle,width:this.vars.settingWndSize.width,height:this.vars.settingWndSize.height,resize_id:"InterfaceFormSettingWnd"});t=true}window["formSettingsDialog"+this.name].ClearButtons();window["formSettingsDialog"+this.name].SetButtons([{title:this.vars.mess.settingsSave,action:function(){i.SaveSettings();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);window["formSettingsDialog"+this.name].Show();var e=document["form_settings_"+this.name];if(t)e.appendChild(BX("form_settings_"+this.name));var s;this.aTabsEdit=[];for(s in this.oTabsMeta){var n=[];for(var a in this.oTabsMeta[s].fields)n[n.length]=BX.clone(this.oTabsMeta[s].fields[a]);this.aTabsEdit[this.aTabsEdit.length]=BX.clone(this.oTabsMeta[s]);this.aTabsEdit[this.aTabsEdit.length-1].fields=n}jsSelectUtils.deleteAllOptions(e.tabs);for(s in this.aTabsEdit)e.tabs.options[e.tabs.length]=new Option(this.aTabsEdit[s].name,this.aTabsEdit[s].id,false,false);e.tabs.selectedIndex=0;this.OnSettingsChangeTab();this.aAvailableFields=BX.clone(this.oFields);jsSelectUtils.deleteAllOptions(e.all_fields);for(s in this.aAvailableFields)e.all_fields.options[e.all_fields.length]=new Option(this.aAvailableFields[s].name,this.aAvailableFields[s].id,false,false);jsSelectUtils.sortSelect(e.all_fields);this.HighlightSections(e.all_fields);this.ProcessButtons();e.tabs.focus()};this.OnSettingsChangeTab=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;jsSelectUtils.deleteAllOptions(t.fields);for(var i in this.aTabsEdit[e].fields){var s=new Option(this.aTabsEdit[e].fields[i].name,this.aTabsEdit[e].fields[i].id,false,false);if(this.aTabsEdit[e].fields[i].type=="section")s.className="bx-section";t.fields.options[t.fields.length]=s}this.ProcessButtons()};this.TabMoveUp=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e>0){var i=BX.clone(this.aTabsEdit[e]);var s=BX.clone(this.aTabsEdit[e-1]);this.aTabsEdit[e]=s;this.aTabsEdit[e-1]=i}jsSelectUtils.moveOptionsUp(t.tabs)};this.TabMoveDown=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<t.tabs.length-1){var i=BX.clone(this.aTabsEdit[e]);this.aTabsEdit[e]=BX.clone(this.aTabsEdit[e+1]);this.aTabsEdit[e+1]=i}jsSelectUtils.moveOptionsDown(t.tabs)};this.TabEdit=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<0)return;this.ShowTabSettings(this.aTabsEdit[e],function(){var s=document["tab_settings_"+i.name];i.aTabsEdit[e].name=s.tab_name.value;i.aTabsEdit[e].title=s.tab_title.value;t.tabs[e].text=s.tab_name.value})};this.TabAdd=function(){this.ShowTabSettings({name:"",title:""},function(){var t="tab_"+Math.round(Math.random()*1e6);var e=document["tab_settings_"+i.name];i.aTabsEdit[i.aTabsEdit.length]={id:t,name:e.tab_name.value,title:e.tab_title.value,fields:[]};var s=document["form_settings_"+i.name];s.tabs[s.tabs.length]=new Option(e.tab_name.value,t,true,true);i.OnSettingsChangeTab()})};this.TabDelete=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<0)return;var i;for(i in this.aTabsEdit[e].fields){this.aAvailableFields[this.aTabsEdit[e].fields[i].id]=this.aTabsEdit[e].fields[i];jsSelectUtils.addNewOption(t.all_fields,this.aTabsEdit[e].fields[i].id,this.aTabsEdit[e].fields[i].name,true,false)}this.HighlightSections(t.all_fields);this.aTabsEdit=BX.util.deleteFromArray(this.aTabsEdit,e);t.tabs.remove(e);if(t.tabs.length>0){i=e<t.tabs.length?e:t.tabs.length-1;t.tabs[i].selected=true;this.OnSettingsChangeTab()}else{jsSelectUtils.deleteAllOptions(t.fields);this.ProcessButtons()}};this.ShowTabSettings=function(t,e){var i=this.tabSettingsWnd;if(!i){this.tabSettingsWnd=i=new BX.CDialog({content:'<form name="tab_settings_'+this.name+'">'+'<table width="100%">'+"<tr>"+'<td width="50%" align="right">'+this.vars.mess.tabSettingsName+"</td>"+'<td><input type="text" name="tab_name" size="30" value="" style="width:90%"></td>'+"</tr>"+"<tr>"+'<td align="right">'+this.vars.mess.tabSettingsCaption+"</td>"+'<td><input type="text" name="tab_title" size="30" value="" style="width:90%"></td>'+"</tr>"+"</table>"+"</form>",title:this.vars.mess.tabSettingsTitle,width:this.vars.tabSettingWndSize.width,height:this.vars.tabSettingWndSize.height,resize_id:"InterfaceFormTabSettingWnd"})}i.ClearButtons();i.SetButtons([{title:this.vars.mess.tabSettingsSave,action:function(){e();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);i.Show();var s=document["tab_settings_"+this.name];s.tab_name.value=t.name;s.tab_title.value=t.title;s.tab_name.focus()};this.ShowFieldSettings=function(t,e){var i=this.fieldSettingsWnd;if(!i){this.fieldSettingsWnd=i=new BX.CDialog({content:'<form name="field_settings_'+this.name+'">'+'<table width="100%">'+"<tr>"+'<td width="50%" align="right" id="field_name_'+this.name+'"></td>'+'<td><input type="text" name="field_name" size="30" value="" style="width:90%"></td>'+"</tr>"+"</table>"+"</form>",width:this.vars.fieldSettingWndSize.width,height:this.vars.fieldSettingWndSize.height,resize_id:"InterfaceFormFieldSettingWnd"})}i.SetTitle(t.type&&t.type=="section"?this.vars.mess.sectSettingsTitle:this.vars.mess.fieldSettingsTitle);BX("field_name_"+this.name).innerHTML=t.type&&t.type=="section"?this.vars.mess.sectSettingsName:this.vars.mess.fieldSettingsName;i.ClearButtons();i.SetButtons([{title:this.vars.mess.tabSettingsSave,action:function(){e();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);i.Show();var s=document["field_settings_"+this.name];s.field_name.value=t.name;s.field_name.focus()};this.FieldEdit=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;var s=t.fields.selectedIndex;if(e<0||s<0)return;this.ShowFieldSettings(this.aTabsEdit[e].fields[s],function(){var n=document["field_settings_"+i.name];i.aTabsEdit[e].fields[s].name=n.field_name.value;t.fields[s].text=n.field_name.value})};this.FieldAdd=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<0)return;this.ShowFieldSettings({name:"",type:"section"},function(){var s="field_"+Math.round(Math.random()*1e6);var n=document["field_settings_"+i.name];i.aTabsEdit[e].fields[i.aTabsEdit[e].fields.length]={id:s,name:n.field_name.value,type:"section"};var a=new Option(n.field_name.value,s,true,true);a.className="bx-section";t.fields[t.fields.length]=a;i.ProcessButtons()})};this.FieldsMoveUp=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;var i=t.fields.length;for(var s=0;s<i;s++){if(t.fields[s].selected&&s>0&&t.fields[s-1].selected==false){var n=BX.clone(this.aTabsEdit[e].fields[s]);this.aTabsEdit[e].fields[s]=BX.clone(this.aTabsEdit[e].fields[s-1]);this.aTabsEdit[e].fields[s-1]=n;var a=new Option(t.fields[s].text,t.fields[s].value);var r=new Option(t.fields[s-1].text,t.fields[s-1].value);a.className=t.fields[s].className;r.className=t.fields[s-1].className;t.fields[s]=r;t.fields[s].selected=false;t.fields[s-1]=a;t.fields[s-1].selected=true}}};this.FieldsMoveDown=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;var i=t.fields.length;for(var s=i-1;s>=0;s--){if(t.fields[s].selected&&s<i-1&&t.fields[s+1].selected==false){var n=BX.clone(this.aTabsEdit[e].fields[s]);this.aTabsEdit[e].fields[s]=BX.clone(this.aTabsEdit[e].fields[s+1]);this.aTabsEdit[e].fields[s+1]=n;var a=new Option(t.fields[s].text,t.fields[s].value);var r=new Option(t.fields[s+1].text,t.fields[s+1].value);a.className=t.fields[s].className;r.className=t.fields[s+1].className;t.fields[s]=r;t.fields[s].selected=false;t.fields[s+1]=a;t.fields[s+1].selected=true}}};this.FieldsAdd=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e==-1)return;var i=this.aTabsEdit[e].fields;var s=t.all_fields.length,n;for(n=0;n<s;n++)if(t.all_fields[n].selected)i[i.length]={id:t.all_fields[n].value,name:t.all_fields[n].text,type:this.aAvailableFields[t.all_fields[n].value].type};jsSelectUtils.addSelectedOptions(t.all_fields,t.fields,false,false);jsSelectUtils.deleteSelectedOptions(t.all_fields);for(n=0,s=t.fields.length;n<s;n++)if(i[n].type=="section")t.fields[n].className="bx-section";this.ProcessButtons()};this.FieldsDelete=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e==-1)return;var i=t.fields.length;var s=0;for(var n=0;n<i;n++){if(t.fields[n].selected){this.aAvailableFields[t.fields[n].value]=this.aTabsEdit[e].fields[n-s];this.aTabsEdit[e].fields=BX.util.deleteFromArray(this.aTabsEdit[e].fields,n-s);s++}}jsSelectUtils.addSelectedOptions(t.fields,t.all_fields,false,true);jsSelectUtils.deleteSelectedOptions(t.fields);this.HighlightSections(t.all_fields);this.ProcessButtons()};this.ProcessButtons=function(){var t=document["form_settings_"+this.name];t.add_btn.disabled=t.all_fields.selectedIndex==-1||t.tabs.selectedIndex==-1;t.del_btn.disabled=t.up_btn.disabled=t.down_btn.disabled=t.field_edit_btn.disabled=t.fields.selectedIndex==-1;t.tab_up_btn.disabled=t.tab_down_btn.disabled=t.tab_edit_btn.disabled=t.tab_del_btn.disabled=t.field_add_btn.disabled=t.tabs.selectedIndex==-1};this.HighlightSections=function(t){for(var e=0,i=t.length;e<i;e++)if(this.aAvailableFields[t[e].value].type=="section")t[e].className="bx-section"};this.SaveSettings=function(){var t={FORM_ID:this.name,action:"savesettings",sessid:this.vars.sessid,tabs:this.aTabsEdit};var e=document["form_settings_"+this.name];if(e&&e["set_default_settings"]){t.set_default_settings=e.set_default_settings.checked?"Y":"N";t.delete_users_settings=e.delete_users_settings.checked?"Y":"N"}BX.ajax.post("/bitrix/components"+i.vars.component_path+"/settings.php",t,function(){i.Reload()})};this.SaveSettings=function(t){if(!BX.type.isPlainObject(t)){t={}}var e=BX.type.isFunction(t["callback"])?t["callback"]:null;var s={FORM_ID:this.name,action:"savesettings",sessid:this.vars.sessid,tabs:this.aTabsEdit};var n=document["form_settings_"+this.name];if(n&&n["set_default_settings"]){s["set_default_settings"]=n.set_default_settings.checked?"Y":"N";s["delete_users_settings"]=n.delete_users_settings.checked?"Y":"N"}else{if(BX.type.isBoolean(t["setDefaultSettings"])){s["set_default_settings"]=t["setDefaultSettings"]?"Y":"N"}if(BX.type.isBoolean(t["deleteUserSettings"])){s["delete_users_settings"]=t["deleteUserSettings"]?"Y":"N"}}var a="/bitrix/components"+i.vars.component_path+"/settings.php";if(e){BX.ajax.post(a,s,e)}else{BX.ajax.post(a,s,function(){i.Reload()})}};this.EnableSettings=function(t,e){var s="/bitrix/components"+this.vars.component_path+"/settings.php?FORM_ID="+this.name+"&action=enable&enabled="+(t?"Y":"N")+"&sessid="+this.vars.sessid;if(BX.type.isFunction(e)){BX.ajax.get(s,e)}else{BX.ajax.get(s,function(){i.Reload()})}};this.Reload=function(){var t=this.vars.ajax.AJAX_ID;if(t!=""){var e=BX.util.remove_url_param(this.vars.current_url,"bxajaxid");if(e[e.length-1]==="?"){e=e.substr(0,e.length-1)}BX.ajax.insertToNode(e+(e.indexOf("?")<0?"?":"&")+"bxajaxid="+t,"comp_"+t)}else{window.location=window.location.href}};this.ReloadActiveTab=function(){var t=this.name+"_active_tab";var e=BX.util.remove_url_param(this.vars.current_url,t);if(e[e.length-1]==="?"){e=e.substr(0,e.length-1)}e+=(e.indexOf("?")<0?"?":"&")+t+"="+this.GetActiveTabId();var i=this.vars.ajax.AJAX_ID;if(i!=""){BX.ajax.insertToNode(e+"&bxajaxid="+i,"comp_"+i)}else{window.location=e}};this.SetViewModeVisibility=function(t){t=!!t;if(this.isVisibleInViewMode===t){return}this.isVisibleInViewMode=t;var e=BX("container_"+this.name.toLowerCase());if(e){e.style.display=this.isVisibleInViewMode?"":"none"}BX.userOptions.save("main.interface.form",this.name,"show_in_view_mode",t?"Y":"N",false)}}BX.CmrSidebarFieldSelector=function(){this._id="";this._fieldId="";this._currentItem=null;this._elem=null;this._settings={};this._items={};this._popupMenu=null};BX.CmrSidebarFieldSelector.prototype={initialize:function(t,e,i,s){this._id=t;this._fieldId=e;this._elem=i;this._settings=s;this._items={};var n=this.getSettings("options",null);if(n){for(var a=0;a<n.length;a++){var r=n[a];if(BX.type.isNotEmptyString(r["id"])){var o=r["id"];this._items[o]=BX.CmrSidebarFieldSelectorItem.create(o,this,{text:BX.type.isNotEmptyString(r["caption"])?r["caption"]:o})}}}BX.bind(this._elem,"click",BX.proxy(this._onElementClick,this));var l=BX(this.getSettings("buttonId",""));if(l){BX.bind(l,"click",BX.proxy(this._onElementClick,this))}},getSettings:function(t,e){var i=this._settings;return i[t]?i[t]:e},getFieldId:function(){return this._fieldId},getCurrentItem:function(){return this._currentItem},setCurrentItemId:function(t,e){var i=null;for(var s in this._items){if(!this._items.hasOwnProperty(s)){continue}if(this._items[s].getId()===t){i=this._items[s]}}if(!i){return}this._currentItem=i;if(this._elem){this._elem.innerHTML=i.getTitle()}e=!!e;if(e){var n=BX.CrmInstantEditor.getDefault();if(n){n.saveFieldValue(this._fieldId,i.getId())}BX.CmrSidebarFieldSelector._synchronize(this)}},_onElementClick:function(t){var e=[];for(var i in this._items){if(!this._items.hasOwnProperty(i)){continue}var s=this._items[i].createMenuItem();if(s){e.push(s)}}BX.PopupMenu.show(this._id,this._elem,e,{offsetTop:0,offsetLeft:0});this._popupMenu=BX.PopupMenu.currentItem},handleItemChange:function(t){if(this._popupMenu&&this._popupMenu.popupWindow){this._popupMenu.popupWindow.close()}this.setCurrentItemId(t.getId(),true)}};BX.CmrSidebarFieldSelector.items={};BX.CmrSidebarFieldSelector.create=function(t,e,i,s){var n=new BX.CmrSidebarFieldSelector;n.initialize(t,e,i,s);this.items[t]=n;return n};BX.CmrSidebarFieldSelector._synchronize=function(t){var e=t.getCurrentItem();if(!e){return}var i=t.getFieldId();for(var s in this.items){if(!this.items.hasOwnProperty(s)){continue}var n=this.items[s];if(n===t){continue}if(i===n.getFieldId()){n.setCurrentItemId(e.getId(),false)}}};BX.CmrSidebarFieldSelectorItem=function(){this._id="";this._parent=null;this._settings={}};BX.CmrSidebarFieldSelectorItem.prototype={initialize:function(t,e,i){this._id=t;this._parent=e;this._settings=i},getSettings:function(t,e){var i=this._settings;return i[t]?i[t]:e},getId:function(){return this._id},getTitle:function(){return this.getSettings("text",this._id)},createMenuItem:function(){return{text:this.getTitle(),onclick:BX.proxy(this._onMenuItemClick,this)}},_onMenuItemClick:function(){if(this._parent){this._parent.handleItemChange(this)}}};BX.CmrSidebarFieldSelectorItem.create=function(t,e,i){var s=new BX.CmrSidebarFieldSelectorItem;s.initialize(t,e,i);return s};BX.CrmSidebarUserSelector=function(){this._id="";this._settings={};this._button=null;this._container=null;this.componentName="";this._componentContainer=null;this._componentObj=null;this._fieldId="";this._editor=null;this._dlg=null;this._dlgDisplayed=false;this._userInfo=null;this._userInfoProvider=null;this._enableLazyLoad=false;this._isLoaded=false;this._serviceUrl="";this._options={};this._userSelectorScriptLoaded=null};BX.CrmSidebarUserSelector.prototype={initialize:function(t,e,i,s,n){this._id=BX.type.isNotEmptyString(t)?t:"crm_sidebar_user_sel_"+Math.random();if(!BX.type.isElementNode(e)){throw"BX.CrmSidebarUserSelector: button is not defined"}this._button=e;if(!BX.type.isElementNode(i)){throw"BX.CrmSidebarUserSelector: container is not defined"}this._container=i;if(!BX.type.isNotEmptyString(s)){throw"BX.CrmSidebarUserSelector: componentName is not defined"}this.componentName=s;this._options=n?n:{};this._enableLazyLoad=this.getOption("enableLazyLoad",false);this._serviceUrl=this.getOption("serviceUrl","");if(!this._enableLazyLoad){this._componentContainer=BX(s+"_selector_content");var a="O_"+s;if(window[a]){this._componentObj=window[a];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this);this._isLoaded=true}}BX.bind(this._button,"click",BX.delegate(this._handleButtonClick,this));this._fieldId=this.getStringOption("fieldId");this._userInfoProvider=BX.CrmUserInfoProvider.getItemById(this.getStringOption("userInfoProviderId"));if(this._fieldId!==""){var r=this.getOption("editorId","");if(r!==""){var o=BX.CrmInstantEditor.items[r];if(o){this._setupEditor(o)}else{BX.addCustomEvent("CrmInstantEditorCreated",BX.delegate(this._handleEditorCreation,this))}}}},openDialog:function(){this._dlg=new BX.PopupWindow(this._id,this._button,{autoHide:true,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},content:this._componentContainer,events:{onPopupShow:BX.delegate(function(){this._dlgDisplayed=true},this),onPopupClose:BX.delegate(function(){this._dlgDisplayed=false;this._dlg.destroy()},this),onPopupDestroy:BX.delegate(function(){this._dlg=null},this)}});this._dlg.show()},closeDialog:function(){if(this._dlg){this._dlg.close()}},getSetting:function(t,e){return this._settings[t]?this._settings[t]:e},getOption:function(t,e){return this._options.hasOwnProperty(t)?this._options[t]:e},getStringOption:function(t){return BX.type.isNotEmptyString(this._options[t])?this._options[t]:""},layout:function(){this._container.href=this._userInfo?this._userInfo.getProfileUrl():"#";var t=BX.findChild(this._container,{className:"crm-detail-info-resp-name"},true,false);if(t){t.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getFullName():"")}var e=BX.findChild(this._container,{className:"crm-detail-info-resp-descr"},true,false);if(e){e.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getWorkPosition():"")}var i=BX.findChild(this._container,{className:"crm-detail-info-resp-img"},true,false);if(i){BX.cleanNode(i,false);i.appendChild(BX.create("IMG",{attrs:{src:this._userInfo?this._userInfo.getPhotoUrl():""}}))}},toggleDialog:function(){if(this._dlg&&this._dlgDisplayed){this.closeDialog()}else{this.openDialog()}},_handleButtonClick:function(){if(this._isLoaded){this.toggleDialog();return}if(this._enableLazyLoad&&this._serviceUrl!==""){this._userSelectorScriptLoaded=BX.delegate(this._handleUserSelectorScriptLoaded,this);BX.addCustomEvent("onAjaxSuccessFinish",this._userSelectorScriptLoaded);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:{MODE:"GET_USER_SELECTOR",NAME:this.componentName},onsuccess:BX.delegate(this._handleUserSelectorHtmlLoaded,this)})}},_handleUserSelectorHtmlLoaded:function(t){this._container.parentNode.appendChild(BX.create("DIV",{html:t}));this._isLoaded=true},_handleUserSelectorScriptLoaded:function(t){if(t["url"]!==this._serviceUrl){return}BX.removeCustomEvent("onAjaxSuccessFinish",this._userSelectorScriptLoaded);this._userSelectorScriptLoaded=null;this._componentContainer=BX(this.componentName+"_selector_content");var e="O_"+this.componentName;if(window[e]){this._componentObj=window[e];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this)}this.openDialog()},_handleUserSelect:function(t){this.closeDialog();if(!this._userInfoProvider){return}var e=this;this._userInfoProvider.getInfo(t.id,function(t){e._userInfo=t;e.layout();if(e._fieldId.length>0){var i=e._editor;if(!i){i=BX.CrmInstantEditor.getDefault()}if(i){i.saveFieldValue(e._fieldId,t.getId())}}})},_handleEditorCreation:function(t){var e=this.getOption("editorId","");if(e!==""&&t.getId()===e){this._setupEditor(t)}},_handleEditorFieldValueSaved:function(t,e){if(this._fieldId!==t||!this._userInfoProvider){return}if(this._userInfo&&this._userInfo.getId()===e){return}var i=this;this._userInfoProvider.getInfo(e,function(t){i._userInfo=t;i.layout()})},_setupEditor:function(t){if(this._editor){BX.removeCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}this._editor=t;if(this._editor){BX.addCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}}};BX.CrmSidebarUserSelector.create=function(t,e,i,s,n){var a=new BX.CrmSidebarUserSelector;a.initialize(t,e,i,s,n);return a};BX.CrmUserSearchField=function(){this._id="";this._search_input=null;this._data_input=null;this._componentName="";this._componentContainer=null;this._componentObj=null;this._dlg=null;this._dlgDisplayed=false;this._currentUser={}};BX.CrmUserSearchField.prototype={initialize:function(t,e,i,s,n){this._id=BX.type.isNotEmptyString(t)?t:"crm_user_search_field_"+Math.random();if(!BX.type.isElementNode(e)){throw"BX.CrmUserSearchField: 'search_input' is not defined!"}this._search_input=e;if(!BX.type.isElementNode(i)){throw"BX.CrmUserSearchField: 'data_input' is not defined!"}this._data_input=i;if(!BX.type.isNotEmptyString(s)){throw"BX.CrmUserSearchField: 'componentName' is not defined!"}this._componentName=s;this._componentContainer=BX(s+"_selector_content");var a="O_"+s;if(window[a]){this._componentObj=window[a];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this);this._componentObj.searchInput=e;BX.bind(e,"keyup",BX.proxy(this._handleSearchKey,this));BX.bind(e,"focus",BX.proxy(this._handleSearchFocus,this));BX.bind(document,"click",BX.delegate(this._handleExternalClick,this))}this._currentUser=n?n:{};this._adjustUser()},openDialog:function(){this._dlg=new BX.PopupWindow(this._id,this._search_input,{autoHide:false,draggable:false,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},content:this._componentContainer,events:{onPopupShow:BX.delegate(function(){this._dlgDisplayed=true},this),onPopupClose:BX.delegate(function(){this._dlgDisplayed=false;this._dlg.destroy()},this),onPopupDestroy:BX.delegate(function(){this._dlg=null},this)}});this._dlg.show()},_adjustUser:function(){this._search_input.value=this._currentUser["name"]?this._currentUser.name:"";this._data_input.value=this._currentUser["id"]?this._currentUser.id:0},closeDialog:function(){if(this._dlg){this._dlg.close()}},_handleExternalClick:function(t){if(!t){t=window.event}if(t.target!==this._search_input&&!BX.findParent(t.target,{attribute:{id:this._componentName+"_selector_content"}})){this._adjustUser();this.closeDialog()}},_handleSearchKey:function(t){if(!this._dlg||!this._dlgDisplayed){this.openDialog()}this._componentObj.search()},_handleSearchFocus:function(t){if(!this._dlg||!this._dlgDisplayed){this.openDialog()}this._componentObj._onFocus(t)},_handleUserSelect:function(t){this._currentUser=t;this._adjustUser();this.closeDialog()}};BX.CrmUserSearchField.items={};BX.CrmUserSearchField.create=function(t,e,i,s,n){var a=new BX.CrmUserSearchField;a.initialize(t,e,i,s,n);this.items[t]=a;return a};BX.CrmUserLinkField=function(){this._settings={};this._container=null;this._fieldId="";this._editor=null;this._userInfoProvider=null;this._userInfo=null};BX.CrmUserLinkField.prototype={initialize:function(t){this._settings=t?t:{};this._container=this.getSetting("container",null);if(!this._container){this._container=BX(this.getSetting("containerId",""))}if(!this._container){throw"BX.CrmUserLinkField: container is not found"}this._userInfoProvider=BX.CrmUserInfoProvider.getItemById(this.getSetting("userInfoProviderId",""));this._userInfo=this.getSetting("userInfo",null);this._fieldId=this.getSetting("fieldId","");if(this._fieldId!==""){var e=this.getSetting("editorId","");if(e!==""){var i=BX.CrmInstantEditor.items[e];if(i){this._setupEditor(i)}else{BX.addCustomEvent("CrmInstantEditorCreated",BX.delegate(this._handleEditorCreation,this))}}}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},layout:function(){this._container.href=this._userInfo?this._userInfo.getProfileUrl():"#";var t=BX.findChild(this._container,{className:"crm-detail-info-resp-name"},true,false);if(t){t.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getFullName():"")}var e=BX.findChild(this._container,{className:"crm-detail-info-resp-descr"},true,false);if(e){e.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getWorkPosition():"")}var i=BX.findChild(this._container,{className:"crm-detail-info-resp-img"},true,false);if(i){BX.cleanNode(i,false);i.appendChild(BX.create("IMG",{attrs:{src:this._userInfo?this._userInfo.getPhotoUrl():""}}))}},_handleEditorCreation:function(t){var e=this.getSetting("editorId","");if(e!==""&&t.getId()===e){this._setupEditor(t)}},_setupEditor:function(t){if(this._editor){BX.removeCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}this._editor=t;if(this._editor){BX.addCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}},_handleEditorFieldValueSaved:function(t,e){if(this._fieldId!==t||!this._userInfoProvider){return}var i=this;this._userInfoProvider.getInfo(e,function(t){i._userInfo=t;i.layout()})}};BX.CrmUserLinkField.create=function(t){var e=new BX.CrmUserLinkField;e.initialize(t);return e};BX.CrmUserInfo=function(){this._data={}};BX.CrmUserInfo.prototype={initialize:function(t){this._data=t?t:{}},getId:function(){return BX.type.isNotEmptyString(this._data["ID"])?this._data["ID"]:""},getProfileUrl:function(){return BX.type.isNotEmptyString(this._data["USER_PROFILE"])?this._data["USER_PROFILE"]:""},getFullName:function(){return BX.type.isNotEmptyString(this._data["FULL_NAME"])?this._data["FULL_NAME"]:""},getWorkPosition:function(){return BX.type.isNotEmptyString(this._data["WORK_POSITION"])?this._data["WORK_POSITION"]:""},getPhotoUrl:function(){return BX.type.isNotEmptyString(this._data["PERSONAL_PHOTO"])?this._data["PERSONAL_PHOTO"]:""}};BX.CrmUserInfo.items={};BX.CrmUserInfo.create=function(t){var e=new BX.CrmUserInfo;e.initialize(t);this.items[e.getId()]=e;return e};BX.CrmUserInfoProvider=function(){this._id="";this._settings={};this._serviceUrl="";this._items={}};BX.CrmUserInfoProvider.prototype={initialize:function(t,e){if(!BX.type.isNotEmptyString(t)){throw"BX.CrmUserInfoProvider: id is not defined"}this._id=t;this._settings=e?e:{};var i=this.getSetting("serviceUrl","");if(i===""){throw"BX.CrmUserInfoProvider: serviceUrl is not found"}this._serviceUrl=i},getId:function(){return this._id},getSetting:function(t,e){return this._settings[t]?this._settings[t]:e},getInfo:function(t,e){if(!BX.type.isString(t)){t=t.toString()}if(!BX.type.isNotEmptyString(t)){if(BX.type.isFunction(e)){e(null)}return}if(typeof this._items[t]!=="undefined"){if(BX.type.isFunction(e)){e(this._items[t])}return}var i=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"GET_USER_INFO",USER_ID:t,USER_PROFILE_URL_TEMPLATE:this.getSetting("userProfileUrlTemplate","")},onsuccess:function(s){var n=BX.CrmUserInfo.create(s["USER_INFO"]?s["USER_INFO"]:{});i._items[t]=n;if(BX.type.isFunction(e)){e(n)}},onfailure:function(t){i._showError(i.getMessage("generalError"));if(BX.type.isFunction(e)){e(null)}}})},getMessage:function(t){var e=BX.CrmUserInfoProvider.messages;return typeof e[t]!=="undefined"?e[t]:""},_showError:function(t){alert(t)}};BX.CrmUserInfoProvider.items={};BX.CrmUserInfoProvider.getItemById=function(t){return typeof this.items[t]?this.items[t]:null;

};BX.CrmUserInfoProvider.createIfNotExists=function(t,e){if(typeof this.items[t]!=="undefined"){return this.items[t]}var i=new BX.CrmUserInfoProvider;i.initialize(t,e);this.items[i.getId()]=i;return i};if(typeof BX.CrmUserInfoProvider.messages==="undefined"){BX.CrmUserInfoProvider.messages={}}BX.CrmDateLinkField=function(){this._dataElem=null;this._viewElem=null;this._settings={}};BX.CrmDateLinkField.prototype={initialize:function(t,e,i){if(!BX.type.isElementNode(t)){throw"BX.CrmDateLinkField: 'dataElem' is not defined!"}this._dataElem=t;if(BX.type.isElementNode(e)){this._viewElem=e;BX.bind(e,"click",BX.delegate(this._onViewClick,this))}else{BX.bind(t,"click",BX.delegate(this._onViewClick,this))}this._settings=i?i:{}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},_onViewClick:function(t){BX.calendar({node:this._viewElem?this._viewElem:this._dataElem,field:this._dataElem,bTime:this.getSetting("showTime",true),bSetFocus:this.getSetting("setFocusOnShow",true),callback:BX.delegate(this._onCalendarSaveValue,this)})},_onCalendarSaveValue:function(t){var e=BX.calendar.ValueToString(t,this.getSetting("showTime",true),false);this._dataElem.value=e;if(this._viewElem){this._viewElem.innerHTML=e}}};BX.CrmDateLinkField.create=function(t,e,i){var s=new BX.CrmDateLinkField;s.initialize(t,e,i);return s};BX.CrmEntityEditor=function(){this._id="";this._settings={};this._readonly=false;this._dlg=null;this._data=null;this._info=null;this._container=null;this._selector=null;this._advInfoContainer=null;this._externalRequestData=null;this._externalEventHandler=null;this._blockArea=null;this._rqLinkedInputId="";this._rqLinkedId=0;this._bdLinkedId=0};BX.CrmEntityEditor.prototype={initialize:function(t,e,i,s){this._id=BX.type.isNotEmptyString(t)?t:"CRM_ENTITY_EDITOR"+Math.random();this._settings=e?e:{};if(!i){i=this._prepareData()}if(!i){throw"BX.CrmEntityEditor: Could not find data!"}this._data=i;this._info=s?s:BX.CrmEntityInfo.create();var n=this.getSetting("entitySelectorId","");if(obCrm&&obCrm[n]){var a=this._selector=obCrm[n];a.AddOnSaveListener(BX.delegate(this._onEntitySelect,this))}var r=this._container=BX(this.getSetting("containerId",""));if(!r){throw"BX.CrmEntityEditor: Could not find field container!"}this._advInfoContainer=BX(this.getSetting("containerId","")+"_descr");BX.bind(BX.findChild(r,{className:"crm-element-item-delete"},true,false),"click",BX.delegate(this._onDeleteButtonClick,this));var o=this.getSetting("buttonChangeIgnore",false);if(!o)BX.bind(BX.findChild(r,{className:"bx-crm-edit-crm-entity-change"},true,false),"click",BX.delegate(this._onChangeButtonClick,this));var l=BX(this.getSetting("buttonAddId",""));BX.bind(l?l:BX.findChild(r,{className:"bx-crm-edit-crm-entity-add"},true,false),"click",BX.delegate(this._onAddButtonClick,this));if(this.getSetting("cardViewMode",false)){this._rqLinkedInputId=this.getSetting("rqLinkedInputId","");this._bdLinkedInputId=this.getSetting("bdLinkedInputId","");this._setRqLinkedId(this.getSetting("rqLinkedId",0),this.getSetting("bdLinkedId",0),this.getSetting("skipInitInput",false))}var d=this._info.getSetting("id","");var h,c=0;if(typeof d==="string"&&d.length>0){if(/^\d+$/.test(d))c=parseInt(d);else if(/^\w+_\d+$/.test(d))c=parseInt(d.replace(/^\w+_/,""));else c=0}else{c=parseInt(d)}if(c>0){this._data.setId(d);this.layout()}},getId:function(){return this._id},getTypeName:function(){return this.getSetting("typeName","")},getContext:function(){return this.getSetting("context","")},getCreateUrl:function(){return this.getSetting("createUrl","")},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getData:function(){return this._data},getMessage:function(t){var e=BX.CrmEntityEditor.messages;return BX.type.isNotEmptyString(e[t])?e[t]:""},openDialog:function(t,e){if(this._dlg){this._dlg.setData(this._data);this._dlg.open(t,e);return}switch(this.getTypeName()){case"CONTACT":this._dlg=BX.CrmContactEditDialog.create(this._id,this.getSetting("dialog",{}),this._data,BX.delegate(this._onSaveDialogData,this));break;case"COMPANY":this._dlg=BX.CrmCompanyEditDialog.create(this._id,this.getSetting("dialog",{}),this._data,BX.delegate(this._onSaveDialogData,this));break}if(this._dlg){this._dlg.open(t,e)}},closeDialog:function(){if(this._dlg){this._dlg.close()}},isReadOnly:function(){return this._readonly},setReadOnly:function(t){t=!!t;if(this._readonly===t){return}this._readonly=t;var e=BX.findChild(this._container,{className:"crm-element-item-delete"},true,false);if(e){e.style.display=t?"none":""}var i=BX.findChild(this._container,{className:"bx-crm-entity-buttons-wrapper"},true,false);if(i){i.style.display=t?"none":""}},_prepareData:function(t){var e=this.getTypeName();var i=this.getSetting("enableValuePrefix",false);if(e==="CONTACT"){if(t&&i)t["id"]="C_"+t["id"];return BX.CrmContactData.create(t)}if(e==="COMPANY"){if(t&&i)t["id"]="CO_"+t["id"];return BX.CrmCompanyData.create(t)}if(e==="LEAD"){if(t&&i)t["id"]="L_"+t["id"];return BX.CrmLeadData.create(t)}if(e==="DEAL"){if(t&&i)t["id"]="D_"+t["id"];return BX.CrmDealData.create(t)}if(e==="QUOTE"){if(t&&i)t["id"]="Q_"+t["id"];return BX.CrmQuoteData.create(t)}return null},_onDeleteButtonClick:function(t){if(this._readonly){return}var e=BX(this.getSetting("dataInputId",""));if(e){e.value=0}if(this.getSetting("cardViewMode",false)){var i=BX(this.getSetting("rqLinkedInputId",""));if(i)i.value=0}else{BX.cleanNode(BX.findChild(this._container,{className:"bx-crm-entity-info-wrapper"},true,false));if(this._advInfoContainer)BX.cleanNode(this._advInfoContainer)}BX.onCustomEvent("CrmEntitySelectorChangeValue",[this.getId(),this.getTypeName(),0,this])},_onChangeButtonClick:function(t){if(this._readonly){return}var e=this._selector;if(e){e.Open()}},_onAddButtonClick:function(t){if(this._readonly){return}this._data.reset();var e=this.getCreateUrl();var i=this.getContext();if(e===""||i===""){this.openDialog(BX.findChild(this._container,{className:"bx-crm-edit-crm-entity-add"},true,false),"CREATE");return}i=(i+"_"+BX.util.getRandomString(6)).toLowerCase();e=BX.util.add_url_param(e,{external_context:i});if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[i]={context:i,wnd:window.open(e)};if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this._onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}},_onExternalEvent:function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var s=BX.type.isNotEmptyString(i["entityTypeName"])?i["entityTypeName"]:"";var n=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(e==="onCrmEntityCreate"&&s===this.getTypeName()&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[n])){var a=BX.type.isBoolean(i["isCanceled"])?i["isCanceled"]:false;if(!a){var r=BX.type.isPlainObject(i["entityInfo"])?i["entityInfo"]:{};this._data=this._prepareData(r);this._info=BX.CrmEntityInfo.create(r);var o=BX(this.getSetting("newDataInputId",""));if(o){o.value=this._data.getId();BX.onCustomEvent("CrmEntitySelectorChangeValue",[this.getId(),this.getTypeName(),this._data.getId(),this])}this.layout()}if(this._externalRequestData[n]["wnd"]){this._externalRequestData[n]["wnd"].close()}delete this._externalRequestData[n]}},_onSaveDialogData:function(t){this._data=this._dlg.getData();var e=this.getSetting("serviceUrl","");var i=this.getSetting("actionName","");if(!(BX.type.isNotEmptyString(e)&&BX.type.isNotEmptyString(i))){return}var s=this;BX.ajax({url:e,method:"POST",dataType:"json",data:{ACTION:i,DATA:this._data.toJSON()},onsuccess:function(t){if(t["ERROR"]){s._showDialogError(t["ERROR"])}else if(!t["DATA"]){s._showDialogError("BX.CrmEntityEditor: Could not find contact data!")}else{s._data=s._prepareData(t["DATA"]);s._info=BX.CrmEntityInfo.create(t["INFO"]?t["INFO"]:{});var e=BX(s.getSetting("newDataInputId",""));if(e){e.value=s._data.getId();BX.onCustomEvent("CrmEntitySelectorChangeValue",[s.getId(),s.getTypeName(),s._data.getId(),s])}s.layout(function(t){t.closeDialog()}(s))}},onfailure:function(t){s._showDialogError(t["ERROR"]?t["ERROR"]:s.getMessage("unknownError"))}})},layout:function(t){var e=BX(this.getSetting("dataInputId",""));if(e){e.value=this._data.getId()}var i=this.getSetting("cardViewMode",false);if(i){var s=BX(this.getSetting("rqLinkedInputId",""));if(s)s.value=this._rqLinkedId;var n=BX(this.getSetting("bdLinkedInputId",""));if(n)n.value=this._bdLinkedId}if(i&&this._advInfoContainer){if(this._blockArea){var a=this;this._blockArea.destroy(function(){a._continueLayout(t)})}else{this._continueLayout(t)}}else{var r=BX.findChild(this._container,{className:"bx-crm-entity-info-wrapper"},true,false);if(!r){return}BX.cleanNode(r);r.appendChild(BX.create("A",{attrs:{className:"bx-crm-entity-info-link",href:this._info.getSetting("url",""),target:"_blank"},text:this._info.getSetting("title",this._data.getId())}));r.appendChild(BX.create("SPAN",{attrs:{className:"crm-element-item-delete"},events:{click:BX.delegate(this._onDeleteButtonClick,this)}}));if(this._advInfoContainer){this._advInfoContainer.innerHTML=this._prepareAdvInfoHTML()}if(typeof t==="function")t(t)}},_continueLayout:function(t){this._blockArea=null;this._blockArea=new BX.Crm.EntityEditorBlockAreaClass({editor:this,container:this._advInfoContainer,nextNode:null,entityInfoList:[this._info],readOnlyMode:this.isReadOnly(),closeBlockHandler:BX.delegate(this._onDeleteButtonClick,this),changeSelectedRequisiteHandler:BX.delegate(this._onChangeSelectedRequisite,this),changeLinkedRequisiteHandler:BX.delegate(this._onChangeLinkedRequisite,this),rqLinkedId:this._rqLinkedId,bdLinkedId:this._bdLinkedId});if(typeof t==="function")t()},_onEntitySelect:function(t){var e=this.getTypeName().toLowerCase();var i=t[e]&&t[e][0]?t[e][0]:null;var s=this.getSetting("cardViewMode",false);if(!i){if(s&&this._advInfoContainer&&this._blockArea)this._blockArea.destroy();return}this._data.setId(i["id"]);this._info=BX.CrmEntityInfo.create(i);this._setRqLinkedId(0,0);var n=this;this.layout(function(){BX.onCustomEvent("CrmEntitySelectorChangeValue",[n.getId(),n.getTypeName(),i["id"],n])})},_showDialogError:function(t){if(this._dlg){this._dlg.showError(t)}},_prepareAdvInfoHTML:function(){var t="";var e,i,s;var n="";var a=[],r=[];e=this._info.getSetting("type",null);if(e){i=this._info.getSetting("advancedInfo",null);if(i){if(i["contactType"]&&i["contactType"]["name"]&&typeof i["contactType"]["name"]==="string"){n=BX.util.trim(i["contactType"]["name"])}if(i["multiFields"]&&i["multiFields"]instanceof Array){var o=i["multiFields"];for(s=0;s<o.length;s++){if(o[s]["TYPE_ID"]&&o[s]["TYPE_ID"]==="PHONE"){a.push({VALUE:BX.util.trim(o[s]["VALUE"])})}if(o[s]["TYPE_ID"]&&o[s]["TYPE_ID"]==="EMAIL"){r.push({VALUE:BX.util.trim(o[s]["VALUE"])})}}}switch(e){case"contact":if(a.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-tel">'+this.getMessage("prefPhone")+": "+BX.util.htmlspecialchars(a[0]["VALUE"])+'<a href="callto:'+BX.util.htmlspecialchars(a[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}if(r.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-imail">'+this.getMessage("prefEmail")+": "+BX.util.htmlspecialchars(r[0]["VALUE"])+'<a href="mailto:'+BX.util.htmlspecialchars(r[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}if(n){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-type">'+this.getMessage("prefContactType")+": "+BX.util.htmlspecialchars(n)+"</span><br/>"}break;case"company":case"lead":if(a.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-tel">'+this.getMessage("prefPhone")+": "+BX.util.htmlspecialchars(a[0]["VALUE"])+'<a href="callto:'+BX.util.htmlspecialchars(a[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}if(r.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-imail">'+this.getMessage("prefEmail")+": "+BX.util.htmlspecialchars(r[0]["VALUE"])+'<a href="mailto:'+BX.util.htmlspecialchars(r[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}break}}}return t},_onChangeSelectedRequisite:function(t,e,i,s){t=parseInt(t);e=parseInt(e);i=parseInt(i);s=parseInt(s);if(s<0||isNaN(s))s=0;var n,a,r,o;if(t>0&&e>0&&i>0){o=parseInt(this._info.getSetting("id",0));if(o===e){a=this._info.getSetting("advancedInfo",null);if(BX.type.isPlainObject(a)&&BX.type.isArray(a["requisiteData"])){r=a["requisiteData"];for(n=0;n<r.length;n++){if(r[n]["selected"]=t===parseInt(r[n]["entityTypeId"])&&e===parseInt(r[n]["entityId"])&&i===parseInt(r[n]["requisiteId"])){r[n]["bankDetailIdSelected"]=s}}}}}},_onChangeLinkedRequisite:function(t,e){this._setRqLinkedId(t,e)},_setRqLinkedId:function(t,e,i){i=!!i;if(this.getSetting("cardViewMode",false)){var s;this._rqLinkedId=parseInt(t);if(this._rqLinkedId<0||isNaN(this._rqLinkedId))this._rqLinkedId=0;if(!i){s=BX(this._rqLinkedInputId);if(s)s.value=this._rqLinkedId}this._bdLinkedId=parseInt(e);if(this._bdLinkedId<0||isNaN(this._bdLinkedId))this._bdLinkedId=0;if(!i){s=BX(this._bdLinkedInputId);if(s)s.value=this._bdLinkedId}}}};if(typeof BX.CrmEntityEditor.messages==="undefined"){BX.CrmEntityEditor.messages={}}BX.CrmEntityEditor.items={};BX.CrmEntityEditor.create=function(t,e,i,s){var n=new BX.CrmEntityEditor;n.initialize(t,e,i,s);this.items[t]=n;return n};BX.CrmContactEditDialog=function(){this._id="";this._settings={};this._dlg=null;this._dlgCfg={};this._data=null;this._mode="CREATE";this._onSaveCallback=null};BX.CrmContactEditDialog.prototype={initialize:function(t,e,i,s){this._id=BX.type.isNotEmptyString(t)?t:"CRM_CONTACT_EDIT_DIALOG_"+Math.random();this._settings=e?e:{};this._data=i?i:BX.CrmContactData.create();this._onSaveCallback=BX.type.isFunction(s)?s:null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getData:function(){return this._data},setData:function(t){this._data=t?t:BX.CrmContactData.create()},isOpened:function(){return this._dlg&&this._dlg.isShown()},open:function(t,e){if(!BX.type.isNotEmptyString(e)||e!=="CREATE"&&e!=="EDIT"){e=this._mode}if(this._dlg&&this._mode===e){if(!this._dlg.isShown()){this._dlg.show()}return}if(this._mode!==e){this._mode=e}var i=this._dlgCfg={};i["id"]=this._id;this._dlg=new BX.PopupWindow(i["id"],t,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:{content:BX.CrmPopupWindowHelper.prepareTitle(this.getSetting("title","New contact"))},events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this._prepareContent(),buttons:this._prepareButtons()});this._dlg.show()},close:function(){if(this._dlg){this._dlg.close()}},showError:function(t){var e=BX(this._getElementId("errors"));if(e){e.innerHTML=t;e.style.display=""}},_onPopupClose:function(){this._dlg.destroy()},_onPopupDestroy:function(){this._dlg=null},_prepareContent:function(){var t=BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-popup"}});var e=this._data;t.appendChild(BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-error-wrap",style:"display:none"},props:{id:this._getElementId("errors")}}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("lastName"),title:this.getSetting("lastNameTitle","Last Name"),value:e.getLastName()}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("name"),title:this.getSetting("nameTitle","Name"),value:e.getName()}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("secondName"),title:this.getSetting("secondNameTitle","Second Name"),value:e.getSecondName()}));if(this.getSetting("enableEmail",true)){t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("email"),title:this.getSetting("emailTitle","E-mail"),value:e.getEmail()}))}if(this.getSetting("enablePhone",true)){t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("phone"),title:this.getSetting("phoneTitle","Phone"),value:e.getPhone()}))}if(this.getSetting("enableExport",true)){if(this._mode==="CREATE"){e.markAsExportable(true)}t.appendChild(BX.CrmPopupWindowHelper.prepareCheckBoxField({id:this._getElementId("export"),title:this.getSetting("exportTitle","Enable Export"),value:e.isExportable()}))}return t},_prepareButtons:function(){return BX.CrmPopupWindowHelper.prepareButtons([{type:"button",settings:{text:this.getSetting("addButtonName","Add"),className:"popup-window-button-accept",events:{click:BX.delegate(this._onSaveButtonClick,this)}}},{type:"link",settings:{text:this.getSetting("cancelButtonName","Cancel"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}}}])},_getElementId:function(t){return this._dlgCfg["id"]+"_"+t},_onSaveButtonClick:function(){this._data.setLastName(BX(this._getElementId("lastName")).value);this._data.setName(BX(this._getElementId("name")).value);this._data.setSecondName(BX(this._getElementId("secondName")).value);if(this.getSetting("enableEmail",true)){this._data.setEmail(BX(this._getElementId("email")).value)}if(this.getSetting("enablePhone",true)){this._data.setPhone(BX(this._getElementId("phone")).value)}if(this.getSetting("enableExport",true)){this._data.markAsExportable(BX(this._getElementId("export")).checked)}if(this._onSaveCallback){this._onSaveCallback(this)}}};BX.CrmContactEditDialog.create=function(t,e,i,s){var n=new BX.CrmContactEditDialog;n.initialize(t,e,i,s);return n};BX.CrmCompanyEditDialog=function(){this._id="";this._settings={};this._dlg=null;this._dlgCfg={};this._data=null;this._mode="CREATE";this._onSaveCallback=null};BX.CrmCompanyEditDialog.prototype={initialize:function(t,e,i,s){this._id=BX.type.isNotEmptyString(t)?t:"CRM_COMPANY_EDIT_DIALOG_"+Math.random();this._settings=e?e:{};this._data=i?i:BX.CrmCompanyData.create();this._onSaveCallback=BX.type.isFunction(s)?s:null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getData:function(){return this._data},setData:function(t){this._data=t?t:BX.CrmCompanyData.create()},isOpened:function(){return this._dlg&&this._dlg.isShown()},open:function(t,e){if(!BX.type.isNotEmptyString(e)||e!=="CREATE"&&e!=="EDIT"){e=this._mode}if(this._dlg&&this._mode===e){this._dlg.setContent(this._prepareContent());if(!this._dlg.isShown()){this._dlg.show()}return}if(this._mode!==e){this._mode=e}var i=this._dlgCfg={};i["id"]=this._id;this._dlg=new BX.PopupWindow(i["id"],t,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:{content:BX.CrmPopupWindowHelper.prepareTitle(this.getSetting("title","New contact"))},events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this._prepareContent(),buttons:this._prepareButtons()});this._dlg.show()},close:function(){if(this._dlg){this._dlg.close()}},showError:function(t){var e=BX(this._getElementId("errors"));if(e){e.innerHTML=t;e.style.display=""}},_onPopupClose:function(){this._dlg.destroy()},_onPopupDestroy:function(){this._dlg=null},_prepareContent:function(){var t=BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-popup"}});var e=this._data;t.appendChild(BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-error-wrap",style:"display:none"},props:{id:this._getElementId("errors")}}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("title"),title:this.getSetting("titleTitle","Title"),value:e.getTitle()}));t.appendChild(BX.CrmPopupWindowHelper.prepareSelectField({id:this._getElementId("companyType"),title:this.getSetting("companyTypeTitle","Company Type"),value:e.getCompanyType(),items:this.getSetting("companyTypeItems",null)}));t.appendChild(BX.CrmPopupWindowHelper.prepareSelectField({id:this._getElementId("industry"),title:this.getSetting("industryTitle","Industry"),value:e.getIndustry(),items:this.getSetting("industryItems",null)}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("email"),title:this.getSetting("emailTitle","E-mail"),value:e.getEmail()}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("phone"),title:this.getSetting("phoneTitle","Phone"),value:e.getPhone()}));return t},_prepareButtons:function(){return BX.CrmPopupWindowHelper.prepareButtons([{type:"button",settings:{text:this.getSetting("addButtonName","Add"),className:"popup-window-button-accept",events:{click:BX.delegate(this._onSaveButtonClick,this)}}},{type:"link",settings:{text:this.getSetting("cancelButtonName","Cancel"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}}}])},_getElementId:function(t){return this._dlgCfg["id"]+"_"+t},_onSaveButtonClick:function(){this._data.setTitle(BX(this._getElementId("title")).value);this._data.setCompanyType(BX(this._getElementId("companyType")).value);this._data.setIndustry(BX(this._getElementId("industry")).value);this._data.setEmail(BX(this._getElementId("email")).value);this._data.setPhone(BX(this._getElementId("phone")).value);if(this._onSaveCallback){this._onSaveCallback(this)}}};BX.CrmCompanyEditDialog.create=function(t,e,i,s){var n=new BX.CrmCompanyEditDialog;n.initialize(t,e,i,s);return n};BX.CrmContactData=function(){this._id=0;this._name=this._secondName=this._lastName=this._email=this._phone="";this._export=null};BX.CrmContactData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["name"]){this.setName(t["name"])}if(t["secondName"]){this.setSecondName(t["secondName"])}if(t["lastName"]){this.setLastName(t["lastName"])}if(t["email"]){this.setEmail(t["email"])}if(t["phone"]){this.setPhone(t["phone"])}if(t["export"]){this.markAsExportable(t["export"])}},reset:function(){this._id=0;this._name=this._secondName=this._lastName=this._email=this._phone="";this._export=null},getId:function(){return this._id},setId:function(t){this._id=t},getName:function(){return this._name},setName:function(t){this._name=BX.type.isNotEmptyString(t)?t:""},getSecondName:function(){return this._secondName},setSecondName:function(t){this._secondName=BX.type.isNotEmptyString(t)?t:""},getLastName:function(){return this._lastName},setLastName:function(t){this._lastName=BX.type.isNotEmptyString(t)?t:""},getEmail:function(){return this._email},setEmail:function(t){this._email=BX.type.isNotEmptyString(t)?t:""},getPhone:function(){return this._phone},setPhone:function(t){this._phone=BX.type.isNotEmptyString(t)?t:""},isExportable:function(){return!!this._export},markAsExportable:function(t){this._export=!!t},toJSON:function(){var t={id:this._id,name:this._name,secondName:this._secondName,lastName:this._lastName,email:this._email,phone:this._phone};if(this._export!==null){t["export"]=this._export?"Y":"N"}return t}};BX.CrmContactData.create=function(t){var e=new BX.CrmContactData;e.initialize(t);return e};BX.CrmCompanyData=function(){this._id=0;this._title=this._companyType=this._industry=this._email=this._phone=this._addressLegal=""};BX.CrmCompanyData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["companyType"]){this.setCompanyType(t["companyType"])}if(t["industry"]){this.setIndustry(t["industry"])}if(t["email"]){this.setEmail(t["email"])}if(t["phone"]){this.setPhone(t["phone"])}},reset:function(){this._id=0;this._title=this._companyType=this._industry=this._email=this._phone=this._addressLegal=""},getId:function(){return this._id},setId:function(t){this._id=t},getTitle:function(){return this._title},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},getCompanyType:function(){return this._companyType},setCompanyType:function(t){this._companyType=BX.type.isNotEmptyString(t)?t:""},getIndustry:function(){return this._industry},setIndustry:function(t){this._industry=BX.type.isNotEmptyString(t)?t:""},getEmail:function(){return this._email},setEmail:function(t){this._email=BX.type.isNotEmptyString(t)?t:""},getPhone:function(){return this._phone},setPhone:function(t){this._phone=BX.type.isNotEmptyString(t)?t:""},getAddressLegal:function(){return this._addressLegal},setAddressLegal:function(t){this._addressLegal=BX.type.isNotEmptyString(t)?t:""},toJSON:function(){return{id:this.id,title:this._title,companyType:this._companyType,industry:this._industry,email:this._email,phone:this._phone}}};BX.CrmCompanyData.create=function(t){var e=new BX.CrmCompanyData;e.initialize(t);return e};BX.CrmLeadData=function(){this._id=0;this._title=this._name=this._secondName=this._lastName=this._email=this._phone=""};BX.CrmLeadData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["name"]){this.setName(t["name"])}if(t["secondName"]){this.setSecondName(t["secondName"])}if(t["lastName"]){this.setLastName(t["lastName"])}if(t["email"]){this.setEmail(t["email"])}if(t["phone"]){this.setPhone(t["phone"])}},reset:function(){this._id=0;this._name=this._secondName=this._lastName=this._email=this._phone=""},getId:function(){return this._id},setId:function(t){this._id=t},getName:function(){return this._name},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},setName:function(t){this._name=BX.type.isNotEmptyString(t)?t:""},getSecondName:function(){return this._secondName},setSecondName:function(t){this._secondName=BX.type.isNotEmptyString(t)?t:""},getLastName:function(){return this._lastName},setLastName:function(t){this._lastName=BX.type.isNotEmptyString(t)?t:""},getEmail:function(){return this._email},setEmail:function(t){this._email=BX.type.isNotEmptyString(t)?t:""},getPhone:function(){return this._phone},setPhone:function(t){this._phone=BX.type.isNotEmptyString(t)?t:""},toJSON:function(){return{id:this._id,name:this._name,secondName:this._secondName,lastName:this._lastName,email:this._email,phone:this._phone}}};BX.CrmLeadData.create=function(t){var e=new BX.CrmLeadData;e.initialize(t);return e};BX.CrmDealData=function(){this._id=this._dealPrice=0;this._title=this._dealType=""};BX.CrmDealData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["dealType"]){this.setDealType(t["dealType"])}if(t["dealPrice"]){this.setDealType(t["dealPrice"])}},reset:function(){this._id=this._dealPrice=0;this._title=this._dealType=""},getId:function(){return this._id},setId:function(t){this._id=t},getTitle:function(){return this._title},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},getDealType:function(){return this._dealType},setDealType:function(t){this._dealType=BX.type.isNotEmptyString(t)?t:""},getDealPrice:function(){return this._dealPrice},setDealPrice:function(t){this._dealPrice=BX.type.isNumber(t)?t:0}};BX.CrmDealData.create=function(t){var e=new BX.CrmDealData;e.initialize(t);return e};BX.CrmQuoteData=function(){this._id=this._quotePrice=0;this._title=this._quoteType=""};BX.CrmQuoteData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["quoteType"]){this.setQuoteType(t["quoteType"])}if(t["quotePrice"]){this.setQuoteType(t["quotePrice"])}},reset:function(){this._id=this._quotePrice=0;this._title=this._quoteType=""},getId:function(){return this._id},setId:function(t){this._id=t},getTitle:function(){return this._title},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},getQuoteType:function(){return this._quoteType},setQuoteType:function(t){this._quoteType=BX.type.isNotEmptyString(t)?t:""},getQuotePrice:function(){return this._quotePrice},setQuotePrice:function(t){this._quotePrice=BX.type.isNumber(t)?t:0}};BX.CrmQuoteData.create=function(t){var e=new BX.CrmQuoteData;e.initialize(t);return e};BX.CrmEntityInfo=function(){this._settings={}};BX.CrmEntityInfo.prototype={initialize:function(t){this._settings=t?t:{}},getSetting:function(t,e){return this._settings[t]?this._settings[t]:e}};BX.CrmEntityInfo.create=function(t){var e=new BX.CrmEntityInfo;e.initialize(t);return e};BX.CrmPopupWindowHelper={};BX.CrmPopupWindowHelper.prepareButtons=function(t){var e=[];for(var i=0;i<t.length;i++){var s=t[i];e.push(s["type"]==="link"?new BX.PopupWindowButtonLink(s["settings"]):new BX.PopupWindowButton(s["settings"]))}return e};BX.CrmPopupWindowHelper.prepareTextField=function(t){return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-title"},text:t["title"]+":"}),BX.create("INPUT",{attrs:{className:"bx-crm-dialog-quick-create-field-text-input"},props:{id:t["id"],value:t["value"]}})]})};BX.CrmPopupWindowHelper.prepareSelectField=function(t){var e=BX.create("SELECT",{attrs:{className:"bx-crm-dialog-quick-create-field-select"},props:{id:t["id"]}});var i=t["value"]?t["value"]:"";if(t["items"]){for(var s=0;s<t["items"].length;s++){var n=t["items"][s];var a=n["value"]?n["value"]:s.toString();var r=BX.create("OPTION",{text:n["text"]?n["text"]:a,props:{value:a}});if(!BX.browser.isIE){e.add(r,null)}else{try{e.add(r,e.options[null])}catch(o){e.add(r,null)}}if(a===i){r.selected=true}}}return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-title"},text:t["title"]+":"}),e]})};BX.CrmPopupWindowHelper.prepareTextAreaField=function(t){return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-title"},text:t["title"]+":"}),BX.create("TEXTAREA",{attrs:{className:"bx-crm-dialog-quick-create-field-text-input"},props:{id:t["id"]},text:t["value"]})]})};BX.CrmPopupWindowHelper.prepareCheckBoxField=function(t){var e=BX.create("INPUT",{attrs:{className:"bx-crm-dialog-quick-create-field-checkbox"},props:{id:t["id"],type:"checkbox",checked:!!t["value"]?"checked":""}});if(!!t["value"]){e.checked=true}return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("LABEL",{attrs:{className:"bx-crm-dialog-quick-create-field-checkbox-label"},children:[e,BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-checkbox-label-text"},text:t["title"]})]})]})};BX.CrmPopupWindowHelper.prepareTitle=function(t){return BX.create("DIV",{attrs:{className:"bx-crm-dialog-tittle-wrap"},children:[BX.create("SPAN",{text:t,props:{className:"bx-crm-dialog-title-text"}})]})};BX.CrmEntityDetailViewDialog=function(){this._id="";this._dlg=null;this._settings={}};BX.CrmEntityDetailViewDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_ENTITY_DETAIL_VIEW_DIALOG_"+Math.random();this._settings=e?e:{}},getId:function(){return this._id},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},isOpened:function(){return this._dlg&&this._dlg.isShown()},open:function(){if(this._dlg){if(!this._dlg.isShown()){this._dlg.show()}return}var t=BX(this.getSetting("containerId"));if(!t){t=BX.findChild(BX("sidebar"),{"class":"crm-entity-info-details-container"},true,false)}this._dlg=new BX.PopupWindow(this._id,null,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:{content:BX.CrmPopupWindowHelper.prepareTitle(this.getSetting("title","Details"))},events:{onAfterPopupShow:BX.delegate(this._onAfterPopupShow,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:t});this._dlg.show()},close:function(){if(this._dlg&&this._dlg.isShown()){this._dlg.close()}},toggle:function(){this.isOpened()?this.close():this.open();

},_onAfterPopupShow:function(){var t=BX.findChild(BX("sidebar"),{"class":"sidebar-block"},true,false);if(!t){return}var e=BX.pos(t);var i=this._dlg.popupContainer;if(!i){return}var s=BX.pos(i);i.style.top=e.top.toString()+"px";i.style.left=(e.left-s.width-1).toString()+"px"},_onPopupDestroy:function(){this._dlg=null}};BX.CrmEntityDetailViewDialog.items={};BX.CrmEntityDetailViewDialog.create=function(t,e){var i=new BX.CrmEntityDetailViewDialog;i.initialize(t,e);this.items[i.getId()]=i;return i};BX.CrmEntityDetailViewDialog.ensureCreated=function(t,e){return typeof this.items[t]!=="undefined"?this.items[t]:this.create(t,e)};BX.CrmContactEditor=function(){this._id="";this._settings={};this._dlg=null;this._clientField=null;this._mode="CREATE"};BX.CrmContactEditor.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};var i=this.getSetting("data",null);if(i){this._mode="EDIT"}else{i={};this._mode="CREATE"}this._data=BX.CrmContactData.create(i)},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},openDialog:function(t){if(this._dlg){this._dlg.setData(this._data);this._dlg.open(t);return}this._dlg=BX.CrmContactEditDialog.create(this._id,this.getSetting("dialog",{}),this._data,BX.delegate(this._onSaveDialogData,this));if(this._dlg){this._dlg.open(t,this._mode)}},closeDialog:function(){if(this._dlg){this._dlg.close()}},openExternalFieldEditor:function(t){this._clientField=t;this.openDialog()},_onSaveDialogData:function(t){this._data=this._dlg.getData();var e=this.getSetting("serviceUrl","");var i=this.getSetting("actionName","");if(!(BX.type.isNotEmptyString(e)&&BX.type.isNotEmptyString(i))){return}var s=this;BX.ajax({url:e,method:"POST",dataType:"json",data:{ACTION:i,DATA:this._data.toJSON(),NAME_TEMPLATE:this.getSetting("nameTemplate","")},onsuccess:function(t){if(t["ERROR"]){s._showDialogError(t["ERROR"])}else if(!t["DATA"]){s._showDialogError("BX.CrmContactEditor: Could not find contact data!")}else{s._data=BX.CrmContactData.create(t["DATA"]);var e=t["INFO"]?t["INFO"]:{};s._clientField.setFieldValue(BX.type.isNotEmptyString(e["title"])?BX.util.htmlspecialchars(e["title"]):"");s.closeDialog()}},onfailure:function(t){s._showDialogError(t["ERROR"]?t["ERROR"]:s.getMessage("unknownError"))}})},_showDialogError:function(t){if(this._dlg){this._dlg.showError(t)}}};BX.CrmContactEditor.create=function(t,e){var i=new BX.CrmContactEditor;i.initialize(t,e);return i};BX.CrmSonetSubscription=function(){this._id="";this._settings={}};BX.CrmSonetSubscription.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},enableSubscription:function(t,e,i){var s=this.getSetting("serviceUrl","");var n=this.getSetting("actionName","");if(!(BX.type.isNotEmptyString(s)&&BX.type.isNotEmptyString(n))){return}var a=this.getSetting("reload",false);BX.ajax({url:s,method:"POST",dataType:"json",data:{ACTION:n,ENTITY_TYPE:this.getSetting("entityType",""),ENTITY_ID:t,ENABLE:e?"Y":"N"},onsuccess:function(t){if(BX.type.isFunction(i)){i()}},onfailure:function(t){}})},subscribe:function(t,e){this.enableSubscription(t,true,e)},unsubscribe:function(t,e){this.enableSubscription(t,false,e)}};BX.CrmSonetSubscription.items={};BX.CrmSonetSubscription.create=function(t,e){var i=new BX.CrmSonetSubscription;i.initialize(t,e);this.items[t]=i;return i};if(typeof BX.CrmFormTabLazyLoader=="undefined"){BX.CrmFormTabLazyLoader=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._serviceUrl="";this._formId="";this._tabId="";this._params={};this._formManager=null;this._isRequestRunning=false;this._isLoaded=false;this._waiter=null;this._scrollHandler=BX.delegate(this._onWindowScroll,this);this._formManagerHandler=BX.delegate(this._onFormManagerCreate,this)};BX.CrmFormTabLazyLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_lf_disp_"+Math.random().toString().substring(2);this._settings=e?e:{};this._container=BX(this.getSetting("containerID",""));if(!this._container){throw"Error: Could not find container."}this._wrapper=BX.findParent(this._container,{tagName:"DIV",className:"bx-edit-tab-inner"});this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"Error. Could not find service url."}this._formId=this.getSetting("formID","");if(!BX.type.isNotEmptyString(this._formId)){throw"Error: Could not find form id."}this._tabId=this.getSetting("tabID","");if(!BX.type.isNotEmptyString(this._tabId)){throw"Error: Could not find tab id."}this._params=this.getSetting("params",{});var i=window["bxForm_"+this._formId];if(i){this.setFormManager(i)}else{BX.addCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler)}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},load:function(){if(this._isLoaded){return}var t=this._params;t["FORM_ID"]=this._formId;t["TAB_ID"]=this._tabId;this._startRequest(t)},getContainerRect:function(){var t=this._container.getBoundingClientRect();return{top:t.top,bottom:t.bottom,left:t.left,right:t.right,width:typeof t.width!=="undefined"?t.width:t.right-t.left,height:typeof t.height!=="undefined"?t.height:t.bottom-t.top}},isContanerInClientRect:function(){return this.getContainerRect().top<=document.documentElement.clientHeight},setFormManager:function(t){if(this._formManager===t){return}this._formManager=t;if(!this._formManager){return}if(this._formManager.GetActiveTabId()!==this._tabId){BX.addCustomEvent(window,"BX_CRM_INTERFACE_FORM_TAB_SELECTED",BX.delegate(this._onFormTabSelect,this))}else{if(this.isContanerInClientRect()){this.load()}else{BX.bind(window,"scroll",this._scrollHandler)}}},_startRequest:function(t){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._waiter=BX.showWait(this._container);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:{LOADER_ID:this._id,PARAMS:t},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)});return true},_onRequestSuccess:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}this._container.innerHTML=t;this._isLoaded=true},_onRequestFailure:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}this._isLoaded=true},_onFormManagerCreate:function(t){if(t["name"]===this._formId){BX.removeCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler);this.setFormManager(t)}},_onFormTabSelect:function(t,e,i,s){if(this._formId===e&&(i===this._tabId||this._wrapper===s)){this.load()}},_onWindowScroll:function(t){if(!this._isLoaded&&!this._isRequestRunning&&this.isContanerInClientRect()){BX.unbind(window,"scroll",this._scrollHandler);this.load()}}};BX.CrmFormTabLazyLoader.items={};BX.CrmFormTabLazyLoader.create=function(t,e){var i=new BX.CrmFormTabLazyLoader;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmCustomDragItem==="undefined"){BX.CrmCustomDragItem=function(){this._id="";this._settings={};this._node=null;this._ghostNode=null;this._ghostOffset={x:0,y:0};this._enableDrag=true;this._isInDragMode=false;this._dragNotifier=null;this._bodyOverflow=""};BX.CrmCustomDragItem.prototype={initialize:function(t,e){if(typeof jsDD==="undefined"){throw"CrmCustomDragItem: Could not find jsDD API."}this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(8);this._settings=e?e:{};this._node=this.getSetting("node");if(!this._node){throw"CrmCustomDragItem: The 'node' parameter is not defined in settings or empty."}this._enableDrag=this.getSetting("enableDrag",true);this._ghostOffset=this.getSetting("ghostOffset",{x:0,y:0});this._dragNotifier=BX.CrmNotifier.create(this);this.doInitialize();this.bindEvents()},doInitialize:function(){},release:function(){this.doRelease();this.unbindEvents()},doRelease:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},bindEvents:function(){this._node.onbxdragstart=BX.delegate(this._onDragStart,this);this._node.onbxdrag=BX.delegate(this._onDrag,this);this._node.onbxdragstop=BX.delegate(this._onDragStop,this);this._node.onbxdragrelease=BX.delegate(this._onDragRelease,this);jsDD.registerObject(this._node);this.doBindEvents()},doBindEvents:function(){},unbindEvents:function(){delete this._node.onbxdragstart;delete this._node.onbxdrag;delete this._node.onbxdragstop;delete this._node.onbxdragrelease;if(BX.type.isFunction(jsDD.unregisterObject)){jsDD.unregisterObject(this._node)}this.doUnbindEvents()},doUnbindEvents:function(){},createGhostNode:function(){throw"CrmCustomDragItem: The 'createGhostNode' function is not implemented."},getGhostNode:function(){return this._ghostNode},removeGhostNode:function(){throw"CrmCustomDragItem: The 'removeGhostNode' function is not implemented."},processDragStart:function(){},processDrag:function(t,e){},processDragStop:function(){},addDragListener:function(t){this._dragNotifier.addListener(t)},removeDragListener:function(t){this._dragNotifier.removeListener(t)},getContextId:function(){return""},getContextData:function(){return{}},getScrollTop:function(){var t=document.documentElement;var e=document.body;var i=t.scrollTop||e&&e.scrollTop||0;i-=t.clientTop;return i},isDragDropBinEnabled:function(){return true},_onDragStart:function(){if(!this._enableDrag){return}this.createGhostNode();var t=BX.pos(this._node);this._ghostNode.style.top=t.top+"px";this._ghostNode.style.left=t.left+"px";this._isInDragMode=true;BX.CrmCustomDragItem.currentDragged=this;BX.onCustomEvent("CrmDragItemDragStart",[this]);this.processDragStart();window.setTimeout(BX.delegate(this._prepareDocument,this),0)},_onDrag:function(t,e){if(!this._isInDragMode){return}if(this._ghostNode){this._ghostNode.style.top=e+this._ghostOffset.y+"px";this._ghostNode.style.left=t+this._ghostOffset.x+"px"}var i=this.getScrollTop();if(i>0&&e<=i){window.scrollTo(0,0);return}this.processDrag(t,e);this._dragNotifier.notify([t,e])},_onDragStop:function(t,e){if(!this._isInDragMode){return}this.removeGhostNode();this._isInDragMode=false;if(BX.CrmCustomDragItem.currentDragged===this){BX.CrmCustomDragItem.currentDragged=null}BX.onCustomEvent("CrmDragItemDragStop",[this]);this.processDragStop();window.setTimeout(BX.delegate(this._resetDocument,this),0)},_onDragRelease:function(t,e){BX.onCustomEvent("CrmDragItemDragRelease",[this])},_prepareDocument:function(){this._bodyOverflow=document.body.style.overflow;document.body.style.overflow="hidden"},_resetDocument:function(){document.body.style.overflow=this._bodyOverflow}};BX.CrmCustomDragItem.currentDragged=null;BX.CrmCustomDragItem.emulateDrag=function(){jsDD.refreshDestArea();if(jsDD.current_node){jsDD.drag({clientX:jsDD.x-jsDD.wndSize.scrollLeft,clientY:jsDD.y-jsDD.wndSize.scrollTop})}}}if(typeof BX.CrmCustomDragContainer==="undefined"){BX.CrmCustomDragContainer=function(){this._id="";this._settings={};this._node=null;this._itemDragHandler=BX.delegate(this._onItemDrag,this);this._draggedItem=null;this._dragFinishNotifier=null;this._enabled=true};BX.CrmCustomDragContainer.prototype={initialize:function(t,e){if(typeof jsDD==="undefined"){throw"CrmCustomDragContainer: Could not find jsDD API."}this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(8);this._settings=e?e:{};this._node=this.getSetting("node");if(!this._node){throw"CrmCustomDragContainer: The 'node' parameter is not defined in settings or empty."}this._dragFinishNotifier=BX.CrmNotifier.create(this);this.doInitialize();this.bindEvents()},doInitialize:function(){},release:function(){this.doRelease();this.unbindEvents()},doRelease:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},bindEvents:function(){this._node.onbxdestdraghover=BX.delegate(this._onDragOver,this);this._node.onbxdestdraghout=BX.delegate(this._onDragOut,this);this._node.onbxdestdragfinish=BX.delegate(this._onDragFinish,this);this._node.onbxdragstop=BX.delegate(this._onDragStop,this);this._node.onbxdragrelease=BX.delegate(this._onDragRelease,this);jsDD.registerDest(this._node,this.getPriority());this.doBindEvents()},doBindEvents:function(){},unbindEvents:function(){delete this._node.onbxdestdraghover;delete this._node.onbxdestdraghout;delete this._node.onbxdestdragfinish;delete this._node.onbxdragstop;delete this._node.onbxdragrelease;if(BX.type.isFunction(jsDD.unregisterDest)){jsDD.unregisterDest(this._node)}this.doUnbindEvents()},doUnbindEvents:function(){},createPlaceHolder:function(t){throw"CrmCustomDragContainer: The 'createPlaceHolder' function is not implemented."},removePlaceHolder:function(){throw"CrmCustomDragContainer: The 'removePlaceHolder' function is not implemented."},initializePlaceHolder:function(t){this.createPlaceHolder(t);this.refresh()},releasePlaceHolder:function(){this.removePlaceHolder();this.refresh()},getPriority:function(){return BX.CrmCustomDragContainer.defaultPriority},addDragFinishListener:function(t){this._dragFinishNotifier.addListener(t)},removeDragFinishListener:function(t){this._dragFinishNotifier.removeListener(t)},getDraggedItem:function(){return this._draggedItem},setDraggedItem:function(t){if(this._draggedItem===t){return}if(this._draggedItem){this._draggedItem.removeDragListener(this._itemDragHandler)}this._draggedItem=t;if(this._draggedItem){this._draggedItem.addDragListener(this._itemDragHandler)}},isAllowedContext:function(t){return true},isEnabled:function(){return this._enabled},enable:function(t){t=!!t;if(this._enabled===t){return}this._enabled=t;if(t){jsDD.enableDest(this._node)}else{jsDD.disableDest(this._node)}},refresh:function(){jsDD.refreshDestArea(this._node.__bxddeid)},processDragOver:function(t){this.initializePlaceHolder(t)},processDragOut:function(){this.releasePlaceHolder()},processDragStop:function(){this.releasePlaceHolder()},processDragRelease:function(){this.releasePlaceHolder()},processItemDrop:function(){this.releasePlaceHolder()},_onDragOver:function(t,e,i){var s=BX.CrmCustomDragItem.currentDragged;if(!s){return}if(!this.isAllowedContext(s.getContextId())){return}this.setDraggedItem(s);this.processDragOver({x:e,y:i})},_onDragOut:function(t,e,i){if(!this._draggedItem){return}this.processDragOut();this.setDraggedItem(null)},_onDragFinish:function(t,e,i){if(!this._draggedItem){return}this._dragFinishNotifier.notify([this._draggedItem,e,i]);this.processItemDrop();this.setDraggedItem(null);BX.CrmCustomDragContainer.refresh()},_onDragRelease:function(t,e,i){if(!this._draggedItem){return}this.processDragRelease();this.setDraggedItem(null)},_onDragStop:function(t,e,i){if(!this._draggedItem){return}this.processDragStop();this.setDraggedItem(null)},_onItemDrag:function(t,e,i){if(!this._draggedItem){return}this.initializePlaceHolder({x:e,y:i})}};BX.CrmCustomDragContainer.defaultPriority=100;BX.CrmCustomDragContainer.refresh=function(){jsDD.refreshDestArea()}}BX.CrmDragDropBinState={suspend:0,wait:1,ready:2,open:3,close:4};if(typeof BX.CrmDragDropBin==="undefined"){BX.CrmDragDropBin=function(){this._state=BX.CrmDragDropBinState.suspend;this._chargeItem=null;this._enableChargeItem=false;this._chargeDragStartHandler=BX.delegate(this._onChargeDragStart,this);this._chargeDragStopHandler=BX.delegate(this._onChargeDragStop,this);this._chargeDragReleaseHandler=BX.delegate(this._onChargeDragRelease,this);this._chargeDragHandler=BX.delegate(this._onChargeDrag,this);this._workareaRect=null;this._promptingWrapper=null;this._closePromptingButtonId="crm_dd_bin_close_prompting_btn";this._closePromptingHandler=BX.delegate(this._onClosePromptingButtonClick,this);this._demoButtonId="crm_dd_bin_demo_btn";this._demoHandler=BX.delegate(this._onDemoButtonClick,this)};BX.extend(BX.CrmDragDropBin,BX.CrmCustomDragContainer);BX.CrmDragDropBin.prototype.doInitialize=function(){BX.addCustomEvent(window,"CrmDragItemDragStart",this._chargeDragStartHandler);BX.addCustomEvent(window,"CrmDragItemDragStop",this._chargeDragStopHandler);BX.addCustomEvent(window,"CrmDragItemDragRelease",this._chargeDragReleaseHandler);this.cacheWorkareaRect();BX.bind(window,"resize",BX.delegate(this._onWindowResize,this))};BX.CrmDragDropBin.prototype.getPriority=function(){return 10};BX.CrmDragDropBin.prototype.createPlaceHolder=function(t){};BX.CrmDragDropBin.prototype.removePlaceHolder=function(){};BX.CrmDragDropBin.prototype.processDragOver=function(t){if(this._chargeItem){this._enableChargeItem=false}this.setState(BX.CrmDragDropBinState.open)};BX.CrmDragDropBin.prototype.processDragOut=function(){if(this._chargeItem){this._enableChargeItem=true}this.setState(BX.CrmDragDropBinState.ready)};BX.CrmDragDropBin.prototype.processDragStop=function(){this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype.processDragRelease=function(){this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype.processItemDrop=function(){if(this._chargeItem){this._chargeItem.removeDragListener(this._chargeDragHandler);this._chargeItem=null}this._enableChargeItem=false;this.setState(BX.CrmDragDropBinState.close);window.setTimeout(BX.delegate(this.reset,this),1e3);BX.onCustomEvent(this,"CrmDragDropBinItemDrop",[this,this.getDraggedItem()])};BX.CrmDragDropBin.prototype.getState=function(){return this._state};BX.CrmDragDropBin.prototype.reset=function(){this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype.setState=function(t){t=parseInt(t);if(t<BX.CrmDragDropBinState.suspend||t>BX.CrmDragDropBinState.close){t=BX.CrmDragDropBinState.suspend}if(this._state===t){return}this._state=t;var e=["crm-cart-block-wrap"];if(this._state>=BX.CrmDragDropBinState.wait){e.push("crm-cart-start")}if(this._state>=BX.CrmDragDropBinState.ready){e.push("crm-cart-active")}if(this._state>=BX.CrmDragDropBinState.open){e.push("crm-cart-hover")}if(this._state===BX.CrmDragDropBinState.close){e.push("crm-cart-finish")}this._node.className=e.join(" ");window.setTimeout(BX.delegate(BX.CrmCustomDragItem.emulateDrag,this),400);window.setTimeout(BX.delegate(BX.CrmCustomDragItem.emulateDrag,this),800)};BX.CrmDragDropBin.prototype._onChargeDragStart=function(t){if(!t.isDragDropBinEnabled()){return}this._enableChargeItem=true;this._chargeItem=t;this._chargeItem.addDragListener(this._chargeDragHandler);this.setState(BX.CrmDragDropBinState.wait)};BX.CrmDragDropBin.prototype._onChargeDragStop=function(t){if(!this._enableChargeItem||this._chargeItem!==t){return}this._chargeItem.removeDragListener(this._chargeDragHandler);this._chargeItem=null;this._enableChargeItem=false;this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype._onChargeDragRelease=function(t){if(!this._enableChargeItem||this._chargeItem!==t){return}this._chargeItem.removeDragListener(this._chargeDragHandler);this._chargeItem=null;this._enableChargeItem=false;this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype._onChargeDrag=function(t,e,i){if(this._enableChargeItem&&this._chargeItem===t){this.adjust()}};BX.CrmDragDropBin.prototype._onWindowResize=function(t){this.cacheWorkareaRect()};BX.CrmDragDropBin.prototype.cacheWorkareaRect=function(){var t=BX("workarea");if(!t){t=document.documentElement}this._workareaRect=BX.pos(t);this._readyThreshold=this._workareaRect.width/6};BX.CrmDragDropBin.prototype.adjust=function(){if(!this._chargeItem){return}var t=this._chargeItem.getGhostNode();if(!t){return}var e=BX.pos(t);var i=this._state>=BX.CrmDragDropBinState.ready;if(i!==this._workareaRect.right-e.left<=this._readyThreshold){i=!i;this.setState(i?BX.CrmDragDropBinState.ready:BX.CrmDragDropBinState.wait)}};BX.CrmDragDropBin.prototype.getMessage=function(t,e){var i=BX.CrmDragDropBin.messages;return i.hasOwnProperty(t)?i[t]:e};BX.CrmDragDropBin.prototype.showPromptingIfRequired=function(t){if(BX.localStorage.get("crm_dd_bin_show_prompt")!=="N"){this.showPrompting(t)}};BX.CrmDragDropBin.prototype.showPrompting=function(t){if(this._promptingWrapper){return}var e=this.getMessage("prompting");e=e.replace("#CLOSE_BTN_ID#",this._closePromptingButtonId).replace("#DEMO_BTN_ID#",this._demoButtonId);this._promptingWrapper=BX.create("DIV",{attrs:{className:"crm-view-message"},html:e});t.appendChild(this._promptingWrapper);BX.bind(BX(this._closePromptingButtonId),"click",this._closePromptingHandler);BX.bind(BX(this._demoButtonId),"click",this._demoHandler)};BX.CrmDragDropBin.prototype.hidePrompting=function(){if(!this._promptingWrapper){return}BX.localStorage.set("crm_dd_bin_show_prompt","N",31104e3);BX.unbind(BX(this._closePromptingButtonId),"click",this._closePromptingHandler);BX.unbind(BX(this._demoButtonId),"click",this._demoHandler);BX.remove(this._promptingWrapper)};BX.CrmDragDropBin.prototype.demo=function(){this.setState(BX.CrmDragDropBinState.wait);var t=this;window.setTimeout(function(){t.setState(BX.CrmDragDropBinState.ready)},1e3);window.setTimeout(function(){t.setState(BX.CrmDragDropBinState.open)},1500);window.setTimeout(function(){t.setState(BX.CrmDragDropBinState.close)},2e3)};BX.CrmDragDropBin.prototype._onDemoButtonClick=function(t){this.demo();return BX.PreventDefault(t)};BX.CrmDragDropBin.prototype._onClosePromptingButtonClick=function(t){this.hidePrompting();return BX.PreventDefault(t)};BX.CrmDragDropBin.instance=null;BX.CrmDragDropBin.getInstance=function(){if(this.instance){return this.instance}var t=BX.create("DIV",{attrs:{className:"crm-cart-block-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-cart-block"},children:[BX.create("DIV",{attrs:{className:"crm-cart-icon"},children:[BX.create("DIV",{attrs:{className:"crm-cart-icon-top"}}),BX.create("DIV",{attrs:{className:"crm-cart-icon-body"}})]})]})]});document.body.appendChild(t);var e=new BX.CrmDragDropBin;e.initialize("default",{node:t});return this.instance=e};if(typeof BX.CrmDragDropBin.messages==="undefined"){BX.CrmDragDropBin.messages={}}}if(typeof BX.CrmLocalitySearchField==="undefined"){BX.CrmLocalitySearchField=function(){this._id="";this._settings={};this._localityType="";this._serviceUrl="";this._searchInput=null;this._dataInput=null;this._timeoutId=0;this._value="";this._items=[];this._menuId="crm-locality-search";this._menu=null;this._isRequestStarted=false;this._checkHandler=BX.delegate(this.check,this);this._keyPressHandler=BX.delegate(this.onKeyPress,this);this._menuItemClickHandler=BX.delegate(this.onMenuItemClick,this);this._searchCompletionHandler=BX.delegate(this.onSearchRequestComplete,this)};BX.CrmLocalitySearchField.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_loc_search_field_"+Math.random();this._settings=e?e:{};this._localityType=this.getSetting("localityType");if(!BX.type.isNotEmptyString(this._localityType)){throw"BX.CrmLocalitySearchField: localityType is not found!"}this._serviceUrl=this.getSetting("serviceUrl");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmLocalitySearchField: serviceUrl is not found!"}this._searchInput=this.findElement("searchInput");if(!BX.type.isElementNode(this._searchInput)){throw"BX.CrmLocalitySearchField: searchInput is not found!"}this._dataInput=this.findElement("dataInput");if(!BX.type.isElementNode(this._dataInput)){throw"BX.CrmLocalitySearchField: dataInputId is not found!"}BX.bind(this._searchInput,"keyup",BX.proxy(this._keyPressHandler,this));BX.bind(document,"click",BX.delegate(this._handleExternalClick,this))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},findElement:function(t){var e=this.getSetting(t);if(BX.type.isElementNode(t)){return e}var i=null;if(BX.type.isNotEmptyString(e)){i=BX(e);if(!i){var s=document.getElementsByName(e);if(s.length>0){i=s[0]}}}return i!==undefined?i:null},check:function(){this._timeoutId=0;if(this._value!==this._searchInput.value){this._value=this._searchInput.value;this._timeoutId=window.setTimeout(this._checkHandler,750)}else if(this._value.length>=2){this.startSearchRequest(this._value)}},startSearchRequest:function(t){if(this._isRequestStarted){return false}this._isRequestStarted=true;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"FIND_LOCALITIES",LOCALITY_TYPE:this._localityType,NEEDLE:t},onsuccess:this._searchCompletionHandler,onfailure:this._searchCompletionHandler})},showMenu:function(t){BX.PopupMenu.destroy(this._menuId);var e=[];for(var i=0;i<t.length;i++){e.push(this.prepareMenuItem(t[i]))}this._menu=BX.PopupMenu.create(this._menuId,this._searchInput,e,{offsetTop:0,offsetLeft:0});this._menu.popupWindow.show()},closeMenu:function(){BX.PopupMenu.destroy(this._menuId);this._menu=null},prepareMenuItem:function(t){var e=BX.type.isNotEmptyString(t["CODE"])?t["CODE"]:"";if(e===""){throw"BX.CrmLocalitySearchField: could not find item code!"}var i=BX.type.isNotEmptyString(t["CAPTION"])?t["CAPTION"]:e;return{value:e,text:i,onclick:this._menuItemClickHandler}},onMenuItemClick:function(t,e){this.selectItem(e);this.closeMenu()},selectItem:function(t){this._dataInput.value=t["value"];this._searchInput.value=t["text"]},onKeyPress:function(t){if(this._timeoutId!==0){window.clearTimeout(this._timeoutId);this._timeoutId=0}this._timeoutId=window.setTimeout(this._checkHandler,375)},onSearchRequestComplete:function(t){this._isRequestStarted=false;var e=typeof t["DATA"]!=="undefined"&&typeof t["DATA"]["ITEMS"]!=="undefined"?t["DATA"]["ITEMS"]:[];if(e.length>0){this.showMenu(e)}}};BX.CrmLocalitySearchField.create=function(t,e){var i=new BX.CrmLocalitySearchField;i.initialize(t,e);return i}}if(typeof BX.CrmAddressType==="undefined"){BX.CrmAddressType={undefined:0,primary:1,secondary:2,third:3,home:4,work:5,registered:6,custom:7,post:8,beneficiary:9,bank:10}}if(typeof BX.CrmMultipleAddressEditor==="undefined"){BX.CrmMultipleAddressEditor=function(){this._id="";this._settings={};this._fieldId="";this._formId="";this._scheme=null;this._data=null;this._currentTypeId=0;this._typeInfos=null;this._fieldLabels=null;this._fielNameTemplate="";this._serviceUrl="";this._container=null;this._createButton=null;this._typeMenuButton=null;this._createButtonHandler=BX.delegate(this.onCreateButtonClick,this);this._typenuButtonHandler=BX.delegate(this.onTypeMenuButtonClick,this);this._typeMenuItemClickHandler=BX.delegate(this.onTypeMenuItemClick,this);this._typeMenuCloseHandler=BX.delegate(this.onTypeMenuClose,this);this._typeMenuId="";this._isTypeMenuOpened=false;this._items={};this._entityAddresses={}};BX.CrmMultipleAddressEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_multiaddr_"+Math.random();this._settings=e?e:{};this._fieldId=this.getSetting("fieldId","");this._formId=this.getSetting("formId","");this._scheme=this.getSetting("scheme");if(!BX.type.isArray(this._scheme)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'scheme'."}this._data=this.getSetting("data");if(!BX.type.isPlainObject(this._data)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'data'."}this._typeInfos=this.getSetting("typeInfos");if(!BX.type.isArray(this._typeInfos)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'typeInfos'."}this._fieldLabels=this.getSetting("fieldLabels");if(!BX.type.isPlainObject(this._fieldLabels)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'fieldLabels'."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'container'."}this._itemWrapper=BX.findChildByClassName(this._container,"crm-multi-address");var i=this.getSetting("createButtonContainer");if(BX.type.isElementNode(i)){this._createButton=BX.findChildByClassName(i,"crm-offer-requisite-option-text");if(this._createButton){BX.bind(this._createButton,"click",this._createButtonHandler)}this._typeMenuButton=BX.findChildByClassName(i,"crm-offer-requisite-option-arrow");if(this._typeMenuButton){BX.bind(this._typeMenuButton,"click",this._typenuButtonHandler)}}this._currentTypeId=this.getSetting("currentTypeId");this._fielNameTemplate=this.getSetting("fielNameTemplate","");this._serviceUrl=this.getSetting("serviceUrl","");for(var s in this._data){if(!this._data.hasOwnProperty(s)){continue}var n=parseInt(s);var a=this._id+"_"+n.toString();var r=this._fielNameTemplate.replace("#TYPE_ID#",n).replace("#FIELD_NAME#","wrapper").toLowerCase();this._items[a]=BX.CrmMultipleAddressItemEditor.create(a,{typeId:n,fields:this._data[s],editor:this,container:BX(r),hasLayout:true,isPersistent:true})}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getFieldId:function(){return this._fieldId},getFormId:function(){return this._formId},getScheme:function(){return this._scheme},getTypeName:function(t){for(var e=0;e<this._typeInfos.length;e++){var i=this._typeInfos[e];if(i["id"]==t){return i["name"]}}return t},getFieldLabel:function(t){return this._fieldLabels.hasOwnProperty(t)?this._fieldLabels[t]:t},getFieldNameTemplate:function(){return this._fielNameTemplate},prepareQualifiedName:function(t,e){if(this._fielNameTemplate!==""){if(!BX.type.isPlainObject(e)){e={}}var i=typeof e["typeId"]!=="undefined"?e["typeId"]:this._currentTypeId;t=this._fielNameTemplate.replace("#TYPE_ID#",i).replace("#FIELD_NAME#",t)}return t},getServiceUrl:function(){return this._serviceUrl},getMessage:function(t){var e=BX.CrmMultipleAddressEditor.messages;return e.hasOwnProperty(t)?e[t]:t},createItem:function(t,e){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){t=this._currentTypeId}if(!BX.type.isString(e)){e=""}var i=BX.create("DIV",{attrs:{className:"crm-multi-address-item"}});this._itemWrapper.appendChild(i);var s=false;var n=this._id+"_"+t.toString();if(this._items.hasOwnProperty(n)){var a=this._items[n];if(a.isMarkedAsDeleted()){s=a.isPersistent();this.removeItem(a,true)}else{window.alert(this.getMessage("alreadyExists").replace("#TYPE_NAME#",this.getTypeName(t)));return false}}var r=BX.CrmMultipleAddressItemEditor.create(n,{typeId:t,fields:{},editor:this,container:i,hasLayout:false,isPersistent:s,originatorId:e});this._items[n]=r;r.layout();if(this._itemWrapper.style.display==="none"){this._itemWrapper.style.display=""}BX.onCustomEvent(this,"CrmMultipleAddressItemCreated",[this,r]);return r},removeItem:function(t,e){var i=t.getId();if(!this._items.hasOwnProperty(i)){return false}if(!t.isPersistent()||!!e){t.cleanLayout();BX.remove(t.getContainer());delete this._items[i]}if(this.getActiveItemCount()===0){this._itemWrapper.style.display="none"}return true},getItemByTypeId:function(t){t=parseInt(t);if(isNaN(t)||t<=0){return null}for(var e in this._items){if(!this._items.hasOwnProperty(e)){continue}var i=this._items[e];if(t===i.getTypeId()){return i}}return null},getActiveItemCount:function(){var t=0;for(var e in this._items){if(this._items.hasOwnProperty(e)&&!this._items[e].isMarkedAsDeleted()){t++}}return t},loadEntityAddress:function(t,e,i,s){if(BX.type.isPlainObject(this._entityAddresses[e])&&BX.type.isPlainObject(this._entityAddresses[e][i])){s(this._entityAddresses[e][i]["fields"]);return}if(!BX.type.isPlainObject(this._entityAddresses[e])){this._entityAddresses[e]={}}if(!BX.type.isPlainObject(this._entityAddresses[e][i])){this._entityAddresses[e][i]={}}if(BX.type.isFunction(s)){if(!BX.type.isArray(this._entityAddresses[e][i]["callbacks"])){this._entityAddresses[e][i]["callbacks"]=[]}this._entityAddresses[e][i]["callbacks"].push(s)}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_ENTITY_ADDRESS",ENTITY_TYPE_ID:e,ENTITY_ID:i,TYPE_ID:t},onsuccess:BX.delegate(this.onEntityAddressLoadSuccess,this)})},openTypeMenu:function(){if(this._isTypeMenuOpened){return}var t=[];for(var e=0;e<this._typeInfos.length;e++){var i=this._typeInfos[e];t.push({text:i["name"],id:i["id"],className:"crm-convert-item",
onclick:this._typeMenuItemClickHandler})}if(typeof BX.PopupMenu.Data[this._typeMenuId]!=="undefined"){BX.PopupMenu.Data[this._typeMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._typeMenuId]}BX.PopupMenu.show(this._typeMenuId,this._typeMenuButton,t,{autoHide:true,offsetLeft:BX.pos(this._typeMenuButton)["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:this._typeMenuCloseHandler}});this._isTypeMenuOpened=true},closeTypeMenu:function(){if(this._isTypeMenuOpened){BX.PopupMenu.destroy(this._typeMenuId);this._isTypeMenuOpened=false}},onCreateButtonClick:function(t){this.createItem(this._currentTypeId)},onTypeMenuButtonClick:function(t){if(!this._isTypeMenuOpened){this.openTypeMenu()}else{this.closeTypeMenu()}return BX.PreventDefault(t)},onTypeMenuItemClick:function(t,e){this._currentTypeId=parseInt(e["id"]);this._createButton.innerHTML=this.getTypeName(this._currentTypeId);this.closeTypeMenu()},onTypeMenuClose:function(t){this._isTypeMenuOpened=false},onEntityAddressLoadSuccess:function(t){if(!BX.type.isPlainObject(t["DATA"])){return}var e=t["DATA"];var i=typeof e["ENTITY_TYPE_ID"]?parseInt(e["ENTITY_TYPE_ID"]):0;var s=typeof e["ENTITY_ID"]?parseInt(e["ENTITY_ID"]):0;if(isNaN(i)||i<=0||isNaN(s)||s<=0){return}if(!BX.type.isPlainObject(this._entityAddresses[i])){this._entityAddresses[i]={}}if(!BX.type.isPlainObject(this._entityAddresses[i][s])){this._entityAddresses[i][s]={}}var n=BX.type.isPlainObject(e["FIELDS"])?e["FIELDS"]:null;this._entityAddresses[i][s]["fields"]=n;if(BX.type.isArray(this._entityAddresses[i][s]["callbacks"])){var a=this._entityAddresses[i][s]["callbacks"];for(var r=0;r<a.length;r++){a[r](n)}delete this._entityAddresses[i][s]["callbacks"]}}};if(typeof BX.CrmMultipleAddressEditor.messages==="undefined"){BX.CrmMultipleAddressEditor.messages={}}BX.CrmMultipleAddressEditor.items={};BX.CrmMultipleAddressEditor.getItemsByFormId=function(t){var e;t=BX.type.isNotEmptyString(t)?t:"";if(t===""){return[]}var i=[];for(var s in this.items){if(this.items.hasOwnProperty(s)){e=this.items[s];if(e.getFormId()===t){i.push(e)}}}return i};BX.CrmMultipleAddressEditor.create=function(t,e){var i=new BX.CrmMultipleAddressEditor;i.initialize(t,e);BX.CrmMultipleAddressEditor.items[i.getId()]=i;return i}}if(typeof BX.CrmMultipleAddressItemEditor==="undefined"){BX.CrmMultipleAddressItemEditor=function(){this._id="";this._settings={};this._typeId=0;this._fields={};this._editor=null;this._container=null;this._isPersistent=false;this._isMarkedAsDeleted=false;this._hasLayout=false;this._originatorId="";this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this)};BX.CrmMultipleAddressItemEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_multiaddr_item_"+Math.random();this._settings=e?e:{};this._typeId=parseInt(this.getSetting("typeId",0));this._fields=this.getSetting("fields",{});this._editor=this.getSetting("editor");if(!(this._editor instanceof BX.CrmMultipleAddressEditor)){throw"BX.CrmMultipleAddressItemEditor: Could not find a parameter named 'editor'."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmMultipleAddressItemEditor: Could not find a parameter named 'container'."}this._isPersistent=!!this.getSetting("isPersistent",false);this._hasLayout=!!this.getSetting("hasLayout",false);if(this._hasLayout){this._deleteButton=BX.findChildByClassName(this._container,"crm-offer-title-del");if(!BX.type.isElementNode(this._deleteButton)){throw"BX.CrmMultipleAddressItemEditor: Could not find the 'Delete' button."}this.bind()}this._originatorId=this.getSetting("originatorId","")},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmMultipleAddressItemEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getTypeId:function(){return this._typeId},getContainer:function(){return this._container},getOriginatorId:function(){return this._originatorId},getFieldControl:function(t){var e=this._editor.prepareQualifiedName(t,{typeId:this._typeId});var i=document.getElementsByName(e);return i.length>0?i[0]:null},getFieldValue:function(t){var e=this.getFieldControl(t);return e!==null?e.value:""},setFieldValue:function(t,e){var i=this.getFieldControl(t);if(i!==null){i.value=e}},setup:function(t){if(!BX.type.isPlainObject(t)){return}for(var e in t){if(t.hasOwnProperty(e)){this.setFieldValue(e,t[e])}}},bind:function(){if(this._deleteButton){BX.bind(this._deleteButton,"click",this._deleteButtonHandler)}},unbind:function(){if(this._deleteButton){BX.unbind(this._deleteButton,"click",this._deleteButtonHandler)}},layout:function(){if(this._hasLayout){return}var t,e,i;t=BX.create("TABLE",{attrs:{className:"crm-offer-info-table"}});this._container.appendChild(t);e=t.insertRow(-1);i=e.insertCell(-1);i.colSpan="4";this._deleteButton=BX.create("SPAN",{attrs:{className:"crm-offer-title-del"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-offer-title"},children:[BX.create("SPAN",{attrs:{className:"crm-offer-title-text"},text:this._editor.getTypeName(this._typeId)}),BX.create("SPAN",{attrs:{className:"crm-offer-title-set-wrap"},children:[this._deleteButton]})]}));var s=this._editor.getScheme();for(var n=0;n<s.length;n++){var a=s[n];var r=BX.type.isNotEmptyString(a["type"])?a["type"]:"";var o=BX.type.isNotEmptyString(a["name"])?a["name"]:"";var l=this._editor.prepareQualifiedName(o,{typeId:this._typeId});var d=this._fields.hasOwnProperty(o)?this._fields[o]:"";if(r==="locality"){e=t.insertRow(-1);e.style.display="none";i=e.insertCell(-1);i.colSpan="4";i.appendChild(BX.create("INPUT",{props:{type:"hidden",name:l,value:d}}));var h=BX.type.isPlainObject(a["params"])?a["params"]:{};var c=BX.type.isNotEmptyString(a["related"])?a["related"]:"";BX.CrmLocalitySearchField.create(l,{localityType:BX.type.isNotEmptyString(h["locality"])?h["locality"]:"",serviceUrl:this._editor.getServiceUrl(),searchInput:this._editor.prepareQualifiedName(c,{typeId:this._typeId}),dataInput:l})}else{e=t.insertRow(-1);i=e.insertCell(-1);i.className="crm-offer-info-left";i.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-info-label-alignment"}}));i.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-info-label"},text:this._editor.getFieldLabel(o)}));i=e.insertCell(-1);i.className="crm-offer-info-right";if(r==="multilinetext"){i.appendChild(BX.create("DIV",{attrs:{className:"crm-offer-info-data-wrap"},children:[BX.create("TEXTAREA",{props:{className:"bx-crm-edit-text-area",name:l,value:d}})]}))}else{i.appendChild(BX.create("DIV",{attrs:{className:"crm-offer-info-data-wrap"},children:[BX.create("INPUT",{props:{className:"crm-offer-item-inp",type:"text",name:l,value:d}})]}))}i=e.insertCell(-1);i.className="crm-offer-info-right-btn";i=e.insertCell(-1);i.className="crm-offer-last-td"}}this.bind();this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}this.unbind();BX.cleanNode(this._container);this._hasLayout=false},isPersistent:function(){return this._isPersistent},markAsDeleted:function(){if(this._isMarkedAsDeleted){return}this._isMarkedAsDeleted=true;this._container.appendChild(BX.create("INPUT",{props:{name:this._editor.prepareQualifiedName("DELETED",{typeId:this._typeId}),type:"hidden",value:"Y"}}));this._container.style.display="none"},isMarkedAsDeleted:function(){return this._isMarkedAsDeleted},setupByEntity:function(t,e){this._editor.loadEntityAddress(this.getTypeId(),t,e,BX.delegate(this.onEntityAddressLoad,this))},onEntityAddressLoad:function(t){if(!BX.type.isPlainObject(t)){return}if(window.confirm(this.getMessage("copyConfirmation"))){this.setup(t)}},onDeleteButtonClick:function(t){if(window.confirm(this.getMessage("deletionConfirmation"))){this.markAsDeleted();this._editor.removeItem(this)}}};if(typeof BX.CrmMultipleAddressItemEditor.messages==="undefined"){BX.CrmMultipleAddressItemEditor.messages={}}BX.CrmMultipleAddressItemEditor.create=function(t,e){var i=new BX.CrmMultipleAddressItemEditor;i.initialize(t,e);return i}}BX.namespace("BX.Crm");BX.Crm.EntityEditorBlockAreaClass=function(){var t=function(t){this.editor=t.editor;this.container=t.container;this.nextNode=t.nextNode;this.entityInfoList=t.entityInfoList;this.readOnlyMode=t.readOnlyMode;this.closeBlockHandler=t.closeBlockHandler;this.changeSelectedRequisiteHandler=t.changeSelectedRequisiteHandler;this.changeLinkedRequisiteHandler=t.changeLinkedRequisiteHandler;this.rqLinkedId=t.rqLinkedId;this.bdLinkedId=t.bdLinkedId;this.wrapper=null;this.visualization=null;this.blockList=[];this.cleanState={started:false,cleanAll:false,afterClean:null};this.initialize()};t.prototype={initialize:function(){if(this.container){if(this.wrapper){this.clean(false,BX.delegate(this.continueInitialize,this))}}this.continueInitialize()},continueInitialize:function(){if(this.container){if(!this.wrapper)this.wrapper=BX.create("DIV",{attrs:{"class":"crm-offer-tabs-wrapper"}});if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper);this.visualization=new BX.Crm.EntityEditorBlockAreaVisualizationClass({blockArea:this,tabActiveClass:"crm-offer-tab-active"})}}var t=this.entityInfoList.length;if(this.entityInfoList instanceof Array&&t>0){for(var e=0;e<t;e++){if(this.entityInfoList[e]instanceof BX.CrmEntityInfo)this.addBlock(this.entityInfoList[e])}}},getWrapperNode:function(){return this.wrapper},addBlock:function(t){var e=this.blockList.length;var i=new BX.Crm.EntityEditorBlockClass({editor:this.editor,blockArea:this,blockIndex:e,container:this.wrapper,nextNode:null,entityInfo:t,readOnlyMode:this.readOnlyMode,closeBlockHandler:this.closeBlockHandler,changeSelectedRequisiteHandler:this.changeSelectedRequisiteHandler,changeLinkedRequisiteHandler:BX.delegate(this.changeLinkedRequisite,this),rqLinkedId:this.rqLinkedId,bdLinkedId:this.bdLinkedId});if(i){this.blockList[e]=i;if(this.visualization)this.visualization.addTabBlock(i)}},clean:function(t,e){if(!this.cleanState.started){this.cleanState.started=true;this.cleanState.cleanAll=!!t;this.cleanState.afterClean=typeof e==="function"?e:null;if(this.blockList.length>0)this.blockList[0].destroy();else this.continueClean()}},continueClean:function(){if(this.cleanState.started){if(this.blockList.length>0){this.blockList[0].destroy()}else{if(this.wrapper){if(this.visualization)this.visualization=null;BX.cleanNode(this.wrapper,this.cleanState.cleanAll)}var t=this.cleanState.afterClean;this.cleanState={cleanAll:false,started:false,afterClean:null};if(typeof t==="function")t()}}},onBlockDestroy:function(t){if(t>=0&&this.blockList&&this.blockList.length>t){if(this.visualization)this.visualization.removeTabsBlock(this.blockList[t],BX.delegate(this.continueBlockDestroy,this));else this.continueBlockDestroy(t)}},changeLinkedRequisite:function(t,e){this.rqLinkedId=parseInt(t);if(this.rqLinkedId<0||isNaN(this.rqLinkedId))this.rqLinkedId=0;this.bdLinkedId=parseInt(e);if(this.bdLinkedId<0||isNaN(this.bdLinkedId))this.bdLinkedId=0;if(typeof this.changeLinkedRequisiteHandler==="function")this.changeLinkedRequisiteHandler(this.rqLinkedId,this.bdLinkedId)},continueBlockDestroy:function(t){if(t>=0&&this.blockList&&this.blockList.length>t){var e=this.blockList[t];this.blockList.splice(t,1);this.reindexBlocks(t);e.continueDestroy();if(this.cleanState.started)this.continueClean()}},reindexBlocks:function(t){for(var e=t;e<this.blockList.length;e++)this.blockList[e].setIndex(e)},destroy:function(t){this.clean(true,t)}};return t}();BX.Crm.EntityEditorBlockAreaVisualizationClass=function(){var t=function(t){this.block=null;this.wrapper=null;this.activeClass="";this.tabsObjList=[];this.init(t)};t.prototype={init:function(t){this.blockArea=t.blockArea;if(this.blockArea)this.wrapper=this.blockArea.getWrapperNode();this.activeClass=t.tabActiveClass},createTabObj:function(t){var e,i,s,n=this;var a={mainblock:t,innerBlock:t.querySelector("[data-tab-block=tabBlockInner]"),contWrap:t.querySelector("[data-tab-block=tabBlockWrap]"),btnList:[],contList:[],requisiteItems:[]};e=t.querySelectorAll("[data-tab-block=tab-btn]");i=t.querySelectorAll("[data-tab-block=tab-cont]");for(var r=0;r<i.length;r++){a.contList[r]=i[r];s=i[r].querySelectorAll("[data-tab-block=requisiteItem]");if(s.length>0)this.bindSwitchRequisiteItems(s)}for(var o=0;o<e.length;o++){a.btnList[o]=e[o];(function(t,i){BX.bind(e[o],"click",function(){n.switchTab(t,i)})})(a,o)}this.tabsObjList.push(a)},switchTab:function(t,e){t.contWrap.style.height=t.contWrap.clientHeight+"px";for(var i=0;i<t.btnList.length;i++){BX.removeClass(t.btnList[i],this.activeClass);t.contList[i].style.display="none"}t.contList[e].style.display="block";BX.addClass(t.btnList[e],this.activeClass);t.contWrap.style.height=t.contList[e].offsetHeight+"px"},bindSwitchRequisiteItems:function(t){var e,i,s,n,a,r=this;for(n=0;n<t.length;n++){i=0;e=[];e[i++]=t[n].querySelector("[class=crm-offer-requisite-inp]");s=t[n].querySelectorAll("[class=crm-offer-bankdetail-inp]");if(s){for(a=0;a<s.length;a++)e[i++]=s[a]}s=null;(function(t,i){for(var s=0;s<e.length;s++){BX.bind(e[s],"click",function(){r.switchRequisiteItems(t,i)})}})(t[n],t)}},switchRequisiteItems:function(t,e){var i;for(var s=0;s<e.length;s++){BX.removeClass(e[s],"crm-offer-requisite-active")}BX.addClass(t,"crm-offer-requisite-active");if(i=t.querySelector("[class=crm-offer-requisite-inp]")){i.checked=true}},removeTabsBlock:function(t,e){var i=t.getWrapperNode();if(i){i.style.height=i.offsetHeight+"px";var s=i.getBoundingClientRect().top,n=s,a;for(var r=0;r<this.tabsObjList.length;r++){if(this.tabsObjList[r].mainblock==i){if(r<this.tabsObjList.length-1)n=this.tabsObjList[r+1].mainblock.getBoundingClientRect().top;a=this.tabsObjList.indexOf(this.tabsObjList[r]);this.tabsObjList.splice(a,1)}}setTimeout(function(){if(s==n)i.style.width=0;i.style.height=0;i.style.opacity=0},100);setTimeout(function(){i.style.display="none";e(t.getIndex())},700)}},addTabBlock:function(t){var e=t.getWrapperNode();this.createTabObj(e);this.showTabObj()},showTabObj:function(){var t=this.tabsObjList.length-1;var e=parseInt(BX.style(this.tabsObjList[t].innerBlock,"marginBottom"));this.tabsObjList[t].mainblock.style.height=this.tabsObjList[t].innerBlock.offsetHeight+e+"px";BX.bind(this.tabsObjList[t].mainblock,"transitionend",function(){BX.removeClass(this,"crm-offer-tab-block-hidden");this.style.height="auto"})}};return t}();BX.Crm.EntityEditorBlockClass=function(){var t=function(t){this.editor=t.editor;this.blockArea=t.blockArea;this.blockIndex=t.blockIndex;this.container=t.container;this.nextNode=t.nextNode;this.entityInfo=t.entityInfo;this.readOnlyMode=t.readOnlyMode;this.closeBlockHandler=t.closeBlockHandler;this.changeSelectedRequisiteHandler=t.changeSelectedRequisiteHandler;this.changeLinkedRequisiteHandler=t.changeLinkedRequisiteHandler;this.rqLinkedId=parseInt(t.rqLinkedId);if(this.rqLinkedId<0||isNaN(this.rqLinkedId))this.rqLinkedId=0;this.bdLinkedId=parseInt(t.bdLinkedId);if(this.bdLinkedId<0||isNaN(this.bdLinkedId))this.bdLinkedId=0;this.ajaxUrl="/bitrix/components/bitrix/crm.requisite.edit/settings.php";this.closeButtonClickHandler=null;this.wrapper=null;this.wrapperInner=null;this.titleNode=null;this.closeButtonNode=null;this.requisiteIndex=[];this.random=Math.random().toString().substring(2);this.initialize()};t.prototype={initialize:function(){if(this.container){this.clean();if(!this.wrapper){var t="";if(this.entityInfo instanceof BX.CrmEntityInfo){var e=this.entityInfo.getSetting("type","");if(typeof e==="string"&&e.length>0)t=" crm-offer-tab-"+e}this.wrapper=BX.create("DIV",{attrs:{"class":"crm-offer-tab-block-wrap"+t+" crm-offer-tab-block-hidden","data-tab-block":"tabBlock"}});if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}}}if(this.wrapper){this.wrapperInner=BX.create("DIV",{attrs:{"class":"crm-offer-tab-block","data-tab-block":"tabBlockInner"}});if(this.wrapperInner){this.wrapper.appendChild(this.wrapperInner);var i,s,n,a=null;if(this.entityInfo instanceof BX.CrmEntityInfo){i=this.entityInfo.getSetting("title","");if(i.length>0){s=this.entityInfo.getSetting("url","");if(BX.type.isNotEmptyString(s)){a=BX.create("A",{attrs:{"class":"crm-offer-tab-title-name",href:s,target:"_blank"},html:BX.util.htmlspecialchars(i)})}else{a=BX.create("SPAN",{attrs:{"class":"crm-offer-tab-title-name"},html:BX.util.htmlspecialchars(i)})}n=this.entityInfo.getSetting("desc","")}if(a){this.titleNode=BX.create("DIV",{attrs:{"class":"crm-offer-tab-title"},children:[BX.create("DIV",{attrs:{"class":"crm-offer-tab-title-icon"}}),BX.create("DIV",{attrs:{"class":"crm-offer-tab-title-name-block"},children:[a,BX.create("DIV",{attrs:{"class":"crm-offer-tab-title-descript"},html:BX.util.htmlspecialchars(n)})]})]})}}if(this.titleNode){if(!this.readOnlyMode){this.closeButtonNode=BX.create("DIV",{attrs:{"class":"crm-offer-tab-close-btn","data-tab-block":"closeBtn"}});if(this.closeButtonNode){this.titleNode.appendChild(this.closeButtonNode);this.closeButtonClickHandler=BX.delegate(this.onCloseButtonClick,this);BX.bind(this.closeButtonNode,"click",this.closeButtonClickHandler)}}this.wrapperInner.appendChild(this.titleNode)}if(this.titleNode){var r,o,l,d,h,c="",u=[],f=[],p=[];l=this.entityInfo.getSetting("advancedInfo",null);d=this.entityInfo.getSetting("id","");h=this.entityInfo.getSetting("type","");if(BX.type.isPlainObject(l)){if(h==="contact"){if(BX.type.isPlainObject(l["contactType"])&&typeof l["contactType"]["name"]==="string"){c=l["contactType"]["name"]}}if(l["multiFields"]&&l["multiFields"]instanceof Array){var m=l["multiFields"];for(r=0;r<m.length;r++){if(m[r]["TYPE_ID"]&&m[r]["TYPE_ID"]==="PHONE"){u.push({VALUE:BX.util.trim(m[r]["VALUE"])})}if(m[r]["TYPE_ID"]&&m[r]["TYPE_ID"]==="EMAIL"){f.push({VALUE:BX.util.trim(m[r]["VALUE"])})}}}if(l["requisiteData"]instanceof Array){var g,_,B,y,b,I,X,C,v,D,S,E,N,k,w=0,T=-1,L=-1;g=l["requisiteData"];B=this.rqLinkedId;for(r=0;r<g.length;r++){if(typeof g[r]["requisiteId"]!=="undefined"){_=parseInt(g[r]["requisiteId"])}else{_=0}if(typeof g[r]["entityTypeId"]!=="undefined"){y=parseInt(g[r]["entityTypeId"])}else{y=0}if(typeof g[r]["entityId"]!=="undefined"){d=parseInt(g[r]["entityId"])}else{d=0}if(typeof g[r]["requisiteData"]==="string"){b=BX.parseJSON(g[r]["requisiteData"],this);if(!BX.type.isPlainObject(b))b={}}else{b={}}if(BX.type.isPlainObject(b["viewData"]))I=b["viewData"];else I={};if(typeof I["title"]==="string"&&I["title"].length>0){if(BX.type.isArray(b["bankDetailViewDataList"]))X=b["bankDetailViewDataList"];else X=[];if(typeof g[r]["bankDetailIdSelected"]!=="undefined"){S=parseInt(g[r]["bankDetailIdSelected"]);if(S<0||isNaN(S))S=0}else{g[r]["bankDetailIdSelected"]=S=0}if(X.length>0){v=-1;E=-1;N=-1;for(o=0;o<X.length;o++){k=parseInt(X[o]["pseudoId"]);if(k<0||isNaN(k))k=0;if(_===this.rqLinkedId&&this.bdLinkedId>0&&k===this.bdLinkedId){v=o}if(S>0&&k===S)N=o;if(X[o]["selected"])E=o}if(v>=0){if(N!==E){if(E>=0)X[E]["selected"]=false;X[v]["selected"]=true;g[r]["bankDetailIdSelected"]=parseInt(X[v]["pseudoId"])}}else if(N>=0){if(N!==E){if(E>=0)X[E]["selected"]=false;X[N]["selected"]=true;g[r]["bankDetailIdSelected"]=parseInt(X[N]["pseudoId"])}}else{if(E<0)E=0;g[r]["bankDetailIdSelected"]=parseInt(X[E]["pseudoId"])}}p.push({requisiteId:_,entityTypeId:y,entityId:d,viewData:I,bankDetailViewDataList:X,bankDetailIdSelected:g[r]["bankDetailIdSelected"],selected:g[r]["selected"]});this.requisiteIndex[_]={entityTypeId:y,entityId:d,bankDetailIdSelected:g[r]["bankDetailIdSelected"]};if(g[r]["selected"])T=w;if(this.rqLinkedId>0&&this.rqLinkedId==_)L=w;w++}}if(L>=0){if(T>=0&&T!==L){p[T]["selected"]=false;p[L]["selected"]=true;T=L}}B=0;D=0;if(T>=0){B=parseInt(p[T]["requisiteId"]);if(B<0||isNaN(B))B=0;D=parseInt(p[T]["bankDetailIdSelected"]);if(D<0||isNaN(D))D=0}if(this.rqLinkedId!==B||this.bdLinkedId!==D){if(typeof this.changeLinkedRequisiteHandler==="function"){this.rqLinkedId=B;this.bdLinkedId=D;this.changeLinkedRequisiteHandler(this.rqLinkedId,this.bdLinkedId)}}}}var x=false,P=false,A=false;if(h==="contact"&&c.length>0||u.length>0||f.length>0){x=true}if(p.length>0){P=true}A=x||P;if(A){var M=1,O=2,R=x?M:O;var H=this.getMessage(h+"TabTitleAbout"),q;if(h==="company"){q=this.getMessage("tabTitleCompanyRequisites")}else{q=this.getMessage("tabTitleContactRequisites")}if(!BX.type.isNotEmptyString(H))H=this.getMessage(h+"tabTitleAbout");var F={"class":"crm-offer-tab"+(M===R?" crm-offer-tab-active":""),"data-tab-block":"tab-btn"};var U={"class":"crm-offer-tab"+(O===R?" crm-offer-tab-active":""),"data-tab-block":"tab-btn"};if(!x)F["style"]="display: none;";if(!P)U["style"]="display: none;";var j=null;this.wrapperInner.appendChild(j=BX.create("DIV",{attrs:{"class":"crm-offer-tab-main-cont-wrap"},children:[BX.create("DIV",{attrs:{"class":"crm-offer-tab-list-wrap"},children:[BX.create("SPAN",{attrs:F,html:'<span class="crm-offer-tab-text">'+BX.util.htmlspecialchars(H)+"</span>"}),BX.create("SPAN",{attrs:U,html:'<span class="crm-offer-tab-text">'+BX.util.htmlspecialchars(q)+"</span>"})]})]}));if(j){var V={"class":"crm-offer-tab-cont","data-tab-block":"tab-cont"},z={"class":"crm-offer-tab-cont","data-tab-block":"tab-cont"};if(M!==R)V["style"]="display: none;";if(O!==R)z["style"]="display: none;";var W=null,Y=null;j.appendChild(BX.create("DIV",{attrs:{"class":"crm-offer-tab-cont-wrap","data-tab-block":"tabBlockWrap"},children:[BX.create("DIV",{attrs:V,children:[W=BX.create("DIV",{attrs:{"class":"crm-offer-tab-info"},children:[BX.create("DIV",{attrs:{"class":"crm-offer-tab-info-img"}})]})]}),BX.create("DIV",{attrs:z,children:[Y=BX.create("FORM")]})]}));var G,Q,K,J;if(W&&x){G=BX.create("TABLE",{attrs:{"class":"crm-offer-tab-table"}});if(G){if(h==="contact"&&c.length>0){var $=this.getMessage("prefContactType");Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars($+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(c)}if(u.length>0){var Z,tt;Z=this.getMessage("prefPhoneLong");var et="",it="",st="";for(r=0;r<u.length;r++){if(BX.type.isNotEmptyString(u[r]["VALUE"])){it=u[r]["VALUE"];et+='<div class="crm-offer-tab-hr">';et+='<span style="max-width: 330px;" class="crm-detail-info-item-text crm-detail-info-item-handset">';et+='<a class="crm-item-tel-num" href="callto://'+BX.util.urlencode(it)+'">'+BX.util.htmlspecialchars(it)+"</a>";et+="</span>";et+="</div>"}}Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(Z+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=et}if(f.length>0){var nt,at="",rt="";nt=this.getMessage("prefEmail");for(r=0;r<f.length;r++){if(BX.type.isNotEmptyString(f[r]["VALUE"])){rt=f[r]["VALUE"];at+='<div class="crm-offer-tab-hr">';at+='<a class="crm-offer-tab-link" href="mailto://'+BX.util.urlencode(rt)+'">'+BX.util.htmlspecialchars(rt)+"</a>";at+="</div>"}}Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(nt+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=at}}W.appendChild(G)}if(Y&&P){var ot,lt,dt;if(this.editor)lt=this.editor.getSetting("containerId",null);if(!BX.type.isNotEmptyString(lt))lt=this.random;lt+="_REQUISITE";for(r=0;r<p.length;r++){if(BX.type.isPlainObject(p[r]["viewData"])&&typeof p[r]["requisiteId"]!=="undefined"&&typeof p[r]["selected"]!=="undefined"&&BX.type.isNotEmptyString(p[r]["viewData"]["title"])&&p[r]["viewData"]["fields"]instanceof Array){dt=lt+"_"+r;ot=BX.create("DIV",{attrs:{"class":"crm-offer-requisite"+(p[r]["selected"]===true?" crm-offer-requisite-active":""),"data-tab-block":"requisiteItem"},children:[BX.create("DIV",{attrs:{"class":"crm-offer-requisite-title"},children:[BX.create("INPUT",{attrs:{id:dt,"class":"crm-offer-requisite-inp",type:"radio",name:lt,value:p[r]["requisiteId"]},props:{checked:p[r]["selected"]===true},events:{click:BX.delegate(this.onRequisiteRadioClick,this)}}),BX.create("LABEL",{attrs:{"class":"crm-offer-requisite-lable","for":dt},html:BX.util.htmlspecialchars(p[r]["viewData"]["title"])})]})]});if(ot){var ht=p[r]["viewData"]["fields"];if(ht.length>0||p[r]["bankDetailViewDataList"].length>0){G=BX.create("TABLE",{attrs:{"class":"crm-offer-tab-table"}});if(G){for(o=0;o<ht.length;o++){Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=(ht[o]["title"]?BX.util.htmlspecialchars(ht[o]["title"]):"")+":";K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=ht[o]["textValue"]?BX.util.nl2br(BX.util.htmlspecialchars(ht[o]["textValue"])):""}J=this.makeBankDetailsNode(p[r]);if(J){Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(this.getMessage("bankDetailsTitle")+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.appendChild(J)}ot.appendChild(G)}}Y.appendChild(ot)}}}}}}}}}},makeBankDetailsNode:function(t){var e,i,s,n,a,r,o,l;if(!BX.type.isPlainObject(t)){return null}a=parseInt(t["requisiteId"]);if(!(a>0&&BX.type.isArray(t["bankDetailViewDataList"])&&t["bankDetailViewDataList"].length>0)){return null}s=t["bankDetailViewDataList"];n=BX.create("DIV");if(!n){return null}i=0;for(e=0;e<s.length;e++){if(!(typeof s[e]["pseudoId"]!=="undefined"&&BX.type.isPlainObject(s[e]["viewData"])&&BX.type.isNotEmptyString(s[e]["viewData"]["title"])&&BX.type.isArray(s[e]["viewData"]["fields"]))){continue}r=s[e]["pseudoId"];if(this.editor)o=this.editor.getSetting("containerId",null);if(!BX.type.isNotEmptyString(o))o=this.random;o+="_RQ_"+a+"_BD";l=o+"_"+r;n.appendChild(BX.create("DIV",{children:[BX.create("INPUT",{attrs:{id:l,"class":"crm-offer-bankdetail-inp",type:"radio",name:o,value:""+a+"|"+r},props:{checked:s[e]["selected"]===true},events:{click:BX.delegate(this.onBankDetailRadioClick,this)}}),BX.create("LABEL",{attrs:{"for":l},html:BX.util.htmlspecialchars(s[e]["viewData"]["title"])})]}));i++}if(i<=0){BX.cleanNode(n,true);n=null}return n},getMessage:function(t){if(this.editor)return this.editor.getMessage(t);return""},getWrapperNode:function(){return this.wrapper},onCloseButtonClick:function(){if(this.readOnlyMode)return;if(typeof this.closeBlockHandler==="function")this.closeBlockHandler();this.destroy()},onRequisiteRadioClick:function(t){var e,i,s,n;if(!t)t=window.event;if(t&&BX.type.isDomNode(t.target)){e=parseInt(t.target.value);if(e>0){if(this.requisiteIndex[e]){i=parseInt(this.requisiteIndex[e].entityTypeId);s=parseInt(this.requisiteIndex[e].entityId);n=parseInt(this.requisiteIndex[e].bankDetailIdSelected);if(n<0||isNaN(n))n=0;if(i>0&&s>0){if(typeof this.changeSelectedRequisiteHandler==="function")this.changeSelectedRequisiteHandler(i,s,e,n);if(typeof this.changeLinkedRequisiteHandler==="function")this.changeLinkedRequisiteHandler(e,n);var a={action:"savelastselectedrequisite",requisiteEntityTypeId:i,requisiteEntityId:s,requisiteId:e,bankDetailId:n};BX.ajax.post(this.ajaxUrl,a)}}}}},onBankDetailRadioClick:function(t){var e,i,s,n,a;if(!t)t=window.event;if(t&&BX.type.isDomNode(t.target)&&BX.type.isNotEmptyString(t.target.value)){a=t.target.value.match(/^(\d+)\|(\d+)$/);if(a){e=parseInt(a[1]);n=parseInt(a[2]);if(e>0){if(this.requisiteIndex[e]){i=parseInt(this.requisiteIndex[e].entityTypeId);s=parseInt(this.requisiteIndex[e].entityId);if(i>0&&s>0){if(typeof this.changeSelectedRequisiteHandler==="function")this.changeSelectedRequisiteHandler(i,s,e,n);if(typeof this.changeLinkedRequisiteHandler==="function")this.changeLinkedRequisiteHandler(e,n);var r={action:"savelastselectedrequisite",requisiteEntityTypeId:i,requisiteEntityId:s,requisiteId:e,bankDetailId:n};BX.ajax.post(this.ajaxUrl,r)}}}}}},getIndex:function(){return this.blockIndex},setIndex:function(t){this.blockIndex=t},clean:function(t){t=!!t;if(this.wrapper){if(this.closeButtonNode){if(this.closeButtonClickHandler){BX.unbind(this.closeButtonNode,"click",this.closeButtonClickHandler);this.closeButtonClickHandler=null;this.closeButtonNode=null;this.requisiteIndex=[]}}BX.cleanNode(this.wrapper,t)}},destroy:function(){if(this.blockArea)this.blockArea.onBlockDestroy(this.blockIndex);else this.continueDestroy()},continueDestroy:function(){this.clean(true)}};return t}();if(typeof BX.Crm.RequisiteBankDetailsArea==="undefined"){BX.Crm.RequisiteBankDetailsArea=function(){this._id=null;this.container=null;this.nextNode=null;this.messages={};this.fieldList=[];this.dataList=[];this.fieldNameTemplate="";this.wrapper=null;this.blocksContainer=null;this.blockList=[];this.elementIndex=0;this.cleanState={started:false,cleanAll:false,afterClean:null};this.addBlockBtn=null;this.addBlockBtnClickHandler=null;this.mode="EDIT"};BX.Crm.RequisiteBankDetailsArea.prototype={initialize:function(t,e){var i;this._id=BX.type.isNotEmptyString(t)?t:"crm_rq_bank_details_area_"+Math.random().toString().substring(2);this.container=e.container;this.nextNode=e.nextNode;this.messages=e.messages||{};this.fieldList=BX.type.isArray(e.fieldList)?e.fieldList:[];this.dataList=BX.type.isArray(e.dataList)?e.dataList:[];this.fieldNameTemplate=BX.type.isNotEmptyString(e.fieldNameTemplate)?e.fieldNameTemplate:"BANK_DETAILS[#ELEMENT_ID#][#FIELD_NAME#]";this.mode=e.mode||"EDIT";if(this.container){this.clean();if(!this.wrapper){this.wrapper=BX.create("DIV",{attrs:{"class":"crm-offer-requisite-block-wrap"}});if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}}}this.elementIndex=0;if(this.wrapper){this.wrapper.appendChild(BX.create("SPAN",{attrs:{"class":"crm-offer-requisite-option"},children:[this.addBlockBtn=BX.create("SPAN",{attrs:{"class":"crm-offer-requisite-option-text"},text:this.getMessage("addBlockBtnText")})]}));this.wrapper.appendChild(BX.create("DIV",{attrs:{"class":"crm-offer-requisite-form-wrap"},children:[this.blocksContainer=BX.create("DIV",{attrs:{"class":"crm-multi-address"}})]}));if(this.addBlockBtn){this.addBlockBtnClickHandler=BX.delegate(this.onAddBlockButtonClick,this);BX.bind(this.addBlockBtn,"click",this.addBlockBtnClickHandler)}if(BX.type.isArray(this.dataList)){for(i=0;i<this.dataList.length;i++){if(BX.type.isPlainObject(this.dataList[i])){t=this.dataList[i].hasOwnProperty("ID")?parseInt(this.dataList[i]["ID"]):0;this.addBlock(t,this.dataList[i])}}}}},getId:function(){return this._id},getWrapperNode:function(){return this.wrapper},getMessage:function(t){return this.messages[t]},onAddBlockButtonClick:function(){this.addBlock()},addBlock:function(t,e){t=parseInt(t);if(t<0)t=0;if(!e||!BX.type.isPlainObject(e))e={};var i=this.blockList.length;var s=null;if(i>0)s=this.blockList[i-1].getWrapperNode();var n=new BX.Crm.RequisiteBankDetailsBlock({mode:this.mode,bankDetailId:t,bankDetailData:e,blockArea:this,blockIndex:i,elementIndex:this.elementIndex++,container:this.blocksContainer,nextNode:s,fieldList:this.fieldList,fieldNameTemplate:this.fieldNameTemplate});if(n)this.blockList[i]=n},onBlockDestroy:function(t){if(t>=0&&this.blockList&&this.blockList.length>t){this.blockList.splice(t,1);this.reindexBlocks(t)}if(this.cleanState.started)this.continueClean()},reindexBlocks:function(t){for(var e=t;e<this.blockList.length;e++)this.blockList[e].setIndex(e)},clean:function(t,e){if(!this.cleanState.started){this.cleanState.started=true;this.cleanState.cleanAll=!!t;this.cleanState.afterClean=typeof e==="function"?e:null;if(this.blockList.length>0)this.blockList[0].destroy();else this.continueClean()}},continueClean:function(){if(this.cleanState.started){if(this.blockList.length>0){this.blockList[0].destroy()}else{if(this.addBlockBtn){if(this.addBlockBtnClickHandler){BX.unbind(this.addBlockBtn,"click",this.addBlockBtnClickHandler);this.addBlockBtnClickHandler=null}this.addBlockBtn=null}if(this.wrapper){this.blocksContainer=null;

BX.cleanNode(this.wrapper,this.cleanState.cleanAll)}var t=this.cleanState.afterClean;this.cleanState={cleanAll:false,started:false,afterClean:null};this.mode="EDIT";if(typeof t==="function")t()}}},destroy:function(t){this.clean(true,t)}};BX.Crm.RequisiteBankDetailsArea.items={};BX.Crm.RequisiteBankDetailsArea.create=function(t,e){var i=new BX.Crm.RequisiteBankDetailsArea;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.RequisiteBankDetailsBlock==="undefined"){BX.Crm.RequisiteBankDetailsBlock=function(t){this.bankDetailId=parseInt(t.bankDetailId);if(this.bankDetailId<0)this.bankDetailId=0;this.bankDetailData=BX.type.isPlainObject(t.bankDetailData)?t.bankDetailData:{};this.blockArea=t.blockArea;this.blockIndex=t.blockIndex;this.elementIndex=t.elementIndex;this.container=t.container;this.nextNode=t.nextNode;this.fieldList=t.fieldList;this.fieldNameTemplate=t.fieldNameTemplate;this.mode=t.mode||"EDIT";this.wrapper=null;this.documentClickHandler=null;this.editNameMode=false;this.editNameInput=null;this.hiddenNameInput=null;this.nameLabelNode=null;this.editNameBtn=null;this.editNameKeyPressHandler=null;this.editNameBtnClickHandler=null;this.deleteBtn=null;this.deleteBtnClickHandler=null;this.markedAsDeleted=false;this.initialize()};BX.Crm.RequisiteBankDetailsBlock.prototype={initialize:function(){var t,e,i,s,n;if(this.container){this.clean();if(!this.wrapper){this.wrapper=BX.create("DIV",{attrs:{"class":"crm-multi-address-item"}});if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}}}if(this.wrapper&&this.fieldList.length>0){var a,r,o;a=BX.create("TABLE",{attrs:{"class":"crm-offer-info-table"}});s=BX.create("DIV",{attrs:{style:"display: none;"}});r=a.insertRow(-1);o=r.insertCell(-1);o.colSpan="4";o.appendChild(n=BX.create("DIV",{attrs:{"class":"crm-offer-title"},children:[this.editNameInput=BX.create("INPUT",{attrs:{"class":"crm-item-table-inp",type:"text",placeholder:this.getMessage("fieldNamePlaceHolder"),style:"display: none;"}}),this.nameLabelNode=BX.create("SPAN",{attrs:{"class":"crm-offer-title-text"}})]}));if(n&&this.mode==="EDIT"){this.editNameMode=false;this.documentClickHandler=BX.delegate(this.onDocumentClick,this);this.editNameKeyPressHandler=BX.delegate(this.onEditNameKeyPress,this);n.appendChild(BX.create("SPAN",{attrs:{"class":"crm-offer-title-set-wrap"},children:[this.editNameBtn=BX.create("SPAN",{attrs:{"class":"crm-offer-title-edit"}}),this.deleteBtn=BX.create("SPAN",{attrs:{"class":"crm-offer-title-del"}})]}));if(this.editNameBtn){this.editNameBtnClickHandler=BX.delegate(this.onEditNameButtonClick,this);BX.bind(this.editNameBtn,"click",this.editNameBtnClickHandler)}if(this.deleteBtn){this.deleteBtnClickHandler=BX.delegate(this.onDeleteButtonClick,this);BX.bind(this.deleteBtn,"click",this.deleteBtnClickHandler)}}for(var l=0;l<this.fieldList.length;l++){i=this.resolveFieldInputName(this.fieldList[l]["name"]);if(BX.type.isPlainObject(this.bankDetailData)&&this.bankDetailData.hasOwnProperty(this.fieldList[l]["name"])){t=this.bankDetailData[this.fieldList[l]["name"]]}else if(this.fieldList[l].hasOwnProperty("defaultValue")){t=this.fieldList[l]["defaultValue"]}else{t=""}if(this.fieldList[l]["name"]==="NAME"){if(!BX.type.isNotEmptyString(t)){t=this.getMessage("bankDetailsTitle")+" "+(this.elementIndex+1)}if(this.nameLabelNode){BX.adjust(this.nameLabelNode,{text:t})}if(s){s.appendChild(this.hiddenNameInput=BX.create("INPUT",{attrs:{type:"hidden",name:i,value:t}}))}}else if(s&&this.fieldList[l]["type"]==="hidden"){e=BX.create("INPUT",{attrs:{type:"hidden",name:i,value:t}});if(e)s.appendChild(e)}else if(a){r=a.insertRow(-1);o=r.insertCell(-1);o.className="crm-offer-info-left";o.appendChild(BX.create("SPAN",{attrs:{"class":"crm-offer-info-label-alignment"}}));if(this.fieldList[l]["required"]){o.appendChild(BX.create("SPAN",{attrs:{"class":"required"},text:"*"}))}o.appendChild(BX.create("SPAN",{attrs:{"class":"crm-offer-info-label"},text:this.fieldList[l]["title"]+":"}));o=r.insertCell(-1);o.className="crm-offer-info-right";e=null;if(this.fieldList[l]["type"]==="text"){e=BX.create("INPUT",{attrs:{type:"text","class":"crm-offer-item-inp",name:i,value:t}})}else if(this.fieldList[l]["type"]==="textarea"){e=BX.create("TEXTAREA",{attrs:{"class":"bx-crm-edit-text-area",name:i,cols:40,rows:3},html:BX.util.htmlspecialchars(t)})}if(e)o.appendChild(e);o=r.insertCell(-1);o.className="crm-offer-info-right-btn";o=r.insertCell(-1);o.className="crm-offer-last-td"}}if(a)this.wrapper.appendChild(a);if(s)this.wrapper.appendChild(s)}},setIndex:function(t){this.blockIndex=t},getPseudoId:function(){return this.bankDetailId>0?this.bankDetailId:"n"+this.elementIndex},getWrapperNode:function(){return this.wrapper},getMessage:function(t){if(this.blockArea)return this.blockArea.getMessage(t);return""},clean:function(t){t=!!t;if(this.wrapper){this.hiddenNameInput=null;this.nameLabelNode=null;if(this.editNameInput&&this.editNameKeyPressHandler){BX.unbind(this.editNameInput,"keydown",this.editNameKeyPressHandler);this.editNameKeyPressHandler=null}this.editNameInput=null;this.editNameMode=false;if(this.documentClickHandler)this.enableDocumentClick(false);this.documentClickHandler=null;if(this.editNameBtn){if(this.editNameBtnClickHandler){BX.unbind(this.editNameBtn,"click",this.editNameBtnClickHandler);this.editNameBtnClickHandler=null}this.editNameBtn=null}if(this.deleteBtn){if(this.deleteBtnClickHandler){BX.unbind(this.deleteBtn,"click",this.deleteBtnClickHandler);this.deleteBtnClickHandler=null}this.deleteBtn=null;this.markedAsDeleted=false}BX.cleanNode(this.wrapper,t)}},destroy:function(){this.clean(true);if(this.blockArea)this.blockArea.onBlockDestroy(this.blockIndex)},onEditNameButtonClick:function(){if(this.editNameMode)return;this.enableEditNameMode(true)},enableEditNameMode:function(t){t=!!t;if(this.editNameMode===t)return;this.editNameMode=t;if(this.editNameMode){if(this.nameLabelNode)this.nameLabelNode.style.display="none";if(this.editNameInput){this.editNameInput.style.display="";if(this.hiddenNameInput)this.editNameInput.value=this.hiddenNameInput.value;this.editNameInput.focus();this.editNameInput.setSelectionRange(0,this.editNameInput.value.length);this.enableDocumentClick(true);BX.bind(this.editNameInput,"keydown",this.editNameKeyPressHandler)}}else{this.editNameInput.style.display="none";this.nameLabelNode.style.display="";this.enableDocumentClick(false);BX.unbind(this.editNameInput,"keydown",this.editNameKeyPressHandler)}},enableDocumentClick:function(t){if(t){var e=this;window.setTimeout(function(){BX.bind(document,"click",e.documentClickHandler)},0)}else{BX.unbind(document,"click",this.documentClickHandler)}},onDocumentClick:function(t){if(!t){t=window.event}var e=BX.getEventTarget(t);if(e&&this.editNameInput===e){return}if(!this.editNameMode){BX.unbind(document,"click",this.documentClickHandler)}else{this.completeEditName(true)}},onEditNameKeyPress:function(t){if(!t){t=window.event}if(t.keyCode==13){this.completeEditName(true);return BX.eventReturnFalse(t)}else if(t.keyCode==27){this.completeEditName(false);return BX.eventReturnFalse(t)}return true},completeEditName:function(t){if(!this.editNameMode){return}if(!!t){var e=BX.util.trim(this.editNameInput.value);if(e!==""&&this.hiddenNameInput){this.hiddenNameInput.value=e}if(this.nameLabelNode)BX.adjust(this.nameLabelNode,{text:e})}this.enableEditNameMode(false)},onDeleteButtonClick:function(){this.markAsDeleted()},resolveFieldInputName:function(t){if(this.fieldNameTemplate!==""){return this.fieldNameTemplate.replace("#ELEMENT_ID#",this.getPseudoId()).replace("#FIELD_NAME#",t)}return t},markAsDeleted:function(){if(this.markedAsDeleted){return}this.markedAsDeleted=true;if(this.wrapper){this.wrapper.appendChild(BX.create("INPUT",{props:{name:this.resolveFieldInputName("DELETED"),type:"hidden",value:"Y"}}));this.wrapper.style.display="none"}},isMarkedAsDeleted:function(){return this.markedAsDeleted}}}
//# sourceMappingURL=interface_form.map.js