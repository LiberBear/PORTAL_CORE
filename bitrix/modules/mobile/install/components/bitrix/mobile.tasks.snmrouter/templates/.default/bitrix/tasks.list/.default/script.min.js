(function(){var e=window.BX,t;if(e&&e["Mobile"]&&e["Mobile"]["Tasks"]&&e["Mobile"]["Tasks"]["list"])return;e.namespace("BX.Mobile.Tasks.list");e.addCustomEvent("onTasksListSort",function(t){if(t&&t["action"]=="sort"){var a=e.util.add_url_param(top.location.href,{SORTF:t["sortBy"],SORTD:t["sortOrder"].toUpperCase()});window.app.showPopupLoader();window.app.reload({url:a})}});e.addCustomEvent("onTasksListFields",function(){e.reload()});e.Mobile.Tasks.list=function(t,a){this.parentConstruct(e.Mobile.Tasks.list,t);e.merge(this,{sys:{classCode:"list"},vars:{task:{}}});for(var s in t.tasksData){if(t.tasksData.hasOwnProperty(s)){this.bindTask(t.tasksData[s]["ID"],t.tasksData[s])}}this.handleInitStack(a,e.Mobile.Tasks.list,t)};e.extend(e.Mobile.Tasks.list,e.Mobile.Tasks.page);e.merge(e.Mobile.Tasks.list.prototype,{bindTask:function(t,a){this.variable("task"+t,a);if(e("bx-task-priority-"+a["ID"])&&!e("bx-task-priority-"+a["ID"]).hasAttribute("bx-bound")){if(!this._bindTaskPriority)this._bindTaskPriority=e.proxy(function(){var t=e.proxy_context,a=t.checked;e(t.getAttribute("id")+"-span").innerHTML=e.message("TASKS_PRIORITY_"+(a?"2":"0"));this.act("changePriority",t.getAttribute("id").replace("bx-task-priority-",""))},this);e.bind(e("bx-task-priority-"+a["ID"]),"click",this._bindTaskPriority);e("bx-task-priority-"+a["ID"]).setAttribute("bx-bound","Y")}if(e("bx-task-favorites-"+a["ID"])&&!e("bx-task-favorites-"+a["ID"]).hasAttribute("bx-bound")){if(!this._bindTaskFavorites)this._bindTaskFavorites=e.proxy(function(){var t=e.proxy_context;e(t.getAttribute("id")+"-span").innerHTML=t.checked?e.message("TASKS_FAVORITES_1"):e.message("TASKS_FAVORITES_0");this.act("favorite.addDelete",t.getAttribute("id").replace("bx-task-favorites-",""))},this);e.bind(e("bx-task-favorites-"+a["ID"]),"change",this._bindTaskFavorites);e("bx-task-favorites-"+a["ID"]).setAttribute("bx-bound","Y")}},init:function(){t=this;window.app.hidePopupLoader();e.Mobile.Tasks.list.actShow=e.delegate(this.actShow,this);e.Mobile.Tasks.list.act=e.delegate(this.act,this);this.actExecute=e.delegate(this.actExecute,this);this.actSuccess=e.delegate(this.actSuccess,this);this.actFailure=e.delegate(this.actFailure,this);e.addCustomEvent("onTaskWasUpdated",e.delegate(function(t,a,s){if(!s){s=t[2];t=t[0]}var i=this.variable("task"+t),T=false;if(i){if(s["TITLE"]&&s["TITLE"]!=i["TITLE"]&&e("bx-task-title-"+i["ID"])){e("bx-task-title-"+i["ID"]).innerHTML=s["TITLE"]}if(s["DESCRIPTION"]&&s["DESCRIPTION"]!=i["DESCRIPTION"]){if(e("bx-task-description-"+i["ID"]))e("bx-task-description-"+i["ID"]).innerHTML=s["DESCRIPTION"];else T=true}if(s["RESPONSIBLE"]&&s["RESPONSIBLE_ID"]&&s["RESPONSIBLE_ID"]+""!=i["RESPONSIBLE_ID"]+""){if(e("bx-task-responsible_id-"+i["ID"])){e("bx-task-responsible_id-"+i["ID"]).innerHTML=s["RESPONSIBLE"]["NAME"];e("bx-task-responsible_id-"+i["ID"]).setAttribute("bx-user_id",s["RESPONSIBLE_ID"])}else T=true}if(s["PRIORITY"]&&s["PRIORITY"]+""!=i["PRIORITY"]+""&&e("bx-task-priority-"+i["ID"])){e("bx-task-priority-"+i["ID"]).checked=s["PRIORITY"]==2;e("bx-task-priority-"+i["ID"]+"-span").innerHTML=e.message("TASKS_PRIORITY_"+(s["PRIORITY"]==2?"2":"0"))}if(s["REAL_STATUS"]&&s["STATUS"]+""!=i["STATUS"]+""&&e("bx-task-status-"+i["ID"])){var r=e.Mobile.Tasks.statusMap;e("bx-task-status-"+i["ID"]).innerHTML=e.message("TASKS_STATUS_"+r[i["STATUS"]])||e.message("TASKS_STATUS_STATE_UNKNOWN")}if(s["DEADLINE"]&&s["DEADLINE"]+""!=i["DEADLINE"]+""){if(e("bx-task-deadline-"+i["ID"]))e("bx-task-deadline-"+i["ID"]).innerHTML=s["DEADLINE"];else T=true}if(T){e.reload()}}},this));e.addCustomEvent("onTaskWasCreated",function(){e.reload()});e.addCustomEvent("onTaskWasPerformed",e.proxy(function(e,t,a){if(!a){a=e[2];e=e[0]}if(this.variable("task"+e))this.actSuccess(a)},this));e.addCustomEvent("onTaskWasRemoved",e.delegate(function(t,a,s){if(!s){t=t[0]}if(this.variable("task"+t)){var i=e.findChild(e("bx-mobile-grid"),{attribute:{"data-id":"mobile-grid-item-"+t}},true,false);if(i){e.fx.hide(i,{type:"fold",time:.2})}}},this))},getDefaultMenu:function(){return[{name:e.message("MB_TASKS_ROLES_TASK_ADD"),arrowFlag:false,icon:"add",action:e.Mobile.Tasks.createWindow},{name:e.message("TASKS_LIST_SORT"),image:"/bitrix/js/mobile/images/sort.png",arrowFlag:false,icon:"",action:function(){window.BXMobileApp.PageManager.loadPageBlank({url:top.location.href.replace(/routePage=list/gi,"routePage=listsorter").replace(/SORTF=[a-z]+/gi,"").replace(/SORTD=[a-z]+/gi,"").replace(/&&/gi,"&"),bx24ModernStyle:true})}},{name:e.message("TASKS_LIST_FIELDS"),image:"/bitrix/js/mobile/images/fields.png",arrowFlag:false,icon:"",action:function(){window.BXMobileApp.PageManager.loadPageBlank({url:top.location.href.replace(/routePage=list/gi,"routePage=listfields"),bx24ModernStyle:true})}}]},actShow:function(t){var a=this.variable("task"+t);if(a){var s=[];s.push({title:e.message("TASKS_LIST_GROUP_ACTION_VIEW"),callback:function(){window.BXMobileApp.PageManager.loadPageUnique({url:e.message("TASK_PATH_TO_READ").replace(/#TASK_ID#/gi,t).replace(/#USER_ID#/gi,e.message("USER_ID")),bx24ModernStyle:true})}});if(a["ALLOWED_ACTIONS"]["ACTION_EDIT"])s.push({title:e.message("TASKS_LIST_GROUP_ACTION_EDIT"),callback:function(){var a=e.message("TASK_PATH_TO_EDIT").replace(/#TASK_ID#/gi,t).replace(/#USER_ID#/gi,e.message("USER_ID")).replace(/#SALT#/gi,(new Date).getTime());window.BXMobileApp.PageManager.loadPageModal({url:a,bx24ModernStyle:true,cache:false})}});if(a["ALLOWED_ACTIONS"]["ACTION_COMPLETE"])s.push({title:e.message("TASKS_LIST_GROUP_ACTION_COMPLETE"),callback:function(){e.Mobile.Tasks.list.act("complete",t)}});if(a["ALLOWED_ACTIONS"]["ACTION_DEFER"])s.push({title:e.message("TASKS_LIST_GROUP_ACTION_DEFER"),callback:function(){e.Mobile.Tasks.list.act("defer",t)}});if(s.length>0)new window.BXMobileApp.UI.ActionSheet({buttons:s},"actionSheet").show()}},act:function(t,a){if(this.appCtrls&&this.appCtrls.menu)this.appCtrls.menu.hide();var s=e.type.isPlainObject(a)?a["id"]:0,i=e.type.isPlainObject(a)?a["id"]:a;a=a+0>0?a:a["id"];var T=this.variable("task"+i),r=t,o={act:r,id:i,userid:e.message("USER_ID"),taskid:i};if(t=="favorite.addDelete"){r=T["ALLOWED_ACTIONS"]["ACTION_ADD_FAVORITE"]?"favorite.add":"favorite.delete"}else if(t=="changePriority"){r="update";o["task.action"]="changePriority";o.data={PRIORITY:T["PRIORITY"]+""=="2"?"1":"2"}}var n=e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:r,id:i});window.app.showPopupLoader();new e.Tasks.Util.Query({url:n}).add("task."+r,o,{},{onExecuted:e.proxy(function(t){if(t&&t.response&&t.response.status=="failed"){window.app.BasicAuth({success:e.proxy(function(){new e.Tasks.Util.Query({url:n}).add("task."+r,o,{},{onExecuted:this.actExecute}).execute()},this),failure:this.actFailure})}else this.actExecute.apply(this,arguments)},this)}).execute()},actExecute:function(t,a){window.app.hidePopupLoader();if(t&&t.length>0){for(var s=0;s<t.length;s++)t[s]=t[s]["MESSAGE"]||t[s]["CODE"];window.app.alert({text:t.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}else if(a["OPERATION"]=="task.delete"){window.app.onCustomEvent("onTaskWasRemoved",[a["ARGUMENTS"]["taskid"],this.variable("objectId"),a])}else{window.app.onCustomEvent("onTaskWasPerformed",[a["ARGUMENTS"]["taskid"],this.variable("objectId"),a]);this.actSuccess(a)}},actSuccess:function(t){var a=t["ARGUMENTS"]?t["ARGUMENTS"]["id"]:0,s=this.variable("task"+a),i=e("bx-task-status-"+s["ID"]),T=e("bx-task-icon-"+s["ID"]),r=e.Mobile.Tasks.statusMap;if(!s)return;if(t["OPERATION"]=="task.start"){s["ALLOWED_ACTIONS"]["ACTION_START"]=false;s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]=true;e.hide(e("bx-task-start-"+s["ID"]));e.show(e("bx-task-complete-"+s["ID"]));i.innerHTML=e.message("TASKS_STATUS_STATE_IN_PROGRESS");T.className="mobile-grid-fields-task-icon state_in_progress"}else if(t["OPERATION"]=="task.complete"){s["ALLOWED_ACTIONS"]["ACTION_START"]=false;s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]=false;e.hide(e("bx-task-start-"+s["ID"]));e.hide(e("bx-task-complete-"+s["ID"]));i.innerHTML=e.message("TASKS_STATUS_STATE_COMPLETED");T.className="mobile-grid-fields-task-icon state_completed"}else if(t["OPERATION"]=="task.defer"){s["ALLOWED_ACTIONS"]["ACTION_START"]=true;s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]=true;e.show(e("bx-task-start-"+s["ID"]));e.show(e("bx-task-complete-"+s["ID"]));i.innerHTML=e.message("TASKS_STATUS_STATE_DEFERRED");T.className="mobile-grid-fields-task-icon state_deferred"}else if(t["OPERATION"]=="task.favorite.add"){s["ALLOWED_ACTIONS"]["ACTION_ADD_FAVORITE"]=false;s["ALLOWED_ACTIONS"]["ACTION_DELETE_FAVORITE"]=true;if(e("bx-task-favorites-"+a))e("bx-task-favorites-"+a).checked=true;e("bx-task-favorites-"+a+"-span").innerHTML=e("bx-task-favorites-"+a).checked?e.message("TASKS_FAVORITES_1"):e.message("TASKS_FAVORITES_0")}else if(t["OPERATION"]=="task.favorite.delete"){s["ALLOWED_ACTIONS"]["ACTION_ADD_FAVORITE"]=true;s["ALLOWED_ACTIONS"]["ACTION_DELETE_FAVORITE"]=false;if(e("bx-task-favorites-"+a))e("bx-task-favorites-"+a).checked=false;e("bx-task-favorites-"+a+"-span").innerHTML=e("bx-task-favorites-"+a).checked?e.message("TASKS_FAVORITES_1"):e.message("TASKS_FAVORITES_0")}else if(t["OPERATION"]=="task.update"&&t["ARGUMENTS"]&&t["ARGUMENTS"]["task.action"]=="changePriority"){s["PRIORITY"]=t["ARGUMENTS"]["data"]["PRIORITY"]+"";if(e("bx-task-priority-"+a)){var o=s["PRIORITY"]=="2";e("bx-task-priority-"+s["ID"]).checked=o;e("bx-task-priority-"+s["ID"]+"-span").innerHTML=e.message("TASKS_PRIORITY_"+(o?"2":"0"))}}else if(t["OPERATION"]=="task.get"){for(var n in t["RESULT"]["CAN"]["ACTION"]){if(t["RESULT"]["CAN"]["ACTION"].hasOwnProperty(n)){s["ALLOWED_ACTIONS"]["ACTION_"+n]=t["RESULT"]["CAN"]["ACTION"][n]=="YES"||t["RESULT"]["CAN"]["ACTION"][n]=="true"||t["RESULT"]["CAN"]["ACTION"][n]===true}}e[s["ALLOWED_ACTIONS"]["ACTION_START"]?"show":"hide"](e("bx-task-start-"+s["ID"]));e[s["ALLOWED_ACTIONS"]["ACTION_COMPLETE"]?"show":"hide"](e("bx-task-complete-"+s["ID"]));if(t["RESULT"]["DATA"]["REAL_STATUS"]&&t["RESULT"]["DATA"]["REAL_STATUS"]+""!=s["REAL_STATUS"]+""&&e("bx-task-status-"+s["ID"])){for(n in t["RESULT"]["DATA"]){if(t["RESULT"]["DATA"].hasOwnProperty(n)){if(s.hasOwnProperty(n))s[n]=t["RESULT"]["DATA"][n]}}var l=r[s["REAL_STATUS"]]||"STATE_UNKNOWN";i.innerHTML=e.message("TASKS_STATUS_"+l);T.className="mobile-grid-fields-task-icon "+l.toLowerCase()}if(e("bx-task-favorites-"+a))e("bx-task-favorites-"+a).checked=s["ALLOWED_ACTIONS"]["ACTION_DELETE_FAVORITE"];e("bx-task-favorites-"+a+"-span").innerHTML=e("bx-task-favorites-"+a).checked?e.message("TASKS_FAVORITES_1"):e.message("TASKS_FAVORITES_0")}else if(t["OPERATION"]=="task.delegate"){e.reload()}},actFailure:function(){window.app.alert({text:e.message("TASKS_LIST_GROUP_ACTION_ERROR1"),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}});e.Mobile.Tasks.go=function(t){window.BXMobileApp.PageManager.loadPageUnique({url:e.message("TASK_PATH_TO_USER_PROFILE").replace("#USER_ID#",t.getAttribute("bx-user_id")),bx24ModernStyle:true})};e.Mobile.Tasks.list.addCurrent=function(e,a){if(t){t.bindTask(e,a)}}})();
//# sourceMappingURL=script.map.js