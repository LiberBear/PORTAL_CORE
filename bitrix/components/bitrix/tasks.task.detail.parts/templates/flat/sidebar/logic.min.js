BX.namespace("Tasks.Component");BX.Tasks.Component.TaskViewSidebar=function(e){this.layout={};this.parameters=e||{};this.taskId=this.parameters.taskId;this.messages=this.parameters.messages||{};this.workingTime=this.parameters.workingTime||{start:{hours:0,minutes:0},end:{hours:0,minutes:0}};this.can=this.parameters.can||{};this.allowTimeTracking=this.parameters.allowTimeTracking===true;this.initDeadline();this.initReminder();this.initMark();this.initTime();this.initTags();BX.addCustomEvent(window,"tasksTaskEvent",BX.delegate(this.onTaskEvent,this))};BX.Tasks.Component.TaskViewSidebar.prototype.onTaskEvent=function(e,t){t=t||{};var a=t.task||{};if(e=="UPDATE"&&a.ID==this.parameters.taskId){if(BX.type.isNotEmptyString(a.REAL_STATUS)&&BX.type.isNotEmptyString(a.STATUS_CHANGED_DATE)){this.setStatus(a.REAL_STATUS,a.STATUS_CHANGED_DATE)}}};BX.Tasks.Component.TaskViewSidebar.prototype.setStatus=function(e,t){var a=BX("task-detail-status-name");var i=BX("task-detail-status-date");a.innerHTML=BX.message("TASKS_STATUS_"+e);i.innerHTML=(e!=4&&e!=5?BX.message("TASKS_SIDEBAR_START_DATE")+" ":"")+BX.util.htmlspecialchars(t)};BX.Tasks.Component.TaskViewSidebar.prototype.initDeadline=function(){this.deadline=BX.type.isNotEmptyString(this.parameters.deadline)?this.parameters.deadline:"";this.layout.deadline=BX("task-detail-deadline");this.layout.deadlineClear=BX("task-detail-deadline-clear");if(!this.layout.deadline){return}BX.bind(this.layout.deadline,"click",BX.proxy(this.onDeadlineClick,this));BX.bind(this.layout.deadlineClear,"click",BX.proxy(this.clearDeadline,this))};BX.Tasks.Component.TaskViewSidebar.prototype.onDeadlineClick=function(e){var t=new Date;var a=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),this.workingTime.end.hours,this.workingTime.end.minutes));BX.calendar({node:this.layout.deadline,field:"",form:"",bTime:true,value:this.deadline?this.deadline:a,bHideTimebar:false,callback_after:BX.proxy(function(e,t){this.setDeadline(e)},this)})};BX.Tasks.Component.TaskViewSidebar.prototype.setDeadline=function(e){this.deadline=BX.calendar.ValueToString(e,true,false);this.layout.deadline.innerHTML=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME").replace(":SS","").replace("/SS","")),e,null,false);this.layout.deadlineClear.style.display="";this.updateDeadline()};BX.Tasks.Component.TaskViewSidebar.prototype.clearDeadline=function(){this.deadline="";this.layout.deadline.innerHTML=this.messages.emptyDeadline;this.layout.deadlineClear.style.display="none";this.updateDeadline()};BX.Tasks.Component.TaskViewSidebar.prototype.updateDeadline=function(){var e=new BX.Tasks.Util.Query;e.add("task.update",{id:this.taskId,data:{DEADLINE:this.deadline}},{},BX.delegate(function(){BX.onCustomEvent(window,"tasksTaskEventChangeDeadline",[this.taskId,this.deadline]);BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:this.taskId},{STAY_AT_PAGE:true},{id:this.taskId,deadline:this.deadline})},this));e.execute()};BX.Tasks.Component.TaskViewSidebar.prototype.addReminder=function(){BX.onCustomEvent(window,"tasksTaskEventAddReminder",[this.layout.reminderAdd])};BX.Tasks.Component.TaskViewSidebar.prototype.initReminder=function(){this.layout.reminderAdd=BX("task-detail-reminder-add");BX.bind(this.layout.reminderAdd,"click",BX.delegate(this.addReminder,this))};BX.Tasks.Component.TaskViewSidebar.prototype.initMark=function(){if(!this.can["EDIT"]){return}this.mark=this.parameters.mark||"NULL";this.layout.mark=BX("task-detail-mark");if(this.layout.mark){BX.bind(this.layout.mark,"click",BX.proxy(this.onMarkClick,this))}};BX.Tasks.Component.TaskViewSidebar.prototype.onMarkClick=function(){BX.TaskGradePopup.show(this.taskId,this.layout.mark,{listValue:this.mark},{events:{onPopupChange:BX.proxy(this.onMarkChange,this)}})};BX.Tasks.Component.TaskViewSidebar.prototype.onMarkChange=function(){var e=BX.proxy_context;this.layout.mark.className="task-detail-sidebar-item-mark-"+e.listValue.toLowerCase();this.layout.mark.innerHTML=e.listItem.name;var t=new BX.Tasks.Util.Query;t.add("task.update",{id:this.taskId,data:{MARK:e.listValue==="NULL"?"":e.listValue}});t.execute()};BX.Tasks.Component.TaskViewSidebar.prototype.initTime=function(){if(!this.allowTimeTracking){return}BX.Tasks.Util.Dispatcher.bindEvent("buttons-dayplan","task-timer-tick",BX.delegate(this.onTaskTimerTick,this))};BX.Tasks.Component.TaskViewSidebar.prototype.onTaskTimerTick=function(e,t){if(e!=this.taskId){return}var a=BX("task-detail-spent-time-"+this.taskId);if(a){a.innerHTML=BX.Tasks.Util.formatTimeAmount(t)}};BX.Tasks.Component.TaskViewSidebar.prototype.initTags=function(){BX.addCustomEvent("onTaskTagSelect",BX.proxy(this.saveTags,this))};BX.Tasks.Component.TaskViewSidebar.prototype.saveTags=function(e){var t="";for(var a=0,i=e.length;a<i;a++){if(a>0){t+=", "}t+=e[a].name}var s=new BX.Tasks.Util.Query;s.add("task.update",{id:this.taskId,data:{TAGS:t}});s.execute()};
//# sourceMappingURL=logic.map.js