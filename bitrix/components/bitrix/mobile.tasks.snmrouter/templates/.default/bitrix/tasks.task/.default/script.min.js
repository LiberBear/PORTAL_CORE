(function(){var e=window.BX;if(e&&e["Mobile"]&&e["Mobile"]["Tasks"]&&e["Mobile"]["Tasks"]["edit"])return;e.namespace("BX.Mobile.Tasks.edit");var t=0,i=function(){return"TaskEdit"+ ++t+e.util.getRandomString()},s=function(){var t=function(t,i){this.clickAdd=e.delegate(this.clickAdd,this);this.clickSeparator=e.delegate(this.clickSeparator,this);this.clickMenu=e.delegate(this.clickMenu,this);this.callback=e.delegate(this.callback,this);var s;this.taskId=t;i=i||[];for(s=0;s<i.length;s++){this.bindItem(i[s])}this.container=e("checkList"+t+"Container");if(this.container&&e("checkList"+t+"Add")){this.canAdd=true;e.bind(e("checkList"+t+"Add"),"click",this.clickAdd);if(e("checkList"+t+"Separator")){e.bind(e("checkList"+t+"Separator"),"click",this.clickSeparator)}}};t.prototype={canAdd:false,container:null,bindItem:function(t){if(e("checkListItem"+t+"Menu"))e.bind(e("checkListItem"+t+"Menu"),"click",e.proxy(function(e){this.clickMenu(e,t)},this));var i=e("checkListItem"+t),s=e("checkListItem"+t+"Label");if(e.hasClass(s,"task-view-checklist-toggle")){s.setAttribute("bx-toggle","Y");i.setAttribute("bx-toggle","Y")}if(e.hasClass(s,"task-view-checklist-modify")){s.setAttribute("bx-modify","Y");i.setAttribute("bx-modify","Y")}if(e.hasClass(s,"task-view-checklist-remove")){s.setAttribute("bx-remove","Y");i.setAttribute("bx-remove","Y")}if(e.findParent(i,{tagName:"span",className:"mobile-grid-field-divider"},s)){s.setAttribute("bx-separator","Y");i.setAttribute("bx-separator","Y")}if(s.hasAttribute("bx-toggle"))e.bind(i,"click",e.proxy(function(){this.fireEvent(t,"toggle",{})},this));else e.bind(i,"click",e.proxy(function(t){return e.eventCancelBubble(t)},this));this.sort=i.form.elements["data[SE_CHECKLIST]["+t+"][SORT_INDEX]"].value},clickMenu:function(t,i){var s=e("checkListItem"+i),a=e("checkListItem"+i+"Label"),n=[];if(!a.hasAttribute("bx-separator")){if(a.hasAttribute("bx-toggle"))n.push({title:s.checked?e.message("MB_TASKS_TASK_UNCHECK"):e.message("MB_TASKS_TASK_CHECK"),callback:e.delegate(function(){s.checked=!s.checked;this.fireEvent(i,"toggle",{})},this)});if(a.hasAttribute("bx-modify"))n.push({title:e.message("MB_TASKS_TASK_EDIT"),callback:e.delegate(function(){var t=e.findChild(a,{tagName:"INPUT",attribute:{type:"hidden",name:"data[SE_CHECKLIST]["+i+"][TITLE]"}},true);if(t)this.show(t.value,i)},this)})}if(a.hasAttribute("bx-remove"))n.push({title:e.message("MB_TASKS_TASK_DELETE"),callback:e.delegate(function(){this.fireEvent(i,"remove",{});e.remove(a)},this)});if(n.length>0)new window.BXMobileApp.UI.ActionSheet({buttons:n},"textPanelSheet").show();return e.PreventDefault(t)},counter:0,sort:0,clickSeparator:function(t){if(this.canAdd)this.callback({text:"===",extraData:{id:"n"+this.counter++}},{separator:true});return t?e.PreventDefault(t):false},clickAdd:function(t){if(this.canAdd)this.showAdd("n"+this.counter++);return t?e.PreventDefault(t):false},showAdd:function(t){var i=e.create("LABEL",{attrs:{id:"checkListItem"+t+"Label",className:"edit"},html:['<span class="mobile-grid-field-tasks-checklist-item">','<span class="mobile-grid-field-tasks-checklist-item-text">&nbsp;</span>','<input type="text" id="checkListItem',t,'Text" value="" placeholder="',e.message("MB_TASKS_TASK_CHECKLIST_PLACEHOLDER"),'"/>',"</span>"].join("")});this.container.appendChild(i);var s=0,a=e.proxy(function(t){if(s>100)return;s++;if(e("checkListItem"+t+"Text")){e.bind(e("checkListItem"+t+"Text"),"blur",e.proxy(function(){if(e("checkListItem"+t+"Text")){var i=e("checkListItem"+t+"Text").value,s=e("checkListItem"+t+"Label");if(e.type.isNotEmptyString(i))this.callback({text:i,extraData:{id:t}},{replaceNode:e("checkListItem"+t+"Label")});else if(s&&s.parentNode)s.parentNode.removeChild(s)}},this));e.bind(e("checkListItem"+t+"Text"),"keyup",e.proxy(function(i){if(i.keyCode==13){var s=e("checkListItem"+t+"Text").value,a=e("checkListItem"+t+"Label");if(e.type.isNotEmptyString(s))setTimeout(e.proxy(this.clickAdd,this),100);else if(a&&a.parentNode)a.parentNode.removeChild(a)}},this));setTimeout(function(){e.focus(e("checkListItem"+t+"Text"))},100)}else{setTimeout(function(){a(t)},100)}},this);a(t)},show:function(t,i){window.app.exec("showPostForm",{attachButton:null,attachedFiles:null,extraData:{id:i},mentionButton:null,smileButton:null,message:{text:e.util.htmlspecialcharsback(t)},okButton:{callback:this.callback,name:e.message("interface_form_save")},cancelButton:{callback:function(){},name:e.message("interface_form_cancel")}})},callback:function(t,i){t.text=e.util.htmlspecialchars(t.text)||"";i=i||{};var s=t.extraData.id,a,n=false,c=i.replaceNode,l=i.separator;if(e("checkListItem"+s)){a=e("checkListItem"+s+"Label");e.removeClass(a,"edit");n=e("checkListItem"+s).checked}else{a=e.create("LABEL",{attrs:{"for":"checkListItem"+s,id:"checkListItem"+s+"Label",className:"task-view-checklist task-view-checklist-toggle task-view-checklist-modify task-view-checklist-remove"}});if(e(c)){c.parentNode.replaceChild(a,c)}else{this.container.appendChild(a)}}a.innerHTML=['<span class="',l?"mobile-grid-field-divider":"mobile-grid-field-tasks-checklist-item",'">','<input type="hidden" name="data[SE_CHECKLIST][',s,'][ID]" value="',s,'" />','<input type="checkbox" name="data[SE_CHECKLIST][',s,'][IS_COMPLETE]" id="checkListItem',s,'"',n?" checked ":"",' value="Y" />',l?"":'<span class="mobile-grid-field-tasks-checklist-item-text">'+t.text+"</span>",'<i class="mobile-grid-menu" id="checkListItem',s,'Menu"></i>','<input type="hidden" name="data[SE_CHECKLIST][',s,'][TITLE]" value="',t.text,'" />','<input type="hidden" name="data[SE_CHECKLIST][',s,'][SORT_INDEX]" value="',t.sort||++this.sort,'" />',"</span>"].join("");var o=0,r=e.proxy(function(t){if(o>100)return;o++;if(e("checkListItem"+t+"Menu")){this.bindItem(t);this.fireEvent(t,"modify",i)}else{setTimeout(function(){r(t)},100)}},this);r(s)},fireEvent:function(t,i,s){e.onCustomEvent(this,"onChange",[this,e("checkListItem"+t),i,s])}};return t}(),a=function(){var t=function(t,i,s){a.superclass.constructor.apply(this,arguments);this.actCallback=e.delegate(this.actCallback,this)};e.extend(t,s);t.prototype.ids={};t.prototype.queue=[];t.prototype.getId=function(e){return this.ids[e]||e};t.prototype.fireEvent=function(t,i,s){this.queue.push([e.proxy(function(){var a=e("checkListItem"+t);if(a&&a.form){if(i=="remove")this.remove(t);else if(i=="toggle")this.toggle(t,a);else{var n={TITLE:a.form.elements["data[SE_CHECKLIST]["+t+"][TITLE]"].value,IS_COMPLETE:a.form.elements["data[SE_CHECKLIST]["+t+"][IS_COMPLETE]"].checked?"Y":"N",SORT_INDEX:a.form.elements["data[SE_CHECKLIST]["+t+"][SORT_INDEX]"].value};if(i=="modify"&&(this.getId(t)+"").indexOf("n")===0)this.create(t,n,s);else this.modify(t,n)}}},this),arguments]);this.startQueue()};t.prototype.getQuery=function(){if(!this.query){this.query=new e.Tasks.Util.Query({url:e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:"checklist",id:this.taskId})})}return this.query};t.prototype.statusQueue="ready";t.prototype.startQueue=function(){if(this.statusQueue==="ready"){this.statusQueue="busy";this.checkQueue()}};t.prototype.checkQueue=function(){var t=this.queue.shift();if(t&&e.type.isFunction(t[0])){t[0].apply(this,t[1])}else{this.statusQueue="ready"}};t.prototype.actCallback=function(t,i){if(t&&t.length>0){for(var s=0;s<t.length;s++)t[s]=t[s]["MESSAGE"]||t[s]["CODE"];window.app.alert({text:t.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}this.checkQueue()};t.prototype.create=function(t,i,s){this.getQuery().add("task.checklist.add",{data:{TASK_ID:this.taskId,TITLE:i.TITLE,IS_COMPLETE:i.IS_COMPLETE,SORT_INDEX:i.SORT_INDEX}},{},e.proxy(function(i,s){if(i&&i.length>0){for(var a=0;a<i.length;a++)i[a]=i[a]["MESSAGE"]||i[a]["CODE"];window.app.alert({text:i.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")});e.remove(e("checkListItem"+t+"Label"))}else{this.ids[t]=s["RESULT"]["DATA"]["ID"]}this.checkQueue()},this)).execute()};t.prototype.modify=function(e,t){var i=this.getId(e);this.getQuery().add("task.checklist.update",{id:i,data:{TITLE:t.TITLE}},{},this.actCallback).execute()};t.prototype.remove=function(e){var t=this.getId(e);this.getQuery().add("task.checklist.delete",{id:t},{},this.actCallback).execute()};t.prototype.toggle=function(e,t){var i=this.getId(e);this.getQuery().add("task.checklist."+(t.checked?"complete":"renew"),{id:i},{},this.actCallback).execute()};return t}(),n=function(){var t=function(t,i){this.node=t;this.container=i;this.click=e.delegate(this.click,this);this.callback=e.delegate(this.callback,this);e.bind(this.container.parentNode,"click",this.click)};t.prototype={multiple:false,select:null,eventNode:null,container:null,showDrop:true,showMenu:false,click:function(t){this.show();return e.PreventDefault(t)},show:function(){window.app.exec("showPostForm",{attachButton:null,attachedFiles:null,extraData:{},mentionButton:null,smileButton:null,message:{text:e.util.htmlspecialcharsback(this.node.value)},okButton:{callback:this.callback,name:e.message("interface_form_save")},cancelButton:{callback:function(){},name:e.message("interface_form_cancel")}})},callback:function(t){t.text=e.util.htmlspecialchars(t.text)||"";if(t.text.length>0){this.container.innerHTML=t.text;this.node.value=t.text}e.onCustomEvent(this,"onChange",[this,this.node])}};return t}(),c=function(){var t=function(t){this.click=e.delegate(this.click,this);this.callback=e.delegate(this.callback,this);this.drop=e.delegate(this.drop,this);this.node=e("parentId"+t);this.container=e("parentId"+t+"Container");e.bind(e("parentId"+t+"Add"),"click",this.click);this.bindItem()};t.prototype={multiple:false,select:null,eventNode:null,container:null,showDrop:true,showMenu:false,click:function(t){this.show();return e.PreventDefault(t)},show:function(){window.BXMobileApp.PageManager.loadPageModal({url:e.message("TASK_PATH_TO_SELECTOR")+"&multiple=false",bx24ModernStyle:true});e.addCustomEvent(window,"onTasksWereSelected",this.callback)},drop:function(){this.container.innerHTML=e.message("MB_TASKS_TASK_PLACEHOLDER");this.node.value=0;e.onCustomEvent(this,"onChange",[this,this.node])},bindItem:function(){var t=e.findChild(this.container,{tagName:"DEL"},true);if(t)e.bind(t,"click",this.drop)},callback:function(){e.removeCustomEvent(window,"onTasksWereSelected",this.callback)}};return t}(),l=function(){var t=function(t){this.click=e.delegate(this.click,this);this.callback=e.delegate(this.callback,this);this.durationType=e("durationType"+t);this.durationTypeLabel=e("durationType"+t+"Label");e.bind(this.durationTypeLabel,"click",this.click)};t.prototype={click:function(t){this.show();return e.PreventDefault(t)},show:function(){BXMobileApp.UI.SelectPicker.show({callback:this.callback,values:[e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_HOURS"),e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")],multiselect:false,default_value:this.durationType.value=="hours"?e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_HOURS"):e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")})},callback:function(t){if(t&&t.values&&t.values.length>0){var i=t.values.pop();if(i==e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")){this.durationType.value="days";this.durationTypeLabel.innerHTML=e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_DAYS")}else{this.durationType.value="hours";this.durationTypeLabel.innerHTML=e.message("MB_TASKS_TASK_SETTINGS_DURATION_PLAN_HOURS")}}}};return t}();e.Mobile.Tasks.edit=function(t,s){this.parentConstruct(e.Mobile.Tasks.edit,t);e.merge(this,{sys:{classCode:"edit"},vars:{id:i()}});e.merge(t,{usePull:false,setTitle:true,setPullDown:false});this.handleInitStack(s,e.Mobile.Tasks.edit,t)};e.extend(e.Mobile.Tasks.edit,e.Mobile.Tasks.page);e.merge(e.Mobile.Tasks.edit.prototype,{init:function(){if(this.option("checkList"))this.elements.push(new s(this.option("taskId"),this.option("checkList")));else if(this.option("checkListView"))new a(this.option("taskId"),this.option("checkListView"));if(e("title"+this.option("taskId")))this.elements.push(new n(e("title"+this.option("taskId")),e("title"+this.option("taskId")+"Container")));this.elements.push(new c(this.option("taskId"),this.option("parentId")));this.elements.push(new l(this.option("taskId")));var t=e.delegate(function(t,i,s){if(t==this.option("formId")&&s){this.restricted=s["restrictedMode"]===true||s["restrictedMode"]=="Y";if(this.restricted){var a=function(){s.apply.apply(arguments)};for(var n=0;n<this.elements.length;n++){e.addCustomEvent(this.elements[n],"onChange",a)}}e.addCustomEvent(s,"onChange",function(i,s){var a=e(t),n=e(t).elements["data[MARK]"];if(e(s)&&s==n){var c=e.findParent(s,{className:"bx-tasks-task-mark"},a);if(s.value=="P"){e.removeClass(c,"bx-tasks-task-mark-N");if(!e.hasClass(c,"bx-tasks-task-mark-P"))e.addClass(c,"bx-tasks-task-mark-P")}else if(s.value=="N"){e.removeClass(c,"bx-tasks-task-mark-P");if(!e.hasClass(c,"bx-tasks-task-mark-N"))e.addClass(c,"bx-tasks-task-mark-N")}else{e.removeClass(c,"bx-tasks-task-mark-P");e.removeClass(c,"bx-tasks-task-mark-N")}}if(s.name=="data[PRIORITY]"){s.nextSibling.innerHTML=e.message("TASKS_PRIORITY_"+(s.checked?"2":"0"))}else if(s.name=="data[ADD_TO_FAVORITE]"){s.nextSibling.innerHTML=s.checked?e.message("TASKS_FAVORITES_1"):e.message("TASKS_FAVORITES_0")}});e.addCustomEvent(s,"onCancel",function(){window.app.closeModalDialog({})});e.addCustomEvent(s,"onSubmitForm",e.proxy(function(t,i,s,a){a.submit=false;if(!this.restricted)BXMobileApp.UI.Page.LoadingScreen.show();var n=e.ajax.prepareForm(i).data,c=n.data,l=this.option("taskId"),o=e.util.add_url_param(e.message("TASK_PATH_TO_AJAX"),{act:"update",id:l}),r,h,d;if(c["SE_AUDITOR"]){d=c["SE_AUDITOR"];c["SE_AUDITOR"]=[];while((r=d.pop())&&r)c["SE_AUDITOR"].push({ID:r})}if(c["SE_ACCOMPLICE"]){d=c["SE_ACCOMPLICE"];c["SE_ACCOMPLICE"]=[];while((r=d.pop())&&r)c["SE_ACCOMPLICE"].push({ID:r})}if(i.elements["ADDITIONAL[]"]){for(r=0;r<i.elements["ADDITIONAL[]"].length;r++){h=i.elements["ADDITIONAL[]"][r];c[h.value]=h.checked?"Y":"N"}}if(this.restricted){delete c["SE_CHECKLIST"]}var u={id:l,userid:e.message("USER_ID"),taskid:l,data:c};new e.Tasks.Util.Query({url:o}).add(l>0?"task.update":"task.add",u,{},{onExecuted:e.proxy(function(t){if(t&&t.response&&t.response.status=="failed"){window.app.BasicAuth({success:e.proxy(function(){new e.Tasks.Util.Query({url:o}).add("task.update",u,{},{onExecuted:this.actExecute}).execute()},this),failure:function(){window.app.alert({text:e.message("MB_TASKS_TASK_ERROR3"),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}})}else this.actExecute.apply(this,arguments)},this)}).execute()},this))}},this);e.addCustomEvent("onInitialized",t);var i=e.Mobile.Grid.Form.getByFormId(this.option("formId"));t(this.option("formId"),"doesNotMatter",i)},actExecute:function(t,i){BXMobileApp.UI.Page.LoadingScreen.hide();if(t.checkHasErrors()){var s=[];for(var a=0;a<t.length;a++){s.push(t[a]["MESSAGE"])}window.app.alert({text:s.join(". "),title:e.message("MB_TASKS_TASK_ERROR_TITLE")})}else{window.app.onCustomEvent(this.option("taskId")>0?"onTaskWasUpdated":"onTaskWasCreated",[this.option("taskId"),this.variable("id"),i["RESULT"]["DATA"],i]);if(!this.restricted){window.app.closeModalDialog({})}}},elements:[],getMenu:function(){return[]}})})();
//# sourceMappingURL=script.map.js