if(typeof BX.CrmLeadEditor==="undefined"){BX.CrmLeadEditor=function(){this._id="";this._settings={};this._prefix="";this._statusId=this._statusName=this._sourceId=this._sourceName=this._currencyId=this._currencyName=null;this._assignedById=this._assignedByName=null;this._addPhoneBtn=this._addEmailBtn=null;this._statusProgressBar=null;this._dispatcher=null;this._isDirty=false;this._contextMenuId="";this._productRowList=null;this._productRowListChangeHandler=BX.delegate(this._onProductRowListChange,this);this._leadStatusChangeCompleteHandler=BX.delegate(this._onExternalLeadStatusChange,this);this._currencyChangeCompleteHandler=BX.delegate(this._onExternalCurrencyChange,this);this._statusChangeCompleteHandler=BX.delegate(this._onExternalStatusChange,this);this._isInStatusChangeMode=false;this._isInLeadStatusChangeMode=false;this._isInCurrencyChangeMode=false;this._syncData={}};BX.CrmLeadEditor.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._prefix=this.getSetting("prefix");this._dispatcher=this.getSetting("dispatcher",null);this._currencyId=this.resolveElement("currency_id");if(this._currencyId){BX.bind(BX.findParent(this._currencyId,{className:"crm_block_container"}),"click",BX.delegate(this._onCurrencySelect,this))}this._currencyName=this.resolveElement("currency_name");this._assignedById=this.resolveElement("assigned_by_id");if(this._assignedById){BX.bind(BX.findParent(this._assignedById,{className:"crm_block_container"}),"click",BX.delegate(this._onResponsibleSelect,this))}this._assignedByName=this.resolveElement("assigned_by_name");this._addPhoneBtn=this.resolveElement("phone_add_btn");if(this._addPhoneBtn){BX.bind(this._addPhoneBtn,"click",BX.delegate(this._onPhoneAdd,this))}this._addEmailBtn=this.resolveElement("email_add_btn");if(this._addEmailBtn){BX.bind(this._addEmailBtn,"click",BX.delegate(this._onEmailAdd,this))}this._sourceId=this.resolveElement("source_id");if(this._sourceId){BX.bind(BX.findParent(this._sourceId,{className:"crm_block_container"}),"click",BX.delegate(this._onSourceSelect,this))}this._sourceName=this.resolveElement("source_name");this._statusId=this.resolveElement("status_id");this._statusName=this.resolveElement("status_name");var i=this.resolveElement("status_container");if(i){BX.bind(BX.findParent(i,{className:"crm_meeting_info"}),"click",BX.delegate(this._onStatusClick,this));var n=this.getEntityId();this._statusProgressBar=BX.CrmProgressBar.create("LEAD_"+n,{entityType:"LEAD",entityId:n,currentStepId:this.getFieldValue("STATUS_ID"),container:i,isEditable:true});BX.addCustomEvent(this._statusProgressBar,"onStepChange",BX.delegate(this._onInternalLeadStatusChange,this));BX.addCustomEvent(this._statusProgressBar,"onStepSelectPageRequest",BX.delegate(this._onLeadStatusPageRequest,this))}BX.addCustomEvent(window,"onCrmEntityUpdate",BX.delegate(this._onExternalUpdate,this));BX.addCustomEvent(window,"onCrmEntityDelete",BX.delegate(this._onExternalDelete,this));BX.addCustomEvent(window,"onOpenPageBefore",BX.delegate(this._onBeforePageOpen,this));BX.addCustomEvent(window,"onOpenPageAfter",BX.delegate(this._onAfterPageOpen,this))},getId:function(){return this._id},getSettings:function(){return this._settings},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},setSetting:function(e,t){this._settings[e]=t},getEntityId:function(){return parseInt(this.getSetting("entityId",0))},prepareElementId:function(e){e=e.toLowerCase();return this._prefix!==""?this._prefix+"_"+e:e},resolveElement:function(e){return BX(this.prepareElementId(e))},getFieldValue:function(e){var t=this.resolveElement(e);return t?t.value:""},createSaveHandler:function(){return BX.delegate(this._onSave,this)},getMessage:function(e){var t=BX.CrmLeadEditor.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},getContextId:function(){return this.getSetting("contextId","")},getCurrencyId:function(){return this.getFieldValue("CURRENCY_ID")},setProductRowList:function(e,t){if(this._productRowList===e){return}t=!!t;if(this._productRowList){BX.removeCustomEvent(this._productRowList,"onCrmProductRowListChange",this._productRowListChangeHandler)}this._productRowList=e;if(this._productRowList){BX.addCustomEvent(this._productRowList,"onCrmProductRowListChange",this._productRowListChangeHandler)}var i=this.resolveElement("opportunity");if(i){if(!this._productRowList){i.disabled=false}else{var n=this._productRowList.getItemCount()>0;i.disabled=n;if(!t){i.value=n?this._productRowList.getSumTotal():0}}}},_onPhoneAdd:function(e){this._createMultiField("PHONE",BX.findPreviousSibling(this._addPhoneBtn,{tagName:"DIV",className:"clb"}));return BX.PreventDefault(e)},_onEmailAdd:function(e){this._createMultiField("EMAIL",BX.findPreviousSibling(this._addEmailBtn,{tagName:"DIV",className:"clb"}));return BX.PreventDefault(e)},_onCurrencySelect:function(e){var t=this.getSetting("currencySelectorUrl","");if(t!==""){BX.CrmMobileContext.getCurrent().open({url:t,data:{contextId:this.getContextId()}});this._enableCurrencyChangeMode(true)}},_onSourceSelect:function(e){var t=this.getSetting("sourceSelectorUrl","");if(t!==""){BX.CrmMobileContext.getCurrent().open({url:t});this._enableStatusChangeMode(true)}},_onResponsibleSelect:function(){BX.CrmMobileContext.getCurrent().openUserSelector({callback:BX.delegate(this._onResponsibleChange,this),multiple:false,okButtonTitle:this.getMessage("userSelectorOkButton"),cancelButtonTitle:this.getMessage("userSelectorCancelButton")})},_onResponsibleChange:function(e){var t=0;var i="";if(e&&e["a_users"]){var n=e["a_users"];for(var s in n){if(!n.hasOwnProperty(s)){continue}var a=n[s];t=parseInt(a["ID"]);i=a["NAME"];break}}if(this._assignedById){this._assignedById.value=t}if(this._assignedByName){this._assignedByName.innerHTML=BX.util.htmlspecialchars(i)}},_createMultiField:function(e,t){var i=0;var n="";var s=e+"_";do{i++;n="n"+i.toString()}while(BX.type.isDomNode(this.resolveElement(s+n+"_VALUE")));var a=this.getSetting("multiFields",{});if(typeof a[e]==="undefined"){a[e]={}}a[e][n]={};var r=BX.create("INPUT",{props:{id:this.prepareElementId(s+n+"_VALUE"),type:"text",className:"crm_input_text fll"},style:{width:"70%"}});t.parentNode.insertBefore(r,t);var o=BX.create("SELECT",{props:{id:this.prepareElementId(s+n+"_VALUE_TYPE"),className:"crm_input_select flr"}});var d=this.getSetting("multiFieldInfos",{});var l=typeof d[e]!=="undefined"?d[e]:{};for(var u in l){if(!l.hasOwnProperty(u)){continue}var h=l[u];var c=BX.create("OPTION",{value:u,text:h});if(!BX.browser.isIE){o.add(c,null)}else{try{o.add(c,o.options[null])}catch(_){o.add(c,null)}}}t.parentNode.insertBefore(o,t)},_saveMultiFields:function(e,t){var i=this.getSetting("multiFields",{});if(typeof i[e]==="undefined"){return}if(typeof t["FM"]==="undefined"){t["FM"]={}}if(typeof t["FM"][e]==="undefined"){t["FM"][e]={}}var n=i[e];for(var s in n){if(!n.hasOwnProperty(s)){continue}var a=e+"_"+s;var r=this.getFieldValue(a+"_value");if(r===""){continue}t["FM"][e][s]={VALUE:r,VALUE_TYPE:this.getFieldValue(a+"_value_type")}}},_onSave:function(){if(!this._dispatcher){return}var e=this.getEntityId();var t={ID:this.getEntityId(),TITLE:this.getFieldValue("TITLE"),NAME:this.getFieldValue("NAME"),SECOND_NAME:this.getFieldValue("SECOND_NAME"),LAST_NAME:this.getFieldValue("LAST_NAME"),HONORIFIC:this.getFieldValue("HONORIFIC"),COMPANY_TITLE:this.getFieldValue("COMPANY_TITLE"),CURRENCY_ID:this.getFieldValue("CURRENCY_ID"),OPPORTUNITY:this.getFieldValue("OPPORTUNITY"),STATUS_ID:this.getFieldValue("STATUS_ID"),ADDRESS:this.getFieldValue("ADDRESS"),ADDRESS_2:this.getFieldValue("ADDRESS_2"),ADDRESS_CITY:this.getFieldValue("ADDRESS_CITY"),ADDRESS_REGION:this.getFieldValue("ADDRESS_REGION"),ADDRESS_PROVINCE:this.getFieldValue("ADDRESS_PROVINCE"),ADDRESS_POSTAL_CODE:this.getFieldValue("ADDRESS_POSTAL_CODE"),ADDRESS_COUNTRY:this.getFieldValue("ADDRESS_COUNTRY"),COMMENTS:this.getFieldValue("COMMENTS"),SOURCE_ID:this.getFieldValue("SOURCE_ID"),ASSIGNED_BY_ID:this.getFieldValue("ASSIGNED_BY_ID")};t["PROCESS_PRODUCT_ROWS"]="Y";t["PRODUCT_ROWS"]=this._productRowList?this._productRowList.prepareForSave():[];this._saveMultiFields("PHONE",t);this._saveMultiFields("EMAIL",t);if(e<=0){this._dispatcher.createEntity(t,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}else{this._dispatcher.updateEntity(t,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}},_enableCurrencyChangeMode:function(e){e=!!e;if(this._isInCurrencyChangeMode===e){return}this._isInCurrencyChangeMode=e;if(e){BX.addCustomEvent(window,"onCrmCurrencySelect",this._currencyChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmCurrencySelect",this._currencyChangeCompleteHandler)}},_enableLeadStatusChangeMode:function(e){e=!!e;if(this._isInLeadStatusChangeMode===e){return}this._isInLeadStatusChangeMode=e;if(e){BX.addCustomEvent(window,"onCrmProgressStepSelect",this._leadStatusChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmProgressStepSelect",this._leadStatusChangeCompleteHandler)}},_enableStatusChangeMode:function(e){e=!!e;if(this._isInStatusChangeMode===e){return}this._isInStatusChangeMode=e;if(e){BX.addCustomEvent(window,"onCrmStatusSelect",this._statusChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmStatusSelect",this._statusChangeCompleteHandler)}},_onStatusClick:function(e){this._onLeadStatusPageRequest();BX.eventCancelBubble(e)},_onLeadStatusPageRequest:function(){var e=this.getSetting("leadStatusSelectorUrl","");if(e!==""){BX.CrmMobileContext.getCurrent().open({url:e,data:{contextId:this.getContextId(),currentStepId:this.getFieldValue("STATUS_ID"),disabledStepIds:["CONVERTED"]}});this._enableLeadStatusChangeMode(true)}},_onInternalLeadStatusChange:function(e){var t=BX.type.isNotEmptyString(e["stepId"])?e["stepId"]:"";var i=BX.type.isNotEmptyString(e["stepName"])?e["stepName"]:"";if(this._statusId){this._statusId.value=t}if(this._statusName){this._statusName.innerHTML=BX.util.htmlspecialchars(i!==""?i:t)}},_onExternalUpdate:function(e){var t=typeof e["typeName"]!=="undefined"?e["typeName"]:"";var i=typeof e["id"]!=="undefined"?parseInt(e["id"]):0;var n=typeof e["senderId"]!=="undefined"?e["senderId"]:"";if(t===BX.CrmLeadModel.typeName&&i===this.getEntityId()&&n!==this._dispatcher.getId()){this._isDirty=true}},_onExternalDelete:function(e){var t=typeof e["typeName"]!=="undefined"?e["typeName"]:"";var i=typeof e["id"]!=="undefined"?parseInt(e["id"]):0;if(t===BX.CrmLeadModel.typeName&&i===this.getEntityId()){BX.CrmMobileContext.getCurrent().close()}},_onExternalLeadStatusChange:function(e){var t=BX.type.isNotEmptyString(e["contextId"])?e["contextId"]:"";if(t!==this.getContextId()){return}this._syncData["STATUS"]={id:BX.type.isNotEmptyString(e["statusId"])?e["statusId"]:"",name:BX.type.isNotEmptyString(e["name"])?e["name"]:""};this._enableLeadStatusChangeMode(false)},_onExternalCurrencyChange:function(e){var t=typeof e["contextId"]?e["contextId"]:"";if(t!==this.getSetting("contextId","")){return}var i=typeof e["id"]?e["id"]:"";var n=typeof e["name"]?e["name"]:"";this._syncData["CURRENCY"]={id:i,name:n};this._enableCurrencyChangeMode(false)},_onExternalStatusChange:function(e){var t=typeof e["contextId"]?e["contextId"]:"";if(t!==this.getSetting("contextId","")){return}var i=typeof e["statusId"]?e["statusId"]:"";var n=typeof e["name"]?e["name"]:"";this._syncData["SOURCE"]={id:i,name:n};this._enableStatusChangeMode(false)},_synchronize:function(){if(!this._syncData){return}if(typeof this._syncData["STATUS"]!=="undefined"){var e=this._syncData["STATUS"];var t=BX.type.isNotEmptyString(e["id"])?e["id"]:"";if(this._statusId){this._statusId.value=t}var i=BX.type.isNotEmptyString(e["name"])?e["name"]:"";if(this._statusName){this._statusName.innerHTML=BX.util.htmlspecialchars(i)}if(this._statusProgressBar){this._statusProgressBar.setCurrentStepId(t,false)}delete this._syncData["STATUS"]}else if(typeof this._syncData["CURRENCY"]!=="undefined"){e=this._syncData["CURRENCY"];t=BX.type.isNotEmptyString(e["id"])?e["id"]:"";var n="";if(this._currencyId){n=this._currencyId.value;this._currencyId.value=t}i=BX.type.isNotEmptyString(e["name"])?e["name"]:"";if(this._currencyName){this._currencyName.innerHTML=BX.util.htmlspecialchars(i!==""?i:t)}if(this._productRowList){this._productRowList.setCurrencyId(t,BX.delegate(this._synchronizeOpportunity,this))}else{this._convertOpportunity(n,t)}delete this._syncData["CURRENCY"]}else if(typeof this._syncData["SOURCE"]!=="undefined"){var e=this._syncData["SOURCE"];var t=BX.type.isNotEmptyString(e["id"])?e["id"]:"";if(this._sourceId){this._sourceId.value=t}var i=BX.type.isNotEmptyString(e["name"])?e["name"]:"";if(this._sourceName){this._sourceName.innerHTML=BX.util.htmlspecialchars(i!==""?i:t)}delete this._syncData["SOURCE"]}},_convertOpportunity:function(e,t){var i=parseFloat(this.getFieldValue("OPPORTUNITY"));if(i==0){return}var n=this;BX.ajax({url:this.getSetting("serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"CONVERT_MONEY",SRC_CURRENCY_ID:e,DST_CURRENCY_ID:t,SUM:i},onsuccess:function(e){var t=n.resolveElement("opportunity");if(t){t.value=typeof e["SUM"]!=="undefined"?e["SUM"]:0}if(n._currencyId){n._currencyId.value=typeof e["CURRENCY_ID"]!=="undefined"?e["CURRENCY_ID"]:""}if(n._currencyName){n._currencyName.innerHTML=BX.util.htmlspecialchars(typeof e["CURRENCY_NAME"]!=="undefined"?e["CURRENCY_NAME"]:"")}},onfailure:function(e){}})},_synchronizeOpportunity:function(){var e=this.resolveElement("opportunity");if(!e){return}var t=this._productRowList;if(!t){e.disabled=false}else{var i=t.getItemCount()>0;e.disabled=i;e.value=i?t.getSumTotal():0}},_onBeforePageOpen:function(){if(this._isDirty){this._isDirty=false;BX.CrmMobileContext.getCurrent().reload()}},_onAfterPageOpen:function(){if(this._productRowList&&this._productRowList.isInEditMode()){this._productRowList.cancelEditMode()}this._synchronize()},_onProductRowListChange:function(e){this._synchronizeOpportunity()}};if(typeof BX.CrmLeadEditor.messages==="undefined"){BX.CrmLeadEditor.messages={}}BX.CrmLeadEditor.items={};BX.CrmLeadEditor.create=function(e,t){var i=new BX.CrmLeadEditor;i.initialize(e,t);this.items[e]=i;return i}}
//# sourceMappingURL=script.map.js