BX.namespace("Tasks.Component");BX.Tasks.Component.Task=BX.Tasks.Util.Widget.extend({options:{removeTemplates:false,data:{}},constants:{PRIORITY_AVERAGE:1,PRIORITY_HIGH:2},sys:{code:"task-edit"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.instances.calendar=false;this.instances.query=false;this.instances.helpWindow=false;this.fireTaskEvent();if(this.option("doInit")){this.bindEvents();this.disableHints();this.initCheckList();this.initResponsible();this.initOriginator();this.initAuditor();this.initAccomplice();this.initTag();this.initParentTask();this.initRelatedTask();this.initProject();this.initReminder();this.initReplication();this.initProjectDependence();this.initProjectPlan();this.initEstimateTime();this.initState();this.replaceCmdBtn();if(!this.getUser().IS_SUPER_USER){this.restrictMemberSelectors()}}},getUser:function(){return this.option("auxData").USER},restrictMemberSelectors:function(){var t=this.instances["responsible"];var e=this.instances["originator"];var i=this.getTaskActions().EDIT||this.getTaskActions()["EDIT.ORIGINATOR"];if(e){if(!i){e.readonly(true)}else{if(!this.isEditMode()||this.getUser().ROLES.ORIGINATOR){e.bindEvent("change",BX.delegate(this.restrictOriginator,this));this.restrictOriginator()}if(t){t.bindEvent("change",BX.delegate(function(t){this.restrictMultipleResponsibles(t.length>1)},this));this.restrictMultipleResponsibles(t.value().length>1)}}}},restrictOriginator:function(){var t=this.instances["responsible"];var e=this.instances["originator"];var i=this.getUser().DATA;var s=e.value();var n=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){n=s[0]}s=t.value();var a=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){a=s[0]}if(n){if(n!=i.ID){if(a!=i.ID){t.replaceItem(a,i)}t.readonly(true)}else{t.readonly(false)}}},restrictMultipleResponsibles:function(t){var e=this.instances["originator"];if(e){if(t){var i=this.getUser().DATA;var s=e.value();var n=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){n=s[0]}if(n&&n!=i.ID){e.replaceItem(n,i);if(BX.hasClass(this.control("originator"),"invisible")){this.toggleBlock("originator")}}e.readonly(true)}else{e.readonly(false)}}},disableHints:function(){BX.Tasks.Util.hintManager.disableSeveral(this.option("auxData").HINT_STATE)},fireTaskEvent:function(){var t=this.option("componentData").EVENT_TYPE.toString().toUpperCase();var e=this.option("data").EVENT_TASK;var i=this.option("data").EVENT_TASK_UGLY;if(t&&(e||i)){BX.Tasks.Util.fireGlobalTaskEvent(t,e,this.option("componentData").EVENT_OPTIONS,i)}},replaceCmdBtn:function(){if(BX.browser.IsMac()){var t=this.control("cmd");if(t){t.innerHTML="&#8984;"}}},bindEditorEvents:function(t,e){BX.addCustomEvent(t,"OnIframeKeyup",e);BX.addCustomEvent(t,"OnTextareaKeyup",e)},setFocusOnTitle:function(t){setTimeout(BX.delegate(function(){t.Focus(false);this.control("title").focus();BX.focus()},this),500)},isEditMode:function(){return this.option("template").EDIT_MODE},bindEvents:function(){if(!this.isEditMode()){BX.ready(BX.delegate(function(){var t=BX.delegate(this.onFormKeyDown,this);BX.bind(document,"keydown",t);var e=this.option("template").ID;var i=BXHtmlEditor.Get(e);if(i){this.bindEditorEvents(i,t);this.setFocusOnTitle(i,t)}else{BX.addCustomEvent(window,"OnEditorInitedAfter",BX.delegate(function(s){if(s!=null&&s.id==e){this.bindEditorEvents(s,t);this.setFocusOnTitle(i,t)}},this))}},this))}BX.addCustomEvent(document,"main-post-form-tasks-cl-toggle",BX.delegate(this.onToggleCheckListBlock,this));this.bindDelegateControl("toggler","click",this.passCtx(this.onToggleBlock));this.bindDelegateControl("flag","click",this.passCtx(this.onToggleFlag));this.bindDelegateControl("chooser","click",this.passCtx(this.onChooseBlock));this.bindDelegateControl("additional-header","click",this.passCtx(this.onToggleAdditionalBlock));this.bindDelegateControl("priority-cb","change",this.passCtx(this.onPriorityChange));this.bindDelegateControl("flag-replication","change",this.passCtx(this.onReplicationToggle));this.bindDelegateControl("flag-timeman","change",this.passCtx(this.onAllowTimeTrackingChange));this.bindDelegateControl("pin-footer","click",BX.delegate(this.onPinFooterClick,this));this.bindControl("cancel-button","click",BX.delegate(this.onCancelButtonClick,this));this.bindControl("flag-worktime","change",this.passCtx(this.onWorktimeChange));this.bindControl("form","submit",BX.delegate(this.onForumSubmit,this));BX.Tasks.Util.hintManager.bindHelp(this.control("options"))},getTaskData:function(){return this.option("data").TASK},getTaskActions:function(){return this.getTaskData().ACTION},initReplication:function(){},initProjectDependence:function(){var t=BX.Tasks.Util.Dispatcher.get("projectdependence-"+this.id());t.assignCalendar(this.getCalendar());t.option("task",{data:this.getTaskData()});t.load(this.getTaskData().SE_PROJECTDEPENDENCE,this.getTaskActions().SE_PROJECTDEPENDENCE)},initEstimateTime:function(){var t=this.controlAll("estimate-time");for(var e=0;e<t.length;e++){BX.Tasks.Util.bindInstantChange(t[e],BX.delegate(this.onEstimateTimeChange,this))}var i=this.getTaskData();if(typeof i.TIME_ESTIMATE!="undefined"){var s=parseInt(i.TIME_ESTIMATE);if(!isNaN(s)&&s>0){var n=Math.floor(s/3600);if(n>0){s-=n*3600;var a=this.control("estimate-time-hour");if(BX.type.isElementNode(a)){a.value=n}}var o=this.control("estimate-time-minute");if(BX.type.isElementNode(o)){o.value=Math.floor(s/60)}}}},initProjectPlan:function(){this.instances.projectPlan=new BX.Tasks.Shared.Form.ProjectPlan({scope:this.control("date-plan-manager"),parent:this,matchWorkTime:this.getTaskData().MATCH_WORK_TIME=="Y"});this.instances.projectPlan.bindEvent("change-deadline",BX.delegate(function(t){BX.Tasks.Util.Dispatcher.fireEvent("reminder-"+this.id(),"setTaskDeadLine",[t])},this))},initProject:function(){var t="project";var e=new BX.Tasks.Component.Task.GroupItemSet({id:t+"-"+this.id(),min:0,max:1,parent:this,itemFx:"horizontal",itemFxHoverDelete:true});e.bindEvent("change",BX.delegate(function(t){this.control("project-input").value=t.length>0?parseInt(t[0]):""},this));if(this.getTaskData().SE_PROJECT){e.load([this.getTaskData().SE_PROJECT])}this.instances[t]=e},initResponsible:function(){var t="responsible";var e={id:t+"-"+this.id(),nameTemplate:this.option("template").NAME_TEMPLATE,min:1,parent:this,itemFx:"horizontal",itemFxHoverDelete:true,useAdd:this.option("componentData").MODULES.mail};if(this.opts.template.EDIT_MODE){e.max=1}var i=new BX.Tasks.Component.Task.UserItemSet(e);i.bindEvent("change",BX.delegate(this.onResponsibleChange,this));this.instances[t]=i;i.load(this.getTaskData().SE_RESPONSIBLE)},initOriginator:function(){var t="originator";var e=new BX.Tasks.Component.Task.UserItemSet({id:t+"-"+this.id(),nameTemplate:this.option("template").NAME_TEMPLATE,min:1,max:1,parent:this,itemFx:"horizontal",itemFxHoverDelete:true});e.bindEvent("change",BX.delegate(this.onOriginatorChange,this));e.load([this.getTaskData().SE_ORIGINATOR]);this.instances[t]=e},initAccomplice:function(){this.instances["accomplice"]=new BX.Tasks.UserItemSet({id:"accomplice-"+this.id(),nameTemplate:this.option("template").NAME_TEMPLATE,selectorCode:"accomplice",parent:this,itemFx:"horizontal",itemFxHoverDelete:true,useAdd:this.option("componentData").MODULES.mail});this.instances["accomplice"].load(this.getTaskData().SE_ACCOMPLICE)},initAuditor:function(){this.instances["auditor"]=new BX.Tasks.UserItemSet({id:"auditor-"+this.id(),nameTemplate:this.option("template").NAME_TEMPLATE,parent:this,itemFx:"horizontal",itemFxHoverDelete:true,useAdd:this.option("componentData").MODULES.mail});this.instances["auditor"].load(this.getTaskData().SE_AUDITOR)},initTag:function(){this.instances["tag"]=new BX.Tasks.Component.Task.TagItemSet({id:"tag-"+this.id(),tagPreId:"tag-pre-"+this.id(),itemFx:"horizontal",itemFxHoverDelete:true});this.instances["tag"].parent(this);this.instances["tag"].load(this.getTaskData().SE_TAG)},initParentTask:function(){var t="parenttask";var e=new BX.Tasks.Component.Task.TaskItemSet({id:t+"-"+this.id(),max:1,selectorCode:t,itemFx:"horizontal",itemFxHoverDelete:true,parent:this});e.bindEvent("change",BX.delegate(function(t){this.control("parent-input").value=t.length>0?parseInt(t[0]):""},this));if(this.getTaskData().SE_PARENTTASK){e.load([this.getTaskData().SE_PARENTTASK])}this.instances[t]=e},initRelatedTask:function(){this.instances["dependson"]=new BX.Tasks.Component.Task.TaskItemSet({id:"dependson-"+this.id(),selectorCode:"dependson",itemFx:"horizontal",itemFxHoverDelete:true,parent:this});if(typeof this.getTaskData().SE_RELATEDTASK!="undefined"){this.instances["dependson"].load(this.getTaskData().SE_RELATEDTASK)}},getCheckList:function(){return BX.Tasks.Util.Dispatcher.get("checklist-"+this.id())},initCheckList:function(){var t=this.getCheckList();if(t!==null){t.load(this.getTaskData().SE_CHECKLIST)}},initReminder:function(){var t=BX.Tasks.Util.Dispatcher.get("reminder-"+this.id());if(t!==null){t.load(this.getTaskData().SE_REMINDER,this.getTaskActions().SE_REMINDER);t.setTaskId(this.getTaskData().ID);t.setTaskDeadLine(this.getTaskData().DEADLINE)}},initState:function(){this.vars.state=BX.clone(this.option("state"));this.redrawState()},onAllowTimeTrackingChange:function(t){BX.Tasks.Util.fadeToggleByClass(this.control("timeman-estimate-time"),200)},onPinFooterClick:function(){var t=!this.vars.state.FLAGS.FORM_FOOTER_PIN;var e=this.control("footer");if(e){BX[t?"addClass":"removeClass"](e,"pinned")}this.setState("FLAGS","FORM_FOOTER_PIN",false,t)},onReplicationToggle:function(t){if(t.checked){this.changeCSSFlag("mode-replication-off",!t.checked,this.control("replication-block"));BX.Tasks.Util.fadeSlideToggleByClass(this.control("replication-panel"))}else{BX.Tasks.Util.fadeSlideToggleByClass(this.control("replication-panel"),300,BX.proxy(function(){this.changeCSSFlag("mode-replication-off",!t.checked,this.control("replication-block"))},this))}},onEstimateTimeChange:function(){var t=this.control("estimate-time-hour");var e=this.control("estimate-time-minute");var i=this.control("estimate-time-second");if(!BX.type.isElementNode(i)){return}var s=0;if(BX.type.isElementNode(t)){var n=parseInt(t.value);if(!isNaN(n)){s=n}}var a=0;if(BX.type.isElementNode(e)){var n=parseInt(e.value);if(!isNaN(n)){a=n}}i.value=a*60+s*3600},onPriorityChange:function(t){var e=this.control("priority");if(BX.type.isElementNode(e)){e.value=t.checked?this.PRIORITY_HIGH:this.PRIORITY_AVERAGE}},onForumSubmit:function(){var t=this.control("csrf");if(t){t.value=BX.bitrix_sessid()}},onFormKeyDown:function(t){t=t||window.event;var e=false;if(BX.Tasks.Util.isEnter(t)){if(t.ctrlKey||t.metaKey){this.control("form").submit();e=true}}if(e){BX.PreventDefault(t)}},onChooseBlock:function(t){var e=this.control("chosen-blocks");var i=this.control("unchosen-blocks");if(!BX.type.isElementNode(e)||!BX.type.isElementNode(i)){return}var s=BX.data(t,"target");if(typeof s!="undefined"&&BX.type.isNotEmptyString(s)){var t=this.control(s);var n=BX.data(t,"block-name");if(BX.type.isNotEmptyString(n)&&BX.type.isElementNode(t)){var a=this.vars.state["BLOCKS"][n];if(typeof a.C!="undefined"){var o=!a.C;var r=this.control(s+"-place",o?e:i);var l=this.control(s+"-place",o?i:e);if(r){BX.Tasks.Util.fadeSlideToggleByClass(l,200,function(){BX.addClass(r,"invisible");BX.append(t,r);BX.Tasks.Util.fadeSlideToggleByClass(r,200);BX.removeClass(l,"invisible")})}else{BX.toggleClass(t,"pinned")}this.setState("BLOCKS",n,"C",!a.C)}}}},onToggleAdditionalBlock:function(t){var e=BX.hasClass(t,"opened");BX.toggleClass(t,"opened");this.toggleBlock("unchosen-blocks")},onToggleBlock:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var i=this.toggleBlock(e);if(i&&e=="checklist"){var s=this.getCheckList();if(s){if(!s.count()){s.newItemOpenForm()}}}}},toggleBlock:function(t,e){return BX.Tasks.Util.fadeSlideToggleByClass(this.control(t),e||100)},onToggleFlag:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var i=this.control(e);var s=BX.data(t,"flag-name");if(BX.type.isElementNode(i)){i.value=t.checked?"Y":"N"}this.setState("FLAGS",s,false,t.checked)}},onOriginatorChange:function(t){if(!t.length){return}var e=this.getUser().DATA.ID.toString()==t[0].toString();BX.Tasks.Util[e?"enable":"disable"](this.control("option-add2timeman"));var i=this.control("option-add2timeman-label");if(i){i[e?"removeAttribute":"setAttribute"]("title",BX.message("TASKS_TASK_COMPONENT_TEMPLATE_NO_ADD2TIMEMAN"))}},onResponsibleChange:function(t){var e=this.instances["responsible"];var i=e.getItemFirst();var s=this.control("real-responsible");if(BX.type.isElementNode(s)&&i!=null){s.value=i.value()}if(t.length>1){BX.Tasks.Util.hintManager.show(this.instances["responsible"].scope(),BX.message("TASKS_TASK_COMPONENT_TEMPLATE_MULTIPLE_RESPONSIBLE_NOTICE"),false,"TASK_EDIT_MULTIPLE_RESPONSIBLES",{closeLabel:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_CLOSE_N_DONT_SHOW")})}else{BX.Tasks.Util.hintManager.hide("TASK_EDIT_MULTIPLE_RESPONSIBLES")}},onCancelButtonClick:function(t){if(this.option("cancelActionIsEvent")){BX.Tasks.Util.fireGlobalTaskEvent("NOOP",{},{STAY_AT_PAGE:false});BX.PreventDefault(t)}},onWorktimeChange:function(t){this.instances.projectPlan.setMatchWorkTime(t.checked)},getCalendar:function(){if(this.instances.calendar==false){this.instances.calendar=new BX.Tasks.Calendar(BX.Tasks.Calendar.adaptSettings(this.option("auxData").COMPANY_WORKTIME))}return this.instances.calendar},getState:function(t,e,i){if(t=="BLOCKS"){return this.vars.state[t][e][i]}if(t=="FLAGS"){return this.vars.state[t][e]}},setState:function(t,e,i,s){if(!BX.type.isNotEmptyString(e)){return}if(typeof this.vars.state[t]=="undefined"){this.vars.state[t]={}}if(typeof this.vars.state[t][e]=="undefined"){this.vars.state[t][e]={}}if(t=="BLOCKS"){this.vars.state[t][e][i]=s}if(t=="FLAGS"){this.vars.state[t][e]=s}this.submitState();this.redrawState()},submitState:function(){if(!this.instances.query){this.instances.query=new BX.Tasks.Util.Query({url:this.option("template").COMPONENTURL,autoExec:true,autoExecDelay:1500})}var t=BX.clone(this.vars.state);var e=t.FLAGS.FORM_FOOTER_PIN;delete t.FLAGS;t.FLAGS={FORM_FOOTER_PIN:e};this.instances.query.add("this.setstate",{state:t})},redrawState:function(){var t=this.control("state");if(BX.type.isElementNode(t)){var e="";if(typeof this.vars.state["BLOCKS"]!="undefined"){for(var i in this.vars.state["BLOCKS"]){var s=this.vars.state["BLOCKS"][i]["O"];var n=this.vars.state["BLOCKS"][i]["C"];if(typeof s!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:i,TYPE:"O",VALUE:s===true||s==="true"?"1":"0"})}if(typeof n!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:i,TYPE:"C",VALUE:n===true||n==="true"?"1":"0"})}}}if(typeof this.vars.state["FLAGS"]!="undefined"){for(var a in this.vars.state["FLAGS"]){var o=this.vars.state["FLAGS"][a];e+=this.getHTMLByTemplate("state-flag",{NAME:a,VALUE:o===true||o==="true"?"1":"0"})}}t.innerHTML=e}}}});BX.Tasks.Component.Task.UserItemSet=BX.Tasks.UserItemSet.extend({methods:{onSearchBlurred:function(){if(this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")){this.restoreKept()}},restoreKept:function(){if(this.vars.toDelete){this.addItem(this.vars.toDelete,{checkRestrictions:false});this.vars.toDelete=false}},onSelectorItemSelected:function(t){var e=this.extractItemValue(t);if(!this.hasItem(e)){var i=this.option("max");this.addItem(t);this.vars.toDelete=false;if(i==1){this.instances.selector.close();this.onSearchBlurred()}}this.resetInput()},openAddForm:function(t,e,i){var s=this.option("min");var n=this.option("max");if(i||n==1&&(s==0||s==1)){var a=this.getItemFirst();if(a){this.vars.toDelete=a.data();this.callMethod(BX.Tasks.UserItemSet,"deleteItem",[a.value(),{checkRestrictions:false}])}}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},deleteItem:function(t){if(!this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.openAddForm(false,false,true);return false}return true}}});BX.Tasks.Component.Task.GroupItemSet=BX.Tasks.Component.Task.UserItemSet.extend({sys:{code:"group-item-set"},methods:{extractItemDisplay:function(t){return t.NAME||BX.util.htmlspecialcharsback(t.nameFormatted)},getNSMode:function(){return"group"}}});BX.Tasks.Component.Task.TaskItemSet=BX.Tasks.PopupItemSet.extend({sys:{code:"task-item-set"},options:{itemFx:"horizontal"},methods:{construct:function(){this.callConstruct(BX.Tasks.PopupItemSet);this.instances.selector=window["O_"+this.option("selectorCode")]},extractItemDisplay:function(t){if(typeof t.DISPLAY!="undefined"){return t.DISPLAY}if(typeof t.name!="undefined"){return t.name}return t.TITLE},extractItemValue:function(t){return typeof t.ID=="undefined"?t.id:t.ID},bindFormEvents:function(){if(typeof this.instances.selector!="undefined"&&this.instances.selector!=null&&this.instances.selector!=false){BX.addCustomEvent(this.instances.selector,"on-change",BX.delegate(this.itemsChanged,this));if(typeof this.instances.window!="undefined"){var t=this.instances.selector;BX.addCustomEvent(this.instances.window,"onAfterPopupShow",function(){setTimeout(function(){t.searchInput.focus()},100)})}}},deleteItem:function(t,e){var i=BX.type.isNumber(t)||BX.type.isString(t)?t:t.value();if(this.callMethod(BX.Tasks.PopupItemSet,"deleteItem",arguments)){this.instances.selector.unselect(i)}}}});BX.Tasks.Component.Task.TagItemSet=BX.Tasks.Util.ItemSet.extend({sys:{code:"tag-item-set"},options:{itemFx:"horizontal"},methods:{bindEvents:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindEvents");BX.addCustomEvent(window,"onTaskTagSelectAlt",BX.delegate(this.onTagsChange,this))},onTagsChange:function(t){for(var e=0;e<t.length;e++){var i={NAME:t[e]};this.addItem(i)}this.each(function(e){if(!BX.util.in_array(e.display(),t)){this.deleteItem(e.value())}})},openAddForm:function(t){if(!window.tasksTagsPopUp){BX.debug("tasksTagsPopUp is not defined");return}window.tasksTagsPopUp.popupWindow.setBindElement(t);window.tasksTagsPopUp.showPopup()},extractItemDisplay:function(t){return t.NAME},extractItemValue:function(t){return BX.util.hashCode(t.NAME)}}});
//# sourceMappingURL=logic.map.js